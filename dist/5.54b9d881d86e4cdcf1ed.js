"use strict";(self.webpackChunkbabylonjs_ocean_demo=self.webpackChunkbabylonjs_ocean_demo||[]).push([[5,292,955,827,817,565,811,183,113],{4292:(e,t,a)=>{a.r(t),a.d(t,{Buoyancy:()=>s});var i=a(6925);class s{constructor(e,t=5,a=1){this.enabled=!0,this._size=e,this._displacementMap=null,this._lengthScale=0,this._numSteps=t,this._attenuation=a,this._meshes=[]}setWaterHeightMap(e,t){this._displacementMap=e,this._lengthScale=t}addMesh(e,t,a=0,s=0){this._meshes.push({mesh:e,frame:t,yOffset:a,spaceCoordinates:s,initQuaternion:e.rotationQuaternion.clone(),curStep:0,curQuaternion:new i.Quaternion,stepQuaternion:new i.Quaternion})}set size(e){this._size=e}get attenuation(){return this._attenuation}set attenuation(e){this._attenuation=e}get numSteps(){return this._numSteps}set numSteps(e){this._numSteps=e}update(){if(this.enabled)for(let e=0;e<this._meshes.length;++e)this._updateMesh(this._meshes[e])}getWaterHeight(e){const t=i.TmpVectors.Vector3[0];return this._getWaterDisplacement(e,t),e.subtractToRef(t,t),this._getWaterDisplacement(e,t),e.subtractToRef(t,t),this._getWaterDisplacement(e,t),e.subtractToRef(t,t),this._getWaterDisplacement(e,t),t.y}_updateMesh(e){const t=i.TmpVectors.Vector3[5],a=i.TmpVectors.Vector3[6],s=i.TmpVectors.Vector3[7],r=i.TmpVectors.Vector3[8],n=i.TmpVectors.Vector3[9],o=i.TmpVectors.Vector3[10],l=i.TmpVectors.Vector3[11],h=i.TmpVectors.Vector3[12],{mesh:_,frame:d,yOffset:c,spaceCoordinates:u,initQuaternion:m,curQuaternion:p,stepQuaternion:g,curStep:y}=e;i.Vector3.TransformCoordinatesToRef(d.v1,_.getWorldMatrix(),t);const v=this.getWaterHeight(t);if(_.position.y=v+c,d.v2&&d.v3){if(y<this._numSteps)return e.curStep++,p.multiplyToRef(g,p),void m.multiplyToRef(p,_.rotationQuaternion);i.Vector3.TransformCoordinatesToRef(d.v2,_.getWorldMatrix(),a),a.subtractToRef(t,l),l.normalize(),i.Vector3.TransformCoordinatesToRef(d.v3,_.getWorldMatrix(),s),s.subtractToRef(t,h),h.normalize(),t.y=v,r.copyFrom(a),r.y=this.getWaterHeight(a),r.subtractToRef(t,r),r.normalize(),n.copyFrom(s),n.y=this.getWaterHeight(s),n.subtractToRef(t,n),n.normalize(),i.Vector3.CrossToRef(n,r,o),i.Vector3.CrossToRef(r,o,n),n.normalize();let c=Math.acos(i.Scalar.Clamp(i.Vector3.Dot(l,r),0,1))*this._attenuation,S=Math.acos(i.Scalar.Clamp(i.Vector3.Dot(h,n),0,1))*this._attenuation;switch(u){case 0:r.y>l.y&&(c=-c),n.y>h.y&&(S=-S),i.Quaternion.FromEulerAnglesToRef(c/this._numSteps,S/this._numSteps,0,e.stepQuaternion);break;case 1:r.y>l.y&&(c=-c),n.y<h.y&&(S=-S),i.Quaternion.FromEulerAnglesToRef(c/this._numSteps,0,S/this._numSteps,e.stepQuaternion);break;case 2:r.y>l.y&&(c=-c),n.y>h.y&&(S=-S),i.Quaternion.FromEulerAnglesToRef(c/this._numSteps,0,S/this._numSteps,e.stepQuaternion)}e.curStep=0}}_getWaterDisplacement(e,t){if(!this._displacementMap)return void t.set(e.x,e.y,e.z);const a=this._size-1,s=e.x/this._lengthScale*this._size,r=e.z/this._lengthScale*this._size,n=i.TmpVectors.Vector3[1],o=i.TmpVectors.Vector3[2],l=i.TmpVectors.Vector3[3],h=i.TmpVectors.Vector3[4];let _=Math.floor(s),d=Math.floor(r);const c=s-_,u=r-d;_&=a,d&=a,this._getDisplacement(_,d,n),this._getDisplacement(_+1&a,d,o),o.subtractToRef(n,l).scaleToRef(c,l).addToRef(n,l),this._getDisplacement(_,d+1&a,n),this._getDisplacement(_+1&a,d+1&a,o),o.subtractToRef(n,h).scaleToRef(c,h).addToRef(n,h),h.subtractToRef(l,t).scaleToRef(u,t).addToRef(l,t)}_getDisplacement(e,t,a){this._displacementMap&&(a.x=i.TextureTools.FromHalfFloat(this._displacementMap[t*this._size*4+4*e+0]),a.y=i.TextureTools.FromHalfFloat(this._displacementMap[t*this._size*4+4*e+1]),a.z=i.TextureTools.FromHalfFloat(this._displacementMap[t*this._size*4+4*e+2]))}}},1005:(e,t,a)=>{a.r(t),a.d(t,{Ocean:()=>p,default:()=>g});var i=a(6925),s=a(511);a(9745);const r=a.p+"cb69d722ba0e1aed94b8f0e32058b799.exr",n=a.p+"643a55451fd81c682e86ba94241de29e.glb";a.p,a.p;var o=a(4292),l=a(3955),h=a(827),_=a(1817),d=a(6565),c=a(5811),u=a(6853),m=a(6113);class p{constructor(){this._engine=null,this._scene=null,this._camera=null,this._rttDebug=null,this._light=null,this._depthRenderer=null,this._buoyancy=null,this._fxaa=null,this._gui=null,this._skybox=null,this._oceanMaterial=null,this._oceanGeometry=null,this._wavesGenerator=null,this._useZQSD=!1,this._useProceduralSky=!0,this._lightDirection=new i.Vector3(0,-1,-.25),this._shadowGenerator=null,this._lightBuoy=null,this._shadowGeneratorBuoy=null,this._glowLayer=null,this._forceUpdateGlowIntensity=!0,this._size=0,this._wavesSettings=new m.WavesSettings}async createScene(e,t){window.convf=function(e){const t=new Uint8Array([255&e,(65280&e)>>8,(16711680&e)>>16,(4278190080&e)>>24]);return new Float32Array(t.buffer)[0]},window.numbg=function(){console.log("NumBindGroupsCreatedTotal=",i.WebGPUCacheBindGroups.NumBindGroupsCreatedTotal," - NumBindGroupsCreatedLastFrame=",i.WebGPUCacheBindGroups.NumBindGroupsCreatedLastFrame)};const a=new i.Scene(e);if(a.useRightHandedSystem=!0,this._engine=e,this._scene=a,this._camera=new i.FreeCamera("mainCamera",new i.Vector3(-17.3,5,-9),a),this._camera.rotation.set(.21402315044176745,1.5974857677541419,0),this._camera.minZ=1,this._camera.maxZ=1e5,!this._checkSupport())return a;this._setCameraKeys(),this._rttDebug=new c.RTTDebug(a,e,32),this._rttDebug.show(!1),a.environmentIntensity=1,a.activeCameras=[this._camera,this._rttDebug.camera],this._camera.attachControl(t,!0);const s=this._camera.update.bind(this._camera);return this._camera.update=function(){s(),this.position.y<1.5&&(this.position.y=1.5)},this._depthRenderer=this._scene.enableDepthRenderer(this._camera,!1),this._depthRenderer.getDepthMap().renderList=[],this._light=new i.DirectionalLight("light",this._lightDirection,a),this._light.intensity=1,this._light.diffuse=new i.Color3(1,1,1),this._light.shadowMinZ=0,this._light.shadowMaxZ=40,this._light.shadowOrthoScale=.5,this._shadowGenerator=new i.ShadowGenerator(4096,this._light),this._shadowGenerator.usePercentageCloserFiltering=!0,this._shadowGenerator.bias=.005,this._skybox=new d.SkyBox(this._useProceduralSky,a),this._buoyancy=new o.Buoyancy(this._size,3,.2),this._oceanMaterial=new _.OceanMaterial(this._depthRenderer,this._scene),this._oceanGeometry=new l.OceanGeometry(this._oceanMaterial,this._camera,this._scene),this._fxaa=new i.FxaaPostProcess("fxaa",1,this._camera),await this._loadMeshes(),await this._updateSize(256),this._oceanGeometry.initializeMeshes(),this._gui=new h.OceanGUI(this._useProceduralSky,a,e,this._parameterRead.bind(this),this._parameterChanged.bind(this)),-1!==location.href.indexOf("hidegui")&&(this._gui.visible=!1),this._scene.onKeyboardObservable.add((e=>{switch(e.type){case i.KeyboardEventTypes.KEYDOWN:"Shift"===e.event.key&&(this._camera.speed=10);break;case i.KeyboardEventTypes.KEYUP:"Shift"===e.event.key&&(this._camera.speed=2)}})),a.onBeforeRenderObservable.add((()=>{if(this._skybox.update(this._light)||this._forceUpdateGlowIntensity){if(this._glowLayer){const e=.6,t=3,a=this._light.position.clone().normalize(),s=a.clone().normalize();s.y=0;const r=i.Vector3.Dot(a,s),n=i.Scalar.Lerp(e,t,i.Scalar.Clamp(r,0,1));this._glowLayer.intensity=a.y<0?t:n,this._forceUpdateGlowIntensity=!1}this._light.position=this._light.position.clone().normalize().scaleInPlace(30)}this._oceanGeometry.update(),this._wavesGenerator.update(),this._buoyancy.setWaterHeightMap(this._wavesGenerator.waterHeightMap,this._wavesGenerator.waterHeightMapScale),this._buoyancy.update()})),new Promise((e=>{a.executeWhenReady((()=>e(a)))}))}_setCameraKeys(){const e=this._camera.inputs.attached.keyboard;this._useZQSD?(e.keysDown=[40,83],e.keysLeft=[37,81],e.keysRight=[39,68],e.keysUp=[38,90]):(e.keysDown=[40,83],e.keysLeft=[37,65],e.keysRight=[39,68],e.keysUp=[38,87]),e.keysDownward=[34,32],e.keysUpward=[33,69]}_checkSupport(){if(this._engine.getCaps().supportComputeShaders)return!0;const e=s.in.CreateFullscreenUI("UI"),t=new s.al;return t.text="**Use WebGPU to watch this demo which requires compute shaders support. To enable WebGPU please use Chrome Canary or Edge canary. Also select the WebGPU engine from the top right drop down menu.**",t.width="100%",t.paddingLeft="5px",t.paddingRight="5px",t.textHorizontalAlignment=s.oT.HORIZONTAL_ALIGNMENT_CENTER,t.textVerticalAlignment=s.oT.VERTICAL_ALIGNMENT_CENTER,t.color="red",t.fontSize="24px",t.fontStyle="bold",t.textWrapping=!0,e.addControl(t),!1}async _loadMeshes(){{await i.SceneLoader.AppendAsync("",n,this._scene,void 0,".glb");const e=[this._scene.getMeshByName("buoyMesh_low")],t=e[0].parent,a=14;t.position.z=-8,t.scaling.setAll(a),e.forEach((e=>{e.material.backFaceCulling=!1,this._shadowGenerator.addShadowCaster(e),e.receiveShadows=!0,this._depthRenderer.getDepthMap().renderList.push(e)})),t.rotationQuaternion=i.Quaternion.FromEulerAngles(0,Math.PI/3,0),this._buoyancy.addMesh(t,{v1:new i.Vector3(.7/a,1/a,-1.5/a),v2:new i.Vector3(.7/a,1/a,1.5/a),v3:new i.Vector3(-1.5/a,1/a,-1.5/a)},0,2);const s=i.MeshBuilder.CreateSphere("slight",{segments:6,diameter:.5/a},this._scene);s.position.set(-.6/a,6.58/a,.3/a),s.visibility=0,s.parent=t,this._lightBuoy=new i.PointLight("point",new i.Vector3(0,0,0),this._scene),this._lightBuoy.intensity=30,this._lightBuoy.diffuse=new i.Color3(.96,.7,.15).toLinearSpace(),this._lightBuoy.shadowMinZ=.01,this._lightBuoy.shadowMaxZ=15,this._lightBuoy.parent=s,this._shadowGeneratorBuoy=new i.ShadowGenerator(2048,this._lightBuoy),this._shadowGeneratorBuoy.usePoissonSampling=!0,this._shadowGeneratorBuoy.addShadowCaster(e[0]),this._shadowGeneratorBuoy.bias=.01}}_createGlowLayer(){this._glowLayer=new i.GlowLayer("glow",this._scene),this._glowLayer.addIncludedOnlyMesh(this._scene.getMeshByName("glassCovers_low")),this._glowLayer.customEmissiveColorSelector=(e,t,a,i)=>{i.set(this._lightBuoy.diffuse.r,this._lightBuoy.diffuse.g,this._lightBuoy.diffuse.b,1)},this._forceUpdateGlowIntensity=!0}async _updateSize(e){var t;this._size=e,this._buoyancy.size=e;const a=await(await fetch(r)).arrayBuffer();null===(t=this._wavesGenerator)||void 0===t||t.dispose(),this._wavesGenerator=new u.WavesGenerator(this._size,this._wavesSettings,this._scene,this._rttDebug,a),this._oceanMaterial.setWavesGenerator(this._wavesGenerator),await this._oceanGeometry.initializeMaterials()}_readValue(e,t){const a=t.split("_");for(let t=0;t<a.length;++t)e=e[a[t]];return e}_setValue(e,t,a){const i=t.split("_");for(let t=0;t<i.length-1;++t)e=e[i[t]];e[i[i.length-1]]=a}_parameterRead(e){switch(e){case"size":return this._size;case"showDebugRTT":return this._rttDebug.isVisible;case"envIntensity":return this._scene.environmentIntensity;case"lightIntensity":return this._light.intensity;case"proceduralSky":return this._useProceduralSky;case"enableShadows":return this._light.shadowEnabled;case"enableFXAA":return null!==this._fxaa;case"enableGlow":return null!==this._glowLayer;case"useZQSD":return this._useZQSD;case"buoy_enabled":return this._buoyancy.enabled;case"buoy_attenuation":return this._buoyancy.attenuation;case"buoy_numSteps":return this._buoyancy.numSteps;case"skybox_lightColor":return this._light.diffuse.toHexString();case"skybox_directionX":return this._lightDirection.x;case"skybox_directionY":return this._lightDirection.y;case"skybox_directionZ":return this._lightDirection.z}return e.startsWith("procSky_")?(e=e.substring(8),this._skybox.skyMaterial[e]):e.startsWith("waves_")?(e=e.substring(6),this._readValue(this._wavesSettings,e)):e.startsWith("oceangeom_")?(e=e.substring(10),this._readValue(this._oceanGeometry,e)):e.startsWith("oceanshader_")?(e=e.substring(12),this._oceanMaterial.readMaterialParameter(this._oceanGeometry.getMaterial(0),e)):void 0}_parameterChanged(e,t){switch(e){case"size":{const e=0|t;e!==this._size&&this._updateSize(e);break}case"showDebugRTT":this._rttDebug.show(!!t);break;case"envIntensity":this._scene.environmentIntensity=parseFloat(t);break;case"lightIntensity":this._light.intensity=parseFloat(t);break;case"enableShadows":this._light.shadowEnabled=!!t,this._lightBuoy&&(this._lightBuoy.shadowEnabled=!!t);break;case"enableFXAA":t?this._fxaa||(this._fxaa=new i.FxaaPostProcess("fxaa",1,this._camera),this._fxaa.samples=this._engine.getCaps().maxMSAASamples):this._fxaa&&(this._fxaa.dispose(),this._fxaa=null);break;case"enableGlow":this._glowLayer?(this._glowLayer.dispose(),this._glowLayer=null):this._createGlowLayer();break;case"proceduralSky":t=!!t,this._useProceduralSky!==t&&(this._gui.dispose(),this._skybox.dispose(),this._useProceduralSky=t,this._skybox=new d.SkyBox(this._useProceduralSky,this._scene),this._gui=new h.OceanGUI(this._useProceduralSky,this._scene,this._engine,this._parameterRead.bind(this),this._parameterChanged.bind(this)));break;case"useZQSD":this._useZQSD=!!t,this._setCameraKeys();break;case"buoy_enabled":this._buoyancy.enabled=!!t;break;case"buoy_attenuation":this._buoyancy.attenuation=parseFloat(t);break;case"buoy_numSteps":this._buoyancy.numSteps=0|t;break;case"skybox_lightColor":this._light.diffuse.copyFrom(i.Color3.FromHexString(t));break;case"skybox_directionX":this._lightDirection.x=parseFloat(t),this._light.direction=this._lightDirection.normalizeToNew();break;case"skybox_directionY":this._lightDirection.y=parseFloat(t),this._light.direction=this._lightDirection.normalizeToNew();break;case"skybox_directionZ":this._lightDirection.z=parseFloat(t),this._light.direction=this._lightDirection.normalizeToNew()}e.startsWith("procSky_")&&(e=e.substring(8),this._setValue(this._skybox.skyMaterial,e,!1!==t&&(!0===t||parseFloat(t))),this._skybox.setAsDirty()),e.startsWith("waves_")&&(e=e.substring(6),this._setValue(this._wavesSettings,e,!1!==t&&(!0===t||parseFloat(t))),this._wavesGenerator.initializeCascades()),e.startsWith("oceangeom_")&&(e=e.substring(10),this._setValue(this._oceanGeometry,e,!1!==t&&(!0===t||parseFloat(t))),"oceangeom_noMaterialLod"!==e&&this._oceanGeometry.initializeMeshes()),e.startsWith("oceanshader_")&&(e=e.substring(12),this._oceanMaterial.updateMaterialParameter(this._oceanGeometry.getMaterial(0),e,t),this._oceanMaterial.updateMaterialParameter(this._oceanGeometry.getMaterial(1),e,t),this._oceanMaterial.updateMaterialParameter(this._oceanGeometry.getMaterial(2),e,t))}}const g=new p},3955:(e,t,a)=>{a.r(t),a.d(t,{OceanGeometry:()=>r});var i,s=a(6925);!function(e){e[e.None=0]="None",e[e.Left=1]="Left",e[e.Right=2]="Right",e[e.Top=4]="Top",e[e.Bottom=8]="Bottom",e[e.All=15]="All"}(i||(i={}));class r{constructor(e,t,a){this.lengthScale=15,this.vertexDensity=30,this.clipLevels=8,this.skirtSize=10,this.noMaterialLod=!0,this.useSkirt=!0,this._oceanMaterial=e,this._camera=t,this._scene=a,this._materials=[],this._root=new s.TransformNode("Ocean",a),this._center=null,this._skirt=null,this._rings=[],this._trims=[],this._trimRotations=[s.Quaternion.RotationAxis(s.Vector3.UpReadOnly,s.Angle.FromDegrees(180).radians()),s.Quaternion.RotationAxis(s.Vector3.UpReadOnly,s.Angle.FromDegrees(90).radians()),s.Quaternion.RotationAxis(s.Vector3.UpReadOnly,s.Angle.FromDegrees(270).radians()),s.Quaternion.Identity()]}get wireframe(){return this._center.material.wireframe}set wireframe(e){this._center.material.wireframe=e,this._skirt&&(this._skirt.material.wireframe=e),this._rings.forEach((t=>t.material.wireframe=e)),this._trims.forEach((t=>t.material.wireframe=e))}async initializeMaterials(){var e,t,a;null===(e=this._materials[0])||void 0===e||e.dispose(),null===(t=this._materials[1])||void 0===t||t.dispose(),null===(a=this._materials[2])||void 0===a||a.dispose(),this._materials=[await this._oceanMaterial.getMaterial(!0,!0),await this._oceanMaterial.getMaterial(!0,!1),await this._oceanMaterial.getMaterial(!1,!1)]}initializeMeshes(){var e,t,a,i;null===(e=this._center)||void 0===e||e.dispose(),null===(t=this._skirt)||void 0===t||t.dispose(),null===(a=this._rings)||void 0===a||a.forEach((e=>e.dispose())),null===(i=this._trims)||void 0===i||i.forEach((e=>e.dispose())),this._skirt=null,this._rings=[],this._trims=[],this._instantiateMeshes()}update(){this._updatePositions(),this._updateMaterials()}getMaterial(e){return this._materials[e]}_updateMaterials(){const e=this._activeLodLevels;this._center.material=this._getMaterial(this.noMaterialLod?0:this.clipLevels-e-1);for(let t=0;t<this._rings.length;t++)this._rings[t].material=this._getMaterial(this.noMaterialLod?0:this.clipLevels-e-t),this._trims[t].material=this._getMaterial(this.noMaterialLod?0:this.clipLevels-e-t);this.useSkirt&&(this._skirt.material=this.noMaterialLod?this._materials[0]:this._materials[2])}_updatePositions(){const e=this._gridSize,t=this._activeLodLevels,a=s.TmpVectors.Vector3[0],i=s.TmpVectors.Vector3[1],r=s.TmpVectors.Vector3[2],n=s.TmpVectors.Vector3[3];let o=this._clipLevelScale(-1,t);a.copyFrom(this._camera.position),this._snap(a,2*o),this._offsetFromCenter(-1,t,i),this._center.position.copyFrom(a).addInPlace(i),this._center.scaling.set(o,1,o);for(let s=0;s<this.clipLevels;s++){if(this._rings[s].setEnabled(s<t),this._trims[s].setEnabled(s<t),s>=t)continue;o=this._clipLevelScale(s,t),r.copyFrom(this._camera.position),this._snap(r,2*o),this._offsetFromCenter(s,t,i),n.copyFrom(r).addInPlace(i).addInPlaceFromFloats(o*(e-1)/2,0,o*(e-1)/2);const l=a.x-r.x<=0?1:0,h=a.z-r.z<=0?1:0;n.x+=l*(e+1)*o,n.z+=h*(e+1)*o,this._trims[s].position.copyFrom(n),this._trims[s].rotationQuaternion.copyFrom(this._trimRotations[l+2*h]),this._trims[s].scaling.set(o,1,o),this._rings[s].position.copyFrom(r).addInPlace(i),this._rings[s].scaling.set(o,1,o),a.copyFrom(r)}this.useSkirt&&(o=2*this.lengthScale*Math.pow(2,this.clipLevels),this._skirt.position.copyFrom(a).addInPlaceFromFloats(-o*(this.skirtSize+.5-.5/e),0,-o*(this.skirtSize+.5-.5/e)),this._skirt.scaling.set(o,1,o))}get _activeLodLevels(){return this.clipLevels-s.Scalar.Clamp(Math.floor(Math.log2((1.7*Math.abs(this._camera.position.y)+1)/this.lengthScale)),0,this.clipLevels)}_clipLevelScale(e,t){return this.lengthScale/this._gridSize*Math.pow(2,this.clipLevels-t+e+1)}_offsetFromCenter(e,t,a){const i=this._gridSize,s=((1<<this.clipLevels)+r._GeometricProgressionSum(2,2,this.clipLevels-t+e+1,this.clipLevels-1))*this.lengthScale/i*(i-1)/2;a.copyFromFloats(-s,0,-s)}static _GeometricProgressionSum(e,t,a,i){return e/(1-t)*(Math.pow(t,i)-Math.pow(t,a))}_snap(e,t){e.x>=0?e.x=Math.floor(e.x/t)*t:e.x=Math.ceil((e.x-t+1)/t)*t,e.z<0?e.z=Math.floor(e.z/t)*t:e.z=Math.ceil((e.z-t+1)/t)*t,e.y=0}_getMaterial(e){return e-2<=0?this._materials[0]:e-2<=2?this._materials[1]:this._materials[2]}get _gridSize(){return 4*this.vertexDensity+1}_instantiateMeshes(){const e=this._gridSize;this._center=this._instantiateElement("Center",this._createPlaneMesh(2*e,2*e,1,i.All),this._materials[this._materials.length-1]);const t=this._createRingMesh(e,1),a=this._createTrimMesh(e,1);for(let e=0;e<this.clipLevels;++e)this._rings.push(this._instantiateElement("Ring "+e,t,this._materials[this._materials.length-1],e>0)),this._trims.push(this._instantiateElement("Trim "+e,a,this._materials[this._materials.length-1],e>0));this.useSkirt&&(this._skirt=this._instantiateElement("Skirt",this._createSkirtMesh(e,this.skirtSize),this._materials[this._materials.length-1]))}_instantiateElement(e,t,a,i=!1){return i&&(t=t.clone("")),t.name=e,t.material=a,t.parent=this._root,t.receiveShadows=!0,t}_createSkirtMesh(e,t){const a=this._createPlaneMesh(1,1,1),i=this._createPlaneMesh(e,1,1),r=this._createPlaneMesh(1,e,1),n=new s.Vector3(t,1,t),o=new s.Vector3(1/e,1,t),l=new s.Vector3(t,1,1/e),h=a.clone();h.scaling.copyFrom(n);const _=i.clone();_.scaling.copyFrom(o),_.position.x=t;const d=a.clone();d.scaling.copyFrom(n),d.position.x=t+1;const c=r.clone();c.scaling.copyFrom(l),c.position.z=t;const u=r.clone();u.scaling.copyFrom(l),u.position.x=t+1,u.position.z=t;const m=a.clone();m.scaling.copyFrom(n),m.position.z=t+1;const p=i.clone();p.scaling.copyFrom(o),p.position.x=t,p.position.z=t+1;const g=a.clone();return g.scaling.copyFrom(n),g.position.x=t+1,g.position.z=t+1,a.dispose(!0,!1),i.dispose(!0,!1),r.dispose(!0,!1),s.Mesh.MergeMeshes([h,_,d,c,u,m,p,g],!0,!0)}_createTrimMesh(e,t){const a=this._createPlaneMesh(e+1,1,t,i.None,1);a.position.set((-e-1)*t,0,-1*t);const r=this._createPlaneMesh(1,e,t,i.None,1);r.position.set(-1*t,0,(-e-1)*t);const n=s.Mesh.MergeMeshes([a,r],!0,!0);return n.rotationQuaternion=new s.Quaternion,n}_createRingMesh(e,t){const a=this._createPlaneMesh(2*e,e-1>>1,t,i.Bottom|i.Right|i.Left),r=this._createPlaneMesh(2*e,e-1>>1,t,i.Top|i.Right|i.Left);r.position.set(0,0,(e+1+(e-1>>1))*t);const n=this._createPlaneMesh(e-1>>1,e+1,t,i.Left);n.position.set(0,0,(e-1>>1)*t);const o=this._createPlaneMesh(e-1>>1,e+1,t,i.Right);return o.position.set((e+1+(e-1>>1))*t,0,(e-1>>1)*t),s.Mesh.MergeMeshes([a,r,n,o],!0,!0)}_createPlaneMesh(e,t,a,r=i.None,n=0){const o=[],l=[],h=[],_=new s.VertexData;_.positions=o,_.indices=l,_.normals=h;for(let s=0;s<t+1;++s)for(let n=0;n<e+1;++n){let l=n,_=s;(0===s&&r&i.Bottom||s===t&&r&i.Top)&&(l&=-2),(0===n&&r&i.Left||n===e&&r&i.Right)&&(_&=-2),o[0+3*n+s*(e+1)*3]=l*a,o[1+3*n+s*(e+1)*3]=0*a,o[2+3*n+s*(e+1)*3]=_*a,h[0+3*n+s*(e+1)*3]=0,h[1+3*n+s*(e+1)*3]=1,h[2+3*n+s*(e+1)*3]=0}let d=0;for(let a=0;a<t;++a)for(let t=0;t<e;++t){const i=t+a*(e+1);(a+t+n)%2==0?(l[d++]=i,l[d++]=i+e+2,l[d++]=i+e+1,l[d++]=i,l[d++]=i+1,l[d++]=i+e+2):(l[d++]=i,l[d++]=i+1,l[d++]=i+e+1,l[d++]=i+1,l[d++]=i+e+2,l[d++]=i+e+1)}const c=new s.Mesh("Clipmap plane",this._scene);return _.applyToMesh(c,!0),c}}},827:(e,t,a)=>{a.r(t),a.d(t,{OceanGUI:()=>n});var i=a(6925),s=a(4651),r=a(1063);class n{constructor(e,t,a,i,s){this._scene=t,this._visible=!0,this._onKeyObserver=null,this._paramRead=i,this._paramChanged=s;const n=document.getElementById("datGUI");null!==n&&n.remove(),this._gui=new r.ZP,this._gui.domElement.style.marginTop="60px",this._gui.domElement.id="datGUI",this._setupKeyboard(),this._initialize(e)}static LoadDAT(){return s.w1.LoadScriptAsync("https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.2/dat.gui.min.js")}set visible(e){e!==this._visible&&(this._visible=e,this._gui.domElement.style.display=e?"":"none")}dispose(){const e=document.getElementById("datGUI");null!==e&&e.remove(),this._scene.onKeyboardObservable.remove(this._onKeyObserver)}_setupKeyboard(){this._onKeyObserver=this._scene.onKeyboardObservable.add((e=>{switch(e.type){case i.KeyboardEventTypes.KEYDOWN:break;case i.KeyboardEventTypes.KEYUP:"F8"===e.event.key&&(this.visible=!this._visible)}}))}_initialize(e){this._makeMenuGeneral(),e?this._makeMenuProceduralSky():this._makeMenuSkybox(),this._makeMenuWavesGenerator(),this._makeMenuOceanGeometry(),this._makeMenuOceanShader(),this._makeMenuBuoyancy()}_addList(e,t,a,i,s){e.add(t,a,s).name(i).onChange((e=>{this._paramChanged(a,e)}))}_addCheckbox(e,t,a,i){e.add(t,a).name(i).onChange((e=>{this._paramChanged(a,e)}))}_addSlider(e,t,a,i,s,r,n){e.add(t,a,s,r,n).name(i).onChange((e=>{this._paramChanged(a,e)}))}_addColor(e,t,a,i){e.addColor(t,a).name(i).onChange((e=>{this._paramChanged(a,e)}))}_makeMenuGeneral(){const e={size:this._paramRead("size"),envIntensity:this._paramRead("envIntensity"),lightIntensity:this._paramRead("lightIntensity"),enableShadows:this._paramRead("enableShadows"),enableGlow:this._paramRead("enableGlow"),useZQSD:this._paramRead("useZQSD"),showDebugRTT:this._paramRead("showDebugRTT")},t=this._gui.addFolder("General");this._addList(t,e,"size","Resolution",[256,128,64,32]),this._addSlider(t,e,"envIntensity","Env intensity",0,4,.05),this._addSlider(t,e,"lightIntensity","Light intensity",0,5,.05),this._addCheckbox(t,e,"enableShadows","Enable shadows"),this._addCheckbox(t,e,"enableGlow","Enable Glow layer"),this._addCheckbox(t,e,"useZQSD","Use ZQSD"),this._addCheckbox(t,e,"showDebugRTT","Show debug RTT"),t.open()}_makeMenuProceduralSky(){const e={procSky_inclination:this._paramRead("procSky_inclination"),procSky_azimuth:this._paramRead("procSky_azimuth"),procSky_luminance:this._paramRead("procSky_luminance"),procSky_turbidity:this._paramRead("procSky_turbidity"),procSky_rayleigh:this._paramRead("procSky_rayleigh"),procSky_mieCoefficient:this._paramRead("procSky_mieCoefficient"),procSky_mieDirectionalG:this._paramRead("procSky_mieDirectionalG")},t=this._gui.addFolder("Sky");this._addSlider(t,e,"procSky_inclination","Inclination",-.5,.5,.001),this._addSlider(t,e,"procSky_azimuth","Azimuth",0,1,.001),this._addSlider(t,e,"procSky_luminance","Luminance",.001,1,.001),this._addSlider(t,e,"procSky_turbidity","Turbidity",.1,100,.1),this._addSlider(t,e,"procSky_rayleigh","Rayleigh",.1,10,.1),this._addSlider(t,e,"procSky_mieCoefficient","Mie Coefficient",0,.1,1e-4),this._addSlider(t,e,"procSky_mieDirectionalG","Mie DirectionalG",0,1,.01),t.open()}_makeMenuSkybox(){const e={skybox_lightColor:this._paramRead("skybox_lightColor"),skybox_directionX:this._paramRead("skybox_directionX"),skybox_directionY:this._paramRead("skybox_directionY"),skybox_directionZ:this._paramRead("skybox_directionZ")},t=this._gui.addFolder("Sky");this._addColor(t,e,"skybox_lightColor","Light color"),this._addSlider(t,e,"skybox_directionX","Light dir X",-10,10,.001),this._addSlider(t,e,"skybox_directionY","Light dir Y",-10,-.01,.001),this._addSlider(t,e,"skybox_directionZ","Light dir Z",-10,10,.001)}_makeMenuWavesGenerator(){const e={waves_g:this._paramRead("waves_g"),waves_depth:this._paramRead("waves_depth"),waves_lambda:this._paramRead("waves_lambda"),waves_local_scale:this._paramRead("waves_local_scale"),waves_local_windSpeed:this._paramRead("waves_local_windSpeed"),waves_local_windDirection:this._paramRead("waves_local_windDirection"),waves_local_fetch:this._paramRead("waves_local_fetch"),waves_local_spreadBlend:this._paramRead("waves_local_spreadBlend"),waves_local_swell:this._paramRead("waves_local_swell"),waves_local_peakEnhancement:this._paramRead("waves_local_peakEnhancement"),waves_local_shortWavesFade:this._paramRead("waves_local_shortWavesFade"),waves_swell_scale:this._paramRead("waves_swell_scale"),waves_swell_windSpeed:this._paramRead("waves_swell_windSpeed"),waves_swell_windDirection:this._paramRead("waves_swell_windDirection"),waves_swell_fetch:this._paramRead("waves_swell_fetch"),waves_swell_spreadBlend:this._paramRead("waves_swell_spreadBlend"),waves_swell_swell:this._paramRead("waves_swell_swell"),waves_swell_peakEnhancement:this._paramRead("waves_swell_peakEnhancement"),waves_swell_shortWavesFade:this._paramRead("waves_swell_shortWavesFade")},t=this._gui.addFolder("Waves Generator");this._addSlider(t,e,"waves_g","Gravity",.01,30,.01),this._addSlider(t,e,"waves_depth","Ocean depth",.001,3,.001),this._addSlider(t,e,"waves_lambda","Lambda",0,1,.001);const a=t.addFolder("Local");this._addSlider(a,e,"waves_local_scale","Scale",0,1,.001),this._addSlider(a,e,"waves_local_windSpeed","Wind speed",.001,100,.001),this._addSlider(a,e,"waves_local_windDirection","Wind direction",-100,100,.1),this._addSlider(a,e,"waves_local_fetch","Fetch",100,1e6,100),this._addSlider(a,e,"waves_local_spreadBlend","Spread blend",0,1,.01),this._addSlider(a,e,"waves_local_swell","Swell",0,1,.01),this._addSlider(a,e,"waves_local_peakEnhancement","Peak enhanc.",.01,100,.01),this._addSlider(a,e,"waves_local_shortWavesFade","Short waves fade",.001,1,.001),a.open();const i=t.addFolder("Swell");this._addSlider(i,e,"waves_swell_scale","Scale",0,1,.001),this._addSlider(i,e,"waves_swell_windSpeed","Wind speed",.001,100,.001),this._addSlider(i,e,"waves_swell_windDirection","Wind direction",-100,100,.1),this._addSlider(i,e,"waves_swell_fetch","Fetch",100,1e6,100),this._addSlider(i,e,"waves_swell_spreadBlend","Spread blend",0,1,.01),this._addSlider(i,e,"waves_swell_swell","Swell",0,1,.01),this._addSlider(i,e,"waves_swell_peakEnhancement","Peak enhanc.",.01,100,.01),this._addSlider(i,e,"waves_swell_shortWavesFade","Short waves fade",.001,1,.001),i.open(),t.open()}_makeMenuOceanGeometry(){const e={oceangeom_lengthScale:this._paramRead("oceangeom_lengthScale"),oceangeom_vertexDensity:this._paramRead("oceangeom_vertexDensity"),oceangeom_clipLevels:this._paramRead("oceangeom_clipLevels"),oceangeom_skirtSize:this._paramRead("oceangeom_skirtSize"),oceangeom_wireframe:this._paramRead("oceangeom_wireframe"),oceangeom_noMaterialLod:this._paramRead("oceangeom_noMaterialLod")},t=this._gui.addFolder("Ocean Geometry");this._addSlider(t,e,"oceangeom_lengthScale","Length scale",1,100,.1),this._addSlider(t,e,"oceangeom_vertexDensity","Vertex density",1,40,1),this._addSlider(t,e,"oceangeom_clipLevels","Clip levels",1,8,1),this._addSlider(t,e,"oceangeom_skirtSize","Skirt size",0,100,.1),this._addCheckbox(t,e,"oceangeom_wireframe","Wireframe"),this._addCheckbox(t,e,"oceangeom_noMaterialLod","No material LOD")}_makeMenuOceanShader(){const e={oceanshader__Color:this._paramRead("oceanshader__Color"),oceanshader__MaxGloss:this._paramRead("oceanshader__MaxGloss"),oceanshader__RoughnessScale:this._paramRead("oceanshader__RoughnessScale"),oceanshader__LOD_scale:this._paramRead("oceanshader__LOD_scale"),oceanshader__FoamColor:this._paramRead("oceanshader__FoamColor"),oceanshader__FoamScale:this._paramRead("oceanshader__FoamScale"),oceanshader__ContactFoam:this._paramRead("oceanshader__ContactFoam"),oceanshader__FoamBiasLOD2:this._paramRead("oceanshader__FoamBiasLOD2"),oceanshader__SSSColor:this._paramRead("oceanshader__SSSColor"),oceanshader__SSSStrength:this._paramRead("oceanshader__SSSStrength"),oceanshader__SSSBase:this._paramRead("oceanshader__SSSBase"),oceanshader__SSSScale:this._paramRead("oceanshader__SSSScale")},t=this._gui.addFolder("Ocean Shader");this._addColor(t,e,"oceanshader__Color","Color"),this._addSlider(t,e,"oceanshader__MaxGloss","Max gloss",0,1,.01),this._addSlider(t,e,"oceanshader__RoughnessScale","Roughness scale",0,1,1e-4),this._addSlider(t,e,"oceanshader__LOD_scale","LOD scale",.01,20,.01),this._addColor(t,e,"oceanshader__FoamColor","Foam color"),this._addSlider(t,e,"oceanshader__FoamScale","Foam scale",.001,8,.001),this._addSlider(t,e,"oceanshader__ContactFoam","Foam contact",.001,3,.001),this._addSlider(t,e,"oceanshader__FoamBiasLOD2","Foam bias",.001,4,.001),this._addColor(t,e,"oceanshader__SSSColor","SSS color"),this._addSlider(t,e,"oceanshader__SSSStrength","SSS strength",.001,2,.001),this._addSlider(t,e,"oceanshader__SSSBase","SSS base",-2,1,.001),this._addSlider(t,e,"oceanshader__SSSScale","SSS scale",.001,10,.001)}_makeMenuBuoyancy(){const e={buoy_enabled:this._paramRead("buoy_enabled"),buoy_attenuation:this._paramRead("buoy_attenuation"),buoy_numSteps:this._paramRead("buoy_numSteps")},t=this._gui.addFolder("Buoyancy");this._addCheckbox(t,e,"buoy_enabled","Enabled"),this._addSlider(t,e,"buoy_attenuation","Damping factor",0,1,.001),this._addSlider(t,e,"buoy_numSteps","Num steps",1,20,1)}}},1817:(e,t,a)=>{a.r(t),a.d(t,{OceanMaterial:()=>r});var i=a(6925),s=a(6462);class r{constructor(e,t){var a,s;this._wavesGenerator=null,this._depthRenderer=e,this._scene=t,this._camera=null!==(s=null===(a=t.activeCameras)||void 0===a?void 0:a[0])&&void 0!==s?s:t.activeCamera,this._foamTexture=new i.Texture("https://assets.babylonjs.com/environments/waterFoam_circular_mask.png",this._scene),this._startTime=(new Date).getTime()/1e3}setWavesGenerator(e){this._wavesGenerator=e}readMaterialParameter(e,t){const a=new i.Color3;for(const i in e._newUniformInstances){const[s,r]=i.split("-");let n=e._newUniformInstances[i];if(r===t)return"vec3"===s&&(a.copyFromFloats(n.x,n.y,n.z),a.toGammaSpaceToRef(a),n=a.toHexString()),n}return null}updateMaterialParameter(e,t,a){const s=new i.Vector3;for(const r in e._newUniformInstances){const[n,o]=r.split("-");if(o===t)return"vec3"===n&&(a=(a=i.Color3.FromHexString(a)).toLinearSpaceToRef(a),s.copyFromFloats(a.r,a.g,a.b),a=s),void(e._newUniformInstances[r]=a)}}async getMaterial(e,t,a=!1){let r;if(!a){r=new s.B_("oceanMat"+(e?"1":"0")+(t?"1":"0"),this._scene),r.metallic=0,r.roughness=.311,r.forceIrradianceInFragment=!0;const a=new i.Vector3(.011126082368383245,.05637409755197975,.09868919754109445);r.AddUniform("_Color","vec3",a),r.AddUniform("_MaxGloss","float",.91),r.AddUniform("_RoughnessScale","float",.0044),r.AddUniform("_LOD_scale","float",7.13),r.AddUniform("_FoamColor","vec3",new i.Vector3(1,1,1)),r.AddUniform("_FoamScale","float",2.4),r.AddUniform("_ContactFoam","float",1),r.AddUniform("_FoamBiasLOD0","float",.84),r.AddUniform("_FoamBiasLOD1","float",1.83),r.AddUniform("_FoamBiasLOD2","float",2.72),r.AddUniform("_SSSColor","vec3",new i.Vector3(.1541919,.8857628,.990566)),r.AddUniform("_SSSStrength","float",.15),r.AddUniform("_SSSBase","float",-.261),r.AddUniform("_SSSScale","float",4.7),r.AddUniform("lightDirection","vec3",""),r.AddUniform("_WorldSpaceCameraPos","vec3",""),r.AddUniform("LengthScale0","float",this._wavesGenerator.lengthScale[0]),r.AddUniform("LengthScale1","float",this._wavesGenerator.lengthScale[1]),r.AddUniform("LengthScale2","float",this._wavesGenerator.lengthScale[2]),r.AddUniform("_Displacement_c0","sampler2D",this._wavesGenerator.getCascade(0).displacement),r.AddUniform("_Derivatives_c0","sampler2D",this._wavesGenerator.getCascade(0).derivatives),r.AddUniform("_Turbulence_c0","sampler2D",this._wavesGenerator.getCascade(0).turbulence),r.AddUniform("_Displacement_c1","sampler2D",this._wavesGenerator.getCascade(1).displacement),r.AddUniform("_Derivatives_c1","sampler2D",this._wavesGenerator.getCascade(1).derivatives),r.AddUniform("_Turbulence_c1","sampler2D",this._wavesGenerator.getCascade(1).turbulence),r.AddUniform("_Displacement_c2","sampler2D",this._wavesGenerator.getCascade(2).displacement),r.AddUniform("_Derivatives_c2","sampler2D",this._wavesGenerator.getCascade(2).derivatives),r.AddUniform("_Turbulence_c2","sampler2D",this._wavesGenerator.getCascade(2).turbulence),r.AddUniform("_Time","float",0),r.AddUniform("_CameraDepthTexture","sampler2D",this._depthRenderer.getDepthMap()),r.AddUniform("_CameraData","vec4",new i.Vector4(this._camera.minZ,this._camera.maxZ,this._camera.maxZ-this._camera.minZ,0)),r.AddUniform("_FoamTexture","sampler2D",this._foamTexture);const n=[];return e&&n.push("#define MID"),t&&n.push("#define CLOSE"),r.Vertex_Definitions(`\n                ${n.join("\n")}\n\n                varying vec2 vWorldUV;\n                varying vec2 vUVCoords_c0;\n                varying vec2 vUVCoords_c1;\n                varying vec2 vUVCoords_c2;\n                varying vec3 vViewVector;\n                varying vec4 vLodScales;\n                varying vec4 vClipCoords;\n                varying float vMetric;\n            `),r.Fragment_Definitions(`\n                ${n.join("\n")}\n\n                varying vec2 vWorldUV;\n                varying vec2 vUVCoords_c0;\n                varying vec2 vUVCoords_c1;\n                varying vec2 vUVCoords_c2;\n                varying vec3 vViewVector;\n                varying vec4 vLodScales;\n                varying vec4 vClipCoords;\n                varying float vMetric;\n            `),r.Vertex_After_WorldPosComputed("\n                vWorldUV = worldPos.xz;\n            \n                vViewVector = _WorldSpaceCameraPos - worldPos.xyz;\n                float viewDist = length(vViewVector);\n            \n                float lod_c0 = min(_LOD_scale * LengthScale0 / viewDist, 1.0);\n                float lod_c1 = min(_LOD_scale * LengthScale1 / viewDist, 1.0);\n                float lod_c2 = min(_LOD_scale * LengthScale2 / viewDist, 1.0);\n                    \n                vec3 displacement = vec3(0.);\n                float largeWavesBias = 0.;\n            \n                vUVCoords_c0 = vWorldUV / LengthScale0;\n                vUVCoords_c1 = vWorldUV / LengthScale1;\n                vUVCoords_c2 = vWorldUV / LengthScale2;\n            \n                displacement += texture2D(_Displacement_c0, vUVCoords_c0).xyz * lod_c0;\n                largeWavesBias = displacement.y;\n            \n                #if defined(MID) || defined(CLOSE)\n                    displacement += texture2D(_Displacement_c1, vUVCoords_c1).xyz * lod_c1;\n                #endif\n                #if defined(CLOSE)\n                    displacement += texture2D(_Displacement_c2, vUVCoords_c2).xyz * lod_c2;\n                #endif\n    \n                worldPos.xyz += displacement;\n\n                vLodScales = vec4(lod_c0, lod_c1, lod_c2, max(displacement.y - largeWavesBias * 0.8 - _SSSBase, 0) / _SSSScale);\n            "),r.Vertex_MainEnd("\n                vClipCoords = gl_Position;\n                vMetric = gl_Position.z;\n            "),r.Fragment_Before_Lights("\n                vec4 derivatives = texture2D(_Derivatives_c0, vUVCoords_c0);\n                #if defined(MID) || defined(CLOSE)\n                    derivatives += texture2D(_Derivatives_c1, vUVCoords_c1) * vLodScales.y;\n                #endif\n                #if defined(CLOSE)\n                    derivatives += texture2D(_Derivatives_c2, vUVCoords_c2) * vLodScales.z;\n                #endif\n\n                vec2 slope = vec2(derivatives.x / (1.0 + derivatives.z), derivatives.y / (1.0 + derivatives.w));\n                normalW = normalize(vec3(-slope.x, 1.0, -slope.y));\n\n                #if defined(CLOSE)\n                    float jacobian = texture2D(_Turbulence_c0, vUVCoords_c0).x + texture2D(_Turbulence_c1, vUVCoords_c1).x + texture2D(_Turbulence_c2, vUVCoords_c2).x;\n                    jacobian = min(1.0, max(0.0, (-jacobian + _FoamBiasLOD2) * _FoamScale));\n                #elif defined(MID)\n                    float jacobian = texture2D(_Turbulence_c0, vUVCoords_c0).x + texture2D(_Turbulence_c1, vUVCoords_c1).x;\n                    jacobian = min(1.0, max(0.0, (-jacobian + _FoamBiasLOD1) * _FoamScale));\n                #else\n                    float jacobian = texture2D(_Turbulence_c0, vUVCoords_c0).x;\n                    jacobian = min(1.0, max(0.0, (-jacobian + _FoamBiasLOD0) * _FoamScale));\n                #endif\n\n                vec2 screenUV = vClipCoords.xy / vClipCoords.w;\n                screenUV = screenUV * 0.5 + 0.5;\n                float backgroundDepth = texture2D(_CameraDepthTexture, screenUV).r * _CameraData.y;\n                float surfaceDepth = vMetric;\n                float depthDifference = max(0.0, (backgroundDepth - surfaceDepth) - 0.5);\n                float foam = texture2D(_FoamTexture, vWorldUV * 0.5 + _Time * 2.).r;\n                jacobian += _ContactFoam * saturate(max(0.0, foam - depthDifference) * 5.0) * 0.9;\n    \n                surfaceAlbedo = mix(vec3(0.0), _FoamColor, jacobian);\n\n                vec3 viewDir = normalize(vViewVector);\n                vec3 H = normalize(-normalW + lightDirection);\n                float ViewDotH = pow5(saturate(dot(viewDir, -H))) * 30.0 * _SSSStrength;\n                vec3 color = mix(_Color, saturate(_Color + _SSSColor.rgb * ViewDotH * vLodScales.w), vLodScales.z);\n    \n                float fresnel = dot(normalW, viewDir);\n                fresnel = saturate(1.0 - fresnel);\n                fresnel = pow5(fresnel);\n            "),r.Fragment_Custom_MetallicRoughness("\n                float distanceGloss = mix(1.0 - metallicRoughness.g, _MaxGloss, 1.0 / (1.0 + length(vViewVector) * _RoughnessScale));\n                metallicRoughness.g = 1.0 - mix(distanceGloss, 0.0, jacobian);\n            "),r.Fragment_Before_FinalColorComposition("\n                finalEmissive = mix(color * (1.0 - fresnel), vec3(0.0), jacobian);\n            "),r.Fragment_Before_FragColor("\n                //finalColor = vec4(toGammaSpace((normalW + vec3(1.)) / vec3(2.)), 1.);\n                //finalColor = vec4(vec3(surfaceDepth), 1.);\n            "),r.onBindObservable.add((()=>{var e,t,a,i,s,n;const o=((new Date).getTime()/1e3-this._startTime)/10;null===(e=r.getEffect())||void 0===e||e.setVector3("_WorldSpaceCameraPos",this._camera.position),null===(t=r.getEffect())||void 0===t||t.setTexture("_Turbulence_c0",this._wavesGenerator.getCascade(0).turbulence),null===(a=r.getEffect())||void 0===a||a.setTexture("_Turbulence_c1",this._wavesGenerator.getCascade(1).turbulence),null===(i=r.getEffect())||void 0===i||i.setTexture("_Turbulence_c2",this._wavesGenerator.getCascade(2).turbulence),null===(s=r.getEffect())||void 0===s||s.setFloat("_Time",o),null===(n=r.getEffect())||void 0===n||n.setVector3("lightDirection",this._scene.lights[0].direction)})),new Promise((e=>{this._foamTexture.isReady()?e(r):this._foamTexture.onLoadObservable.addOnce((()=>{e(r)}))}))}return r=await i.NodeMaterial.ParseFromSnippetAsync("R4152I#24",this._scene),r.getInputBlockByPredicate((e=>"LOD_scale"===e.name)).value=7.13,r.getInputBlockByPredicate((e=>"LengthScale0"===e.name)).value=this._wavesGenerator.lengthScale[0],r.getInputBlockByPredicate((e=>"Roughness"===e.name)).value=.311,r.getInputBlockByPredicate((e=>"metallic"===e.name)).value=0,r.getBlockByName("Displacement_c0").texture=this._wavesGenerator.getCascade(0).displacement,r.getBlockByName("Derivatives_c0").texture=this._wavesGenerator.getCascade(0).derivatives,r.build(),r}}},6565:(e,t,a)=>{a.r(t),a.d(t,{SkyBox:()=>n});var i=a(6925),s=a(6462);const r=a.p+"0c03bd6e3c9d04da0cf428bbf487bf68.hdr";a(6699);class n{constructor(e,t){this._procedural=e,this._scene=t,this._oldSunPosition=new i.Vector3,this._skyMaterial=null,this._probe=null,this._dirty=!1,this._dirtyCount=0,this._needPolynomialsRegen=!1,this._skybox=i.MeshBuilder.CreateBox("skyBox",{size:1e3,sideOrientation:i.Mesh.BACKSIDE},this._scene),t.meshes.splice(t.meshes.indexOf(this._skybox),1),t.meshes.splice(0,0,this._skybox),this._skyboxObserver=t.onBeforeRenderObservable.add((()=>{var e,a;this._skybox.position=null!==(a=null===(e=t.activeCameras)||void 0===e?void 0:e[0].position)&&void 0!==a?a:t.activeCamera.position})),e?this._initProceduralSkybox():this._initSkybox(),this.setAsDirty()}get probe(){return this._probe}get skyMaterial(){return this._skyMaterial}setAsDirty(){this._dirty=!0,this._dirtyCount=2,this._probe.cubeTexture.refreshRate=1,this._needPolynomialsRegen=!0}update(e){if(!this._procedural)return!1;let t=!1;const a=this._probe.cubeTexture.getInternalTexture();return this._oldSunPosition.equals(this._skyMaterial.sunPosition)&&!this._dirty||(this._oldSunPosition.copyFrom(this._skyMaterial.sunPosition),e.position=this._skyMaterial.sunPosition.clone(),e.direction=this._skyMaterial.sunPosition.negate().normalize(),e.diffuse=this._skyMaterial.getSunColor().toLinearSpace(),0==this._dirtyCount--&&(this._dirty=!1,this._probe.cubeTexture.refreshRate=0),t=!0),!this._dirty&&this._needPolynomialsRegen&&a._sphericalPolynomialComputed&&(this._probe.cubeTexture.forceSphericalPolynomialsRecompute(),this._needPolynomialsRegen=!1),t}dispose(){var e,t;this._scene.onBeforeRenderObservable.remove(this._skyboxObserver),this._scene.customRenderTargets=[],this._procedural?this._probe.dispose():(null===(e=this._scene.environmentTexture)||void 0===e||e.dispose(),null===(t=this._skybox.material.reflectionTexture)||void 0===t||t.dispose()),this._skybox.material.dispose(),this._skybox.dispose(),this._scene.environmentTexture=null}_initProceduralSkybox(){var e,t;this._skyMaterial=new s.fE("sky",this._scene),this._skybox.material=this._skyMaterial,this._skybox.material.disableDepthWrite=!0,this._skyMaterial.azimuth=.307,this._skyMaterial.inclination=0,this._probe=new i.ReflectionProbe("skyProbe",128,this._scene,!0,!0,!0),this._probe.renderList.push(this._skybox),this._probe.attachToMesh(this._skybox),this._probe.cubeTexture.activeCamera=null!==(t=null===(e=this._scene.activeCameras)||void 0===e?void 0:e[0])&&void 0!==t?t:this._scene.activeCamera,this._probe.cubeTexture.refreshRate=0,this._probe.cubeTexture.onAfterUnbindObservable.add((()=>{this._probe.cubeTexture.getInternalTexture()._sphericalPolynomialComputed?(this._probe.cubeTexture.forceSphericalPolynomialsRecompute(),this._needPolynomialsRegen=!1):this._needPolynomialsRegen=!0})),this._scene.environmentTexture=this._probe.cubeTexture,this._scene.customRenderTargets.push(this._probe.cubeTexture)}_initSkybox(){const e=new i.HDRCubeTexture(r,this._scene,256,!1,!0,!1,!0),t=new i.StandardMaterial("skyBox",this._scene);t.disableDepthWrite=!0,t.reflectionTexture=e.clone(),t.reflectionTexture.coordinatesMode=i.Texture.SKYBOX_MODE,t.diffuseColor=new i.Color3(0,0,0),t.specularColor=new i.Color3(0,0,0),this._skybox.material=t,this._scene.environmentTexture=e}}},5811:(e,t,a)=>{a.r(t),a.d(t,{RTTDebug:()=>o});var i=a(6925),s=a(511),r=a(6462),n=a(1183);class o{constructor(e,t,a=5){this._engine=t,this._scene=e,this._debugPlaneList=[],this._guiBackgrounds=[],this._guiTexts=[],this._guiButtons=[],this._exrSerializer=new n.EXRSerializer,this._camera=new i.ArcRotateCamera("debug",-Math.PI/2,Math.PI/2,10,new i.Vector3(0,0,0),this._scene),this._camera.mode=i.Camera.ORTHOGRAPHIC_CAMERA,this._camera.layerMask=268435456,this._gui=s.in.CreateFullscreenUI("debugGUI",!0,e),this._gui.layer.layerMask=268435456,this._makePlanes(a)}get camera(){return this._camera}setTexture(e,t,a,i=1){var s;this._debugPlaneList[e].material.emissiveTexture=a,1!==i&&(null===(s=this._debugPlaneList[e].material)||void 0===s||s.onBindObservable.add((()=>{var t;null===(t=this._debugPlaneList[e].material.getEffect())||void 0===t||t.setFloat("multiplier",i)}))),this._debugPlaneList[e].name=t,this._debugPlaneList[e].material.name="rttDebug_"+t,this._guiTexts[e].text=t}get isVisible(){return this._gui.layer.isEnabled}show(e){for(const t of this._debugPlaneList)t.setEnabled(e);for(const t of this._guiBackgrounds)t.isVisible=e;for(const t of this._guiTexts)t.isVisible=e;for(const t of this._guiButtons)t.isVisible=e;this._gui.layer.isEnabled=e}_makePlanes(e){const t=new s.rj("grid");t.addRowDefinition(1),this._gui.addControl(t);const a=new i.TransformNode("rttDebug",this._scene);for(let n=0;n<e;++n){const e=i.MeshBuilder.CreatePlane("plane"+n,{size:1},this._scene),o=e.getVerticesData("uv");for(let e=0;e<o.length;e+=2)o[e+1]=1-o[e+1];e.setVerticesData("uv",o),e.layerMask=268435456,e.position.x+=.5,e.position.y-=.5,e.bakeCurrentTransformIntoVertices(),e.parent=a,this._debugPlaneList.push(e);const l=new r.tk("planemat"+n,this._scene);e.material=l,l.AddUniform("multiplier","float","1.0"),l.Fragment_Before_FragColor("\n                color.rgba *= vec4(multiplier);\n            "),l.disableLighting=!0,t.addColumnDefinition(1/32);const h=new s.Ae("text"+n);h.background="green",h.color="white",h.thickness=2,h.width=.95,h.horizontalAlignment=s.oT.HORIZONTAL_ALIGNMENT_CENTER,h.verticalAlignment=s.oT.VERTICAL_ALIGNMENT_TOP,this._guiBackgrounds.push(h);const _=new s.al("title"+n,"");_.color="white",_.horizontalAlignment=s.oT.HORIZONTAL_ALIGNMENT_CENTER,_.verticalAlignment=s.oT.VERTICAL_ALIGNMENT_TOP,_.textHorizontalAlignment=s.oT.HORIZONTAL_ALIGNMENT_CENTER,_.textVerticalAlignment=s.oT.VERTICAL_ALIGNMENT_CENTER,this._guiTexts.push(_);const d=s.zx.CreateSimpleButton("button"+n,"Save");d.width=.7,d.color="white",d.cornerRadius=10,d.background="green",d.horizontalAlignment=s.oT.HORIZONTAL_ALIGNMENT_CENTER,d.verticalAlignment=s.oT.VERTICAL_ALIGNMENT_TOP,d.onPointerUpObservable.add((()=>{var e,t;const a=this._debugPlaneList[n].material.emissiveTexture;if(a){const s=null!==(t=null===(e=a.getInternalTexture())||void 0===e?void 0:e.format)&&void 0!==t?t:i.Constants.TEXTUREFORMAT_RGBA;a.readPixels().then((e=>{const t=s===i.Constants.TEXTUREFORMAT_R?["R"]:s===i.Constants.TEXTUREFORMAT_RG?["R","G"]:["R","G","B","A"];this._exrSerializer.serialize(a.getSize().width,a.getSize().height,new Float32Array(e.buffer),t),this._exrSerializer.download(this._debugPlaneList[n].name+".exr")}))}})),this._guiButtons.push(d),t.addControl(h,0,n),t.addControl(_,0,n),t.addControl(d,0,n)}for(let a=e;a<32;++a)t.addColumnDefinition(1/32);this._resize(),this._engine.onResizeObservable.add(this._resize.bind(this))}_resize(){const e=this._engine.getRenderWidth(),t=this._engine.getRenderHeight(),a=e/t;this._camera.orthoLeft=-5*a,this._camera.orthoRight=5*a,this._camera.orthoTop=5,this._camera.orthoBottom=-5,this._camera.getProjectionMatrix(!0);const s=this._camera.getTransformationMatrix().invert(),r=.0595,n=Math.floor(t*r*a/2+5),o=new i.Vector3(-1,1-r*a,.001),l=new i.Vector3(-1,1-r*a,.001);o.x+=.0015,l.x+=.0015,this._guiBackgrounds[0].parent.paddingTop=n+"px";for(let t=0;t<this._debugPlaneList.length;++t){const a=this._debugPlaneList[t];l.x+=r;const n=i.Vector3.TransformCoordinates(o,s),h=i.Vector3.TransformCoordinates(l,s).x-n.x;a.scaling.set(h,h,1),a.position.set(n.x,n.y,n.z),l.x+=.003,o.x=l.x,this._guiBackgrounds[t].height=20*e/1920+"px",this._guiTexts[t].height=20*e/1920+"px",this._guiTexts[t].fontSize=8*e/1920+"px",this._guiButtons[t].top=20*e/1920+2+"px",this._guiButtons[t].height=16*e/1920+"px",this._guiButtons[t].fontSize=8*e/1920+"px"}}}},1183:(e,t,a)=>{a.r(t),a.d(t,{EXRSerializer:()=>o});var i,s,r,n=a(4651);!function(e){e[e.UINT=0]="UINT",e[e.HALF=1]="HALF",e[e.FLOAT=2]="FLOAT"}(i||(i={})),function(e){e[e.NO_COMPRESSION=0]="NO_COMPRESSION",e[e.RLE_COMPRESSION=1]="RLE_COMPRESSION",e[e.ZIPS_COMPRESSION=2]="ZIPS_COMPRESSION",e[e.ZIP_COMPRESSION=3]="ZIP_COMPRESSION",e[e.PIZ_COMPRESSION=4]="PIZ_COMPRESSION",e[e.PXR24_COMPRESSION=5]="PXR24_COMPRESSION",e[e.B44_COMPRESSION=6]="B44_COMPRESSION",e[e.B44A_COMPRESSION=7]="B44A_COMPRESSION"}(s||(s={})),function(e){e[e.INCREASING_Y=0]="INCREASING_Y",e[e.DECREASING_Y=1]="DECREASING_Y",e[e.RANDOM_Y=2]="RANDOM_Y"}(r||(r={}));class o{constructor(){this._buffer=new Uint8Array(0),this._dataLength=0,this._view=new DataView(this._buffer.buffer),this._growSize=2e3}get buffer(){return this._buffer}serialize(e,t,a,n=["R","G","B","A"]){this._dataLength=0;const o=n.length;this._capacity(e*t*o*4);const l=[],h=["A","B","G","R"];let _=0;for(let e=0;e<h.length;++e)n.indexOf(h[e])>=0&&(l.push({name:h[e],pixelType:i.FLOAT}),_|=1<<3-e);this._add([118,47,49,1]),this._addInt32(2),this._addHeaderAttribute_chlist("channels",l),this._addHeaderAttribute_compression("compression",s.NO_COMPRESSION),this._addHeaderAttribute_box2i("dataWindow",0,0,e-1,t-1),this._addHeaderAttribute_box2i("displayWindow",0,0,e-1,t-1),this._addHeaderAttribute_lineOrder("lineOrder",r.INCREASING_Y),this._addHeaderAttribute_float("pixelAspectRatio",1),this._addHeaderAttribute_v2f("screenWindowCenter",0,0),this._addHeaderAttribute_float("screenWindowWidth",e),this._addNull();const d=[],c=8*t,u=e*o*4;let m=this._dataLength+c;for(let e=0;e<t;++e)d.push(BigInt(m)),m+=u+8;this._addUint64(d);for(let i=0;i<t;++i){this._addUint32(i),this._addUint32(u);for(let t=3;t>=0;--t)if(_&1<<t)for(let s=0;s<e;++s){const r=a[i*e*o+s*o+t];this._addFloat(r)}}this._buffer=this._buffer.slice(0,this._dataLength),this._view=new DataView(this._buffer.buffer)}download(e){n.w1.Download(new Blob([this._buffer.buffer],{type:"application/octet-stream"}),e)}_addHeaderAttribute_chlist(e,t){this._addString(e),this._addNull(),this._addString("chlist"),this._addNull();let a=1;for(let e=0;e<t.length;++e)a+=t[e].name.length+1,a+=16;this._addUint32(a);for(let e=0;e<t.length;++e){const a=t[e];this._addString(a.name),this._addNull(),this._addInt32(a.pixelType),this._addUint8(0),this._addNull(3),this._addInt32([1,1])}this._addNull()}_addHeaderAttribute_compression(e,t){this._addString(e),this._addNull(),this._addString("compression"),this._addNull(),this._addUint32(1),this._addUint8(t)}_addHeaderAttribute_box2i(e,t,a,i,s){this._addString(e),this._addNull(),this._addString("box2i"),this._addNull(),this._addUint32(16),this._addInt32([t,a,i,s])}_addHeaderAttribute_lineOrder(e,t){this._addString(e),this._addNull(),this._addString("lineOrder"),this._addNull(),this._addUint32(1),this._addUint8(t)}_addHeaderAttribute_float(e,t){this._addString(e),this._addNull(),this._addString("float"),this._addNull(),this._addUint32(4),this._addFloat(t)}_addHeaderAttribute_v2f(e,t,a){this._addString(e),this._addNull(),this._addString("v2f"),this._addNull(),this._addUint32(8),this._addFloat([t,a])}_addString(e){this._capacity(e.length);for(let t=0;t<e.length;++t)this._view.setUint8(this._dataLength++,e.charCodeAt(t))}_addInt8(e){if(Array.isArray(e)){this._capacity(e.length);for(let t=0;t<e.length;++t)this._view.setInt8(this._dataLength++,e[t])}else this._capacity(1),this._view.setInt8(this._dataLength,e),this._dataLength+=1}_addUint8(e){this._capacity(1),this._view.setUint8(this._dataLength,e),this._dataLength+=1}_addInt16(e){if(Array.isArray(e)){this._capacity(2*e.length);for(let t=0;t<e.length;++t)this._view.setInt16(this._dataLength,e[t],!0),this._dataLength+=2}else this._capacity(2),this._view.setInt16(this._dataLength,e,!0),this._dataLength+=2}_addUint16(e){if(Array.isArray(e)){this._capacity(2*e.length);for(let t=0;t<e.length;++t)this._view.setUint16(this._dataLength,e[t],!0),this._dataLength+=2}else this._view.setUint16(this._dataLength,e,!0),this._dataLength+=2}_addInt32(e){if(Array.isArray(e)){this._capacity(4*e.length);for(let t=0;t<e.length;++t)this._view.setInt32(this._dataLength,e[t],!0),this._dataLength+=4}else this._capacity(4),this._view.setInt32(this._dataLength,e,!0),this._dataLength+=4}_addUint32(e){if(Array.isArray(e)){this._capacity(4*e.length);for(let t=0;t<e.length;++t)this._view.setUint32(this._dataLength,e[t],!0),this._dataLength+=4}else this._capacity(4),this._view.setUint32(this._dataLength,e,!0),this._dataLength+=4}_addUint64(e){if(Array.isArray(e)){this._capacity(8*e.length);for(let t=0;t<e.length;++t)this._view.setBigUint64(this._dataLength,e[t],!0),this._dataLength+=8}else{this._capacity(e.byteLength);for(let t=0;t<e.length;++t)this._view.setBigUint64(this._dataLength,e[t],!0),this._dataLength+=8}}_addFloat(e){if(Array.isArray(e)){this._capacity(4*e.length);for(let t=0;t<e.length;++t)this._view.setFloat32(this._dataLength,e[t],!0),this._dataLength+=4}else e instanceof Float32Array?(this._capacity(e.byteLength),this._buffer.set(e,this._dataLength),this._dataLength+=e.byteLength):(this._capacity(4),this._view.setFloat32(this._dataLength,e,!0),this._dataLength+=4)}_addNull(e=1){for(this._capacity(e);e-- >0;)this._view.setUint8(this._dataLength++,0)}_add(e){Array.isArray(e)&&(e=new Uint8Array(e));const t=e.byteLength;this._capacity(t),this._buffer.set(e,this._dataLength),this._dataLength+=t}_capacity(e){this._dataLength+e<=this._buffer.byteLength||this._growBuffer(Math.max(this._growSize,e))}_growBuffer(e){const t=new Uint8Array(this._buffer.byteLength+e);t.set(this._buffer,0),this._buffer=t,this._view=new DataView(this._buffer.buffer)}}},6113:(e,t,a)=>{a.r(t),a.d(t,{WavesSettings:()=>s});var i=a(6925);class s{constructor(){this.g=9.81,this.depth=3,this.lambda=1,this.local={scale:.5,windSpeed:1.5,windDirection:-29.81,fetch:1e5,spreadBlend:1,swell:.198,peakEnhancement:3.3,shortWavesFade:.01},this.swell={scale:.5,windSpeed:1.5,windDirection:90,fetch:3e5,spreadBlend:1,swell:1,peakEnhancement:3.3,shortWavesFade:.01},this.spectrums=[{scale:0,angle:0,spreadBlend:0,swell:0,alpha:0,peakOmega:0,gamma:0,shortWavesFade:0},{scale:0,angle:0,spreadBlend:0,swell:0,alpha:0,peakOmega:0,gamma:0,shortWavesFade:0}]}setParametersToShader(e,t){e.updateFloat("GravityAcceleration",this.g),e.updateFloat("Depth",this.depth),this._fillSettingsStruct(this.local,this.spectrums[0]),this._fillSettingsStruct(this.swell,this.spectrums[1]);const a=[];this._linearizeSpectrumSetting(this.spectrums[0],a),this._linearizeSpectrumSetting(this.spectrums[1],a),t.update(a)}_linearizeSpectrumSetting(e,t){t.push(e.scale,e.angle,e.spreadBlend,e.swell,e.alpha,e.peakOmega,e.gamma,e.shortWavesFade)}_fillSettingsStruct(e,t){t.scale=e.scale,t.angle=e.windDirection/180*Math.PI,t.spreadBlend=e.spreadBlend,t.swell=i.Scalar.Clamp(e.swell,.01,1),t.alpha=this._JonswapAlpha(this.g,e.fetch,e.windSpeed),t.peakOmega=this._JonswapPeakFrequency(this.g,e.fetch,e.windSpeed),t.gamma=e.peakEnhancement,t.shortWavesFade=e.shortWavesFade}_JonswapAlpha(e,t,a){return.076*Math.pow(e*t/a/a,-.22)}_JonswapPeakFrequency(e,t,a){return 22*Math.pow(a*t/e/e,-.33)}}}}]);
//# sourceMappingURL=5.54b9d881d86e4cdcf1ed.js.map
"use strict";(self.webpackChunkbabylonjs_ocean_demo=self.webpackChunkbabylonjs_ocean_demo||[]).push([[745],{9745:(e,t,s)=>{var n=s(4673),r=s(4651),o=s(6409),a=s(5702),i=s(9288),l=s(2830);function c(e,t,s,n){const r={externalResourceFunction:e=>n(e).then((e=>new Uint8Array(e)))};return s&&(r.uri="file:"===t?s:t+s),e instanceof ArrayBuffer?GLTFValidator.validateBytes(new Uint8Array(e),r):GLTFValidator.validateString(e,r)}function h(){const e=[];onmessage=t=>{const s=t.data;switch(s.id){case"init":importScripts(s.url);break;case"validate":c(s.data,s.rootUrl,s.fileName,(t=>new Promise(((s,n)=>{const r=e.length;e.push({resolve:s,reject:n}),postMessage({id:"getExternalResource",index:r,uri:t})})))).then((e=>{postMessage({id:"validate.resolve",value:e})}),(e=>{postMessage({id:"validate.reject",reason:e})}));break;case"getExternalResource.resolve":e[s.index].resolve(s.value);break;case"getExternalResource.reject":e[s.index].reject(s.reason)}}}class d{static ValidateAsync(e,t,s,n){return"function"==typeof Worker?new Promise(((r,o)=>{const a=`${c}(${h})()`,i=URL.createObjectURL(new Blob([a],{type:"application/javascript"})),l=new Worker(i),d=e=>{l.removeEventListener("error",d),l.removeEventListener("message",u),o(e)},u=e=>{const t=e.data;switch(t.id){case"getExternalResource":n(t.uri).then((e=>{l.postMessage({id:"getExternalResource.resolve",index:t.index,value:e},[e])}),(e=>{l.postMessage({id:"getExternalResource.reject",index:t.index,reason:e})}));break;case"validate.resolve":l.removeEventListener("error",d),l.removeEventListener("message",u),r(t.value),l.terminate();break;case"validate.reject":l.removeEventListener("error",d),l.removeEventListener("message",u),o(t.reason),l.terminate()}};l.addEventListener("error",d),l.addEventListener("message",u),l.postMessage({id:"init",url:this.Configuration.url}),l.postMessage({id:"validate",data:e,rootUrl:t,fileName:s})})):(this._LoadScriptPromise||(this._LoadScriptPromise=r.w1.LoadScriptAsync(this.Configuration.url)),this._LoadScriptPromise.then((()=>c(e,t,s,n))))}}d.Configuration={url:"https://preview.babylonjs.com/gltf_validator.js"};var u,_,m,f,p,y,A,g,b,T,x,E=s(4107),O=s(6790);function M(e,t,s){try{return Promise.resolve(new Uint8Array(e,t,s))}catch(e){return Promise.reject(e)}}!function(e){e[e.AUTO=0]="AUTO",e[e.FORCE_RIGHT_HANDED=1]="FORCE_RIGHT_HANDED"}(u||(u={})),function(e){e[e.NONE=0]="NONE",e[e.FIRST=1]="FIRST",e[e.ALL=2]="ALL"}(_||(_={})),function(e){e[e.LOADING=0]="LOADING",e[e.READY=1]="READY",e[e.COMPLETE=2]="COMPLETE"}(m||(m={}));class w{constructor(){this.onParsedObservable=new n.y$,this.coordinateSystemMode=u.AUTO,this.animationStartMode=_.FIRST,this.compileMaterials=!1,this.useClipPlane=!1,this.compileShadowGenerators=!1,this.transparencyAsCoverage=!1,this.useRangeRequests=!1,this.createInstances=!0,this.alwaysComputeBoundingBox=!1,this.loadAllMaterials=!1,this.loadOnlyMaterials=!1,this.skipMaterials=!1,this.useSRGBBuffers=!0,this.targetFps=60,this.alwaysComputeSkeletonRootNode=!1,this.preprocessUrlAsync=e=>Promise.resolve(e),this.onMeshLoadedObservable=new n.y$,this.onSkinLoadedObservable=new n.y$,this.onTextureLoadedObservable=new n.y$,this.onMaterialLoadedObservable=new n.y$,this.onCameraLoadedObservable=new n.y$,this.onCompleteObservable=new n.y$,this.onErrorObservable=new n.y$,this.onDisposeObservable=new n.y$,this.onExtensionLoadedObservable=new n.y$,this.validate=!1,this.onValidatedObservable=new n.y$,this._loader=null,this._state=null,this._requests=new Array,this.name="gltf",this.extensions={".gltf":{isBinary:!1},".glb":{isBinary:!0}},this.onLoaderStateChangedObservable=new n.y$,this._logIndentLevel=0,this._loggingEnabled=!1,this._log=this._logDisabled,this._capturePerformanceCounters=!1,this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled}set onParsed(e){this._onParsedObserver&&this.onParsedObservable.remove(this._onParsedObserver),this._onParsedObserver=this.onParsedObservable.add(e)}set onMeshLoaded(e){this._onMeshLoadedObserver&&this.onMeshLoadedObservable.remove(this._onMeshLoadedObserver),this._onMeshLoadedObserver=this.onMeshLoadedObservable.add(e)}set onTextureLoaded(e){this._onTextureLoadedObserver&&this.onTextureLoadedObservable.remove(this._onTextureLoadedObserver),this._onTextureLoadedObserver=this.onTextureLoadedObservable.add(e)}set onMaterialLoaded(e){this._onMaterialLoadedObserver&&this.onMaterialLoadedObservable.remove(this._onMaterialLoadedObserver),this._onMaterialLoadedObserver=this.onMaterialLoadedObservable.add(e)}set onCameraLoaded(e){this._onCameraLoadedObserver&&this.onCameraLoadedObservable.remove(this._onCameraLoadedObserver),this._onCameraLoadedObserver=this.onCameraLoadedObservable.add(e)}set onComplete(e){this._onCompleteObserver&&this.onCompleteObservable.remove(this._onCompleteObserver),this._onCompleteObserver=this.onCompleteObservable.add(e)}set onError(e){this._onErrorObserver&&this.onErrorObservable.remove(this._onErrorObserver),this._onErrorObserver=this.onErrorObservable.add(e)}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set onExtensionLoaded(e){this._onExtensionLoadedObserver&&this.onExtensionLoadedObservable.remove(this._onExtensionLoadedObserver),this._onExtensionLoadedObserver=this.onExtensionLoadedObservable.add(e)}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled!==e&&(this._loggingEnabled=e,this._loggingEnabled?this._log=this._logEnabled:this._log=this._logDisabled)}get capturePerformanceCounters(){return this._capturePerformanceCounters}set capturePerformanceCounters(e){this._capturePerformanceCounters!==e&&(this._capturePerformanceCounters=e,this._capturePerformanceCounters?(this._startPerformanceCounter=this._startPerformanceCounterEnabled,this._endPerformanceCounter=this._endPerformanceCounterEnabled):(this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled))}set onValidated(e){this._onValidatedObserver&&this.onValidatedObservable.remove(this._onValidatedObserver),this._onValidatedObserver=this.onValidatedObservable.add(e)}dispose(){this._loader&&(this._loader.dispose(),this._loader=null);for(const e of this._requests)e.abort();this._requests.length=0,delete this._progressCallback,this.preprocessUrlAsync=e=>Promise.resolve(e),this.onMeshLoadedObservable.clear(),this.onSkinLoadedObservable.clear(),this.onTextureLoadedObservable.clear(),this.onMaterialLoadedObservable.clear(),this.onCameraLoadedObservable.clear(),this.onCompleteObservable.clear(),this.onExtensionLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(void 0),this.onDisposeObservable.clear()}loadFile(e,t,s,o,a,c){this._progressCallback=o;const h=t.name?"file:":r.w1.GetFolderPath(t),d=t.name||r.w1.GetFilename(t);if(a){if(this.useRangeRequests){this.validate&&i.Y.Warn("glTF validation is not supported when range requests are enabled");const r={abort:()=>{},onCompleteObservable:new n.y$},o={readAsync:(s,n)=>new Promise(((r,o)=>{this._loadFile(e,t,(e=>{r(new Uint8Array(e))}),!0,(e=>{o(e)}),(e=>{e.setRequestHeader("Range",`bytes=${s}-${s+n-1}`)}))})),byteLength:0};return this._unpackBinaryAsync(new l.d(o)).then((e=>{r.onCompleteObservable.notifyObservers(r),s(e)}),c?e=>c(void 0,e):void 0),r}return this._loadFile(e,t,(t=>{this._validate(e,t,h,d),this._unpackBinaryAsync(new l.d({readAsync:(e,s)=>M(t,e,s),byteLength:t.byteLength})).then((e=>{s(e)}),c?e=>c(void 0,e):void 0)}),!0,c)}return this._loadFile(e,t,(t=>{this._validate(e,t,h,d),s({json:this._parseJson(t)})}),a,c)}importMeshAsync(e,t,s,n,r,o){return Promise.resolve().then((()=>(this.onParsedObservable.notifyObservers(s),this.onParsedObservable.clear(),this._log(`Loading ${o||""}`),this._loader=this._getLoader(s),this._loader.importMeshAsync(e,t,null,s,n,r,o))))}loadAsync(e,t,s,n,r){return Promise.resolve().then((()=>(this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log(`Loading ${r||""}`),this._loader=this._getLoader(t),this._loader.loadAsync(e,t,s,n,r))))}loadAssetContainerAsync(e,t,s,n,r){return Promise.resolve().then((()=>{this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log(`Loading ${r||""}`),this._loader=this._getLoader(t);const o=new a.TJ(e),i=[];this.onMaterialLoadedObservable.add((e=>{i.push(e)}));const l=[];this.onTextureLoadedObservable.add((e=>{l.push(e)}));const c=[];return this.onCameraLoadedObservable.add((e=>{c.push(e)})),this._loader.importMeshAsync(null,e,o,t,s,n,r).then((e=>(Array.prototype.push.apply(o.geometries,e.geometries),Array.prototype.push.apply(o.meshes,e.meshes),Array.prototype.push.apply(o.particleSystems,e.particleSystems),Array.prototype.push.apply(o.skeletons,e.skeletons),Array.prototype.push.apply(o.animationGroups,e.animationGroups),Array.prototype.push.apply(o.materials,i),Array.prototype.push.apply(o.textures,l),Array.prototype.push.apply(o.lights,e.lights),Array.prototype.push.apply(o.transformNodes,e.transformNodes),Array.prototype.push.apply(o.cameras,c),o)))}))}canDirectLoad(e){return-1!==e.indexOf("asset")&&-1!==e.indexOf("version")||e.startsWith("data:base64,"+w._MagicBase64Encoded)||e.startsWith("data:;base64,"+w._MagicBase64Encoded)||e.startsWith("data:application/octet-stream;base64,"+w._MagicBase64Encoded)||e.startsWith("data:model/gltf-binary;base64,"+w._MagicBase64Encoded)}directLoad(e,t){if(t.startsWith("base64,"+w._MagicBase64Encoded)||t.startsWith(";base64,"+w._MagicBase64Encoded)||t.startsWith("application/octet-stream;base64,"+w._MagicBase64Encoded)||t.startsWith("model/gltf-binary;base64,"+w._MagicBase64Encoded)){const s=(0,E.$K)(t);return this._validate(e,s),this._unpackBinaryAsync(new l.d({readAsync:(e,t)=>M(s,e,t),byteLength:s.byteLength}))}return this._validate(e,t),Promise.resolve({json:this._parseJson(t)})}createPlugin(){return new w}get loaderState(){return this._state}whenCompleteAsync(){return new Promise(((e,t)=>{this.onCompleteObservable.addOnce((()=>{e()})),this.onErrorObservable.addOnce((e=>{t(e)}))}))}_setState(e){this._state!==e&&(this._state=e,this.onLoaderStateChangedObservable.notifyObservers(this._state),this._log(m[this._state]))}_loadFile(e,t,s,n,r,o){const a=e._loadFile(t,s,(e=>{this._onProgress(e,a)}),!0,n,r,o);return a.onCompleteObservable.add((e=>{this._requests.splice(this._requests.indexOf(e),1)})),this._requests.push(a),a}_onProgress(e,t){if(!this._progressCallback)return;t._lengthComputable=e.lengthComputable,t._loaded=e.loaded,t._total=e.total;let s=!0,n=0,r=0;for(const e of this._requests){if(void 0===e._lengthComputable||void 0===e._loaded||void 0===e._total)return;s=s&&e._lengthComputable,n+=e._loaded,r+=e._total}this._progressCallback({lengthComputable:s,loaded:n,total:s?r:0})}_validate(e,t,s="",n=""){this.validate&&(this._startPerformanceCounter("Validate JSON"),d.ValidateAsync(t,s,n,(t=>this.preprocessUrlAsync(s+t).then((t=>e._loadFileAsync(t,void 0,!0,!0))))).then((e=>{this._endPerformanceCounter("Validate JSON"),this.onValidatedObservable.notifyObservers(e),this.onValidatedObservable.clear()}),(e=>{this._endPerformanceCounter("Validate JSON"),r.w1.Warn(`Failed to validate: ${e.message}`),this.onValidatedObservable.clear()})))}_getLoader(e){const t=e.json.asset||{};this._log(`Asset version: ${t.version}`),t.minVersion&&this._log(`Asset minimum version: ${t.minVersion}`),t.generator&&this._log(`Asset generator: ${t.generator}`);const s=w._parseVersion(t.version);if(!s)throw new Error("Invalid version: "+t.version);if(void 0!==t.minVersion){const e=w._parseVersion(t.minVersion);if(!e)throw new Error("Invalid minimum version: "+t.minVersion);if(w._compareVersion(e,{major:2,minor:0})>0)throw new Error("Incompatible minimum version: "+t.minVersion)}const n={1:w._CreateGLTF1Loader,2:w._CreateGLTF2Loader}[s.major];if(!n)throw new Error("Unsupported version: "+t.version);return n(this)}_parseJson(e){this._startPerformanceCounter("Parse JSON"),this._log(`JSON length: ${e.length}`);const t=JSON.parse(e);return this._endPerformanceCounter("Parse JSON"),t}_unpackBinaryAsync(e){return this._startPerformanceCounter("Unpack Binary"),e.loadAsync(20).then((()=>{const t=e.readUint32();if(1179937895!==t)throw new O.LH("Unexpected magic: "+t,O.SM.GLTFLoaderUnexpectedMagicError);const s=e.readUint32();this.loggingEnabled&&this._log(`Binary version: ${s}`);const n=e.readUint32();let r;switch(this.useRangeRequests||n===e.buffer.byteLength||i.Y.Warn(`Length in header does not match actual data length: ${n} != ${e.buffer.byteLength}`),s){case 1:r=this._unpackBinaryV1Async(e,n);break;case 2:r=this._unpackBinaryV2Async(e,n);break;default:throw new Error("Unsupported version: "+s)}return this._endPerformanceCounter("Unpack Binary"),r}))}_unpackBinaryV1Async(e,t){const s=e.readUint32(),n=e.readUint32();if(0!==n)throw new Error(`Unexpected content format: ${n}`);const r=t-e.byteOffset,o={json:this._parseJson(e.readString(s)),bin:null};if(0!==r){const t=e.byteOffset;o.bin={readAsync:(s,n)=>e.buffer.readAsync(t+s,n),byteLength:r}}return Promise.resolve(o)}_unpackBinaryV2Async(e,t){const s=1313821514,n=e.readUint32();if(e.readUint32()!==s)throw new Error("First chunk format is not JSON");return e.byteOffset+n===t?e.loadAsync(n).then((()=>({json:this._parseJson(e.readString(n)),bin:null}))):e.loadAsync(n+8).then((()=>{const r={json:this._parseJson(e.readString(n)),bin:null},o=()=>{const n=e.readUint32();switch(e.readUint32()){case s:throw new Error("Unexpected JSON chunk");case 5130562:{const t=e.byteOffset;r.bin={readAsync:(s,n)=>e.buffer.readAsync(t+s,n),byteLength:n},e.skipBytes(n);break}default:e.skipBytes(n)}return e.byteOffset!==t?e.loadAsync(8).then(o):Promise.resolve(r)};return o()}))}static _parseVersion(e){if("1.0"===e||"1.0.1"===e)return{major:1,minor:0};const t=(e+"").match(/^(\d+)\.(\d+)/);return t?{major:parseInt(t[1]),minor:parseInt(t[2])}:null}static _compareVersion(e,t){return e.major>t.major?1:e.major<t.major?-1:e.minor>t.minor?1:e.minor<t.minor?-1:0}_logOpen(e){this._log(e),this._logIndentLevel++}_logClose(){--this._logIndentLevel}_logEnabled(e){const t=w._logSpaces.substr(0,2*this._logIndentLevel);i.Y.Log(`${t}${e}`)}_logDisabled(e){}_startPerformanceCounterEnabled(e){r.w1.StartPerformanceCounter(e)}_startPerformanceCounterDisabled(e){}_endPerformanceCounterEnabled(e){r.w1.EndPerformanceCounter(e)}_endPerformanceCounterDisabled(e){}}w.IncrementalLoading=!0,w.HomogeneousCoordinates=!1,w._MagicBase64Encoded="Z2xURg",w._logSpaces="                                ",o.n&&o.n.RegisterPlugin(new w),function(e){e[e.BYTE=5120]="BYTE",e[e.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",e[e.SHORT=5122]="SHORT",e[e.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",e[e.FLOAT=5126]="FLOAT"}(f||(f={})),function(e){e[e.FRAGMENT=35632]="FRAGMENT",e[e.VERTEX=35633]="VERTEX"}(p||(p={})),function(e){e[e.BYTE=5120]="BYTE",e[e.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",e[e.SHORT=5122]="SHORT",e[e.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",e[e.INT=5124]="INT",e[e.UNSIGNED_INT=5125]="UNSIGNED_INT",e[e.FLOAT=5126]="FLOAT",e[e.FLOAT_VEC2=35664]="FLOAT_VEC2",e[e.FLOAT_VEC3=35665]="FLOAT_VEC3",e[e.FLOAT_VEC4=35666]="FLOAT_VEC4",e[e.INT_VEC2=35667]="INT_VEC2",e[e.INT_VEC3=35668]="INT_VEC3",e[e.INT_VEC4=35669]="INT_VEC4",e[e.BOOL=35670]="BOOL",e[e.BOOL_VEC2=35671]="BOOL_VEC2",e[e.BOOL_VEC3=35672]="BOOL_VEC3",e[e.BOOL_VEC4=35673]="BOOL_VEC4",e[e.FLOAT_MAT2=35674]="FLOAT_MAT2",e[e.FLOAT_MAT3=35675]="FLOAT_MAT3",e[e.FLOAT_MAT4=35676]="FLOAT_MAT4",e[e.SAMPLER_2D=35678]="SAMPLER_2D"}(y||(y={})),function(e){e[e.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",e[e.REPEAT=10497]="REPEAT"}(A||(A={})),function(e){e[e.NEAREST=9728]="NEAREST",e[e.LINEAR=9728]="LINEAR",e[e.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",e[e.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",e[e.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",e[e.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR"}(g||(g={})),function(e){e[e.ALPHA=6406]="ALPHA",e[e.RGB=6407]="RGB",e[e.RGBA=6408]="RGBA",e[e.LUMINANCE=6409]="LUMINANCE",e[e.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA"}(b||(b={})),function(e){e[e.FRONT=1028]="FRONT",e[e.BACK=1029]="BACK",e[e.FRONT_AND_BACK=1032]="FRONT_AND_BACK"}(T||(T={})),function(e){e[e.ZERO=0]="ZERO",e[e.ONE=1]="ONE",e[e.SRC_COLOR=768]="SRC_COLOR",e[e.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",e[e.DST_COLOR=774]="DST_COLOR",e[e.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",e[e.SRC_ALPHA=770]="SRC_ALPHA",e[e.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",e[e.DST_ALPHA=772]="DST_ALPHA",e[e.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",e[e.CONSTANT_COLOR=32769]="CONSTANT_COLOR",e[e.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",e[e.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",e[e.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",e[e.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE"}(x||(x={}));var v=s(972),C=s(9859),L=s(5593),N=s(156),S=s(3427),P=s(6614),I=s(3742),R=s(3212),F=s(9061),D=s(4428),$=s(3242),B=s(3778),V=s(4684),k=s(4517),U=s(7959),G=s(2254),W=s(8777),j=s(7257),Y=s(3632),H=s(2758),K=s(3789),q=s(6340),z=s(4085);class Z{static SetMatrix(e,t,s,n,r){let o=null;if("MODEL"===s.semantic?o=t.getWorldMatrix():"PROJECTION"===s.semantic?o=e.getProjectionMatrix():"VIEW"===s.semantic?o=e.getViewMatrix():"MODELVIEWINVERSETRANSPOSE"===s.semantic?o=v.y3.Transpose(t.getWorldMatrix().multiply(e.getViewMatrix()).invert()):"MODELVIEW"===s.semantic?o=t.getWorldMatrix().multiply(e.getViewMatrix()):"MODELVIEWPROJECTION"===s.semantic?o=t.getWorldMatrix().multiply(e.getTransformMatrix()):"MODELINVERSE"===s.semantic?o=t.getWorldMatrix().invert():"VIEWINVERSE"===s.semantic?o=e.getViewMatrix().invert():"PROJECTIONINVERSE"===s.semantic?o=e.getProjectionMatrix().invert():"MODELVIEWINVERSE"===s.semantic?o=t.getWorldMatrix().multiply(e.getViewMatrix()).invert():"MODELVIEWPROJECTIONINVERSE"===s.semantic?o=t.getWorldMatrix().multiply(e.getTransformMatrix()).invert():"MODELINVERSETRANSPOSE"===s.semantic&&(o=v.y3.Transpose(t.getWorldMatrix().invert())),o)switch(s.type){case y.FLOAT_MAT2:r.setMatrix2x2(n,v.y3.GetAsMatrix2x2(o));break;case y.FLOAT_MAT3:r.setMatrix3x3(n,v.y3.GetAsMatrix3x3(o));break;case y.FLOAT_MAT4:r.setMatrix(n,o)}}static SetUniform(e,t,s,n){switch(n){case y.FLOAT:return e.setFloat(t,s),!0;case y.FLOAT_VEC2:return e.setVector2(t,v.FM.FromArray(s)),!0;case y.FLOAT_VEC3:return e.setVector3(t,v.P.FromArray(s)),!0;case y.FLOAT_VEC4:return e.setVector4(t,v.Lt.FromArray(s)),!0;default:return!1}}static GetWrapMode(e){switch(e){case A.CLAMP_TO_EDGE:return V.x.CLAMP_ADDRESSMODE;case A.MIRRORED_REPEAT:return V.x.MIRROR_ADDRESSMODE;case A.REPEAT:default:return V.x.WRAP_ADDRESSMODE}}static GetByteStrideFromType(e){switch(e.type){case"VEC2":return 2;case"VEC3":return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 1}}static GetTextureFilterMode(e){switch(e){case g.LINEAR:case g.LINEAR_MIPMAP_NEAREST:case g.LINEAR_MIPMAP_LINEAR:return V.x.TRILINEAR_SAMPLINGMODE;case g.NEAREST:case g.NEAREST_MIPMAP_NEAREST:return V.x.NEAREST_SAMPLINGMODE;default:return V.x.BILINEAR_SAMPLINGMODE}}static GetBufferFromBufferView(e,t,s,n,r){s=t.byteOffset+s;const o=e.loadedBufferViews[t.buffer];if(s+n>o.byteLength)throw new Error("Buffer access is out of range");const a=o.buffer;switch(s+=o.byteOffset,r){case f.BYTE:return new Int8Array(a,s,n);case f.UNSIGNED_BYTE:return new Uint8Array(a,s,n);case f.SHORT:return new Int16Array(a,s,n);case f.UNSIGNED_SHORT:return new Uint16Array(a,s,n);default:return new Float32Array(a,s,n)}}static GetBufferFromAccessor(e,t){const s=e.bufferViews[t.bufferView],n=t.count*Z.GetByteStrideFromType(t);return Z.GetBufferFromBufferView(e,s,t.byteOffset,n,t.componentType)}static DecodeBufferToText(e){let t="";const s=e.byteLength;for(let n=0;n<s;++n)t+=String.fromCharCode(e[n]);return t}static GetDefaultMaterial(e){if(!Z._DefaultMaterial){R.Q.ShadersStore.GLTFDefaultMaterialVertexShader=["precision highp float;","","uniform mat4 worldView;","uniform mat4 projection;","","attribute vec3 position;","","void main(void)","{","    gl_Position = projection * worldView * vec4(position, 1.0);","}"].join("\n"),R.Q.ShadersStore.GLTFDefaultMaterialPixelShader=["precision highp float;","","uniform vec4 u_emission;","","void main(void)","{","    gl_FragColor = u_emission;","}"].join("\n");const t={vertex:"GLTFDefaultMaterial",fragment:"GLTFDefaultMaterial"},s={attributes:["position"],uniforms:["worldView","projection","u_emission"],samplers:new Array,needAlphaBlending:!1};Z._DefaultMaterial=new B.j("GLTFDefaultMaterial",e,t,s),Z._DefaultMaterial.setColor4("u_emission",new C.HE(.5,.5,.5,1))}return Z._DefaultMaterial}}Z._DefaultMaterial=null;var X,J=s(402);!function(e){e[e.IDENTIFIER=1]="IDENTIFIER",e[e.UNKNOWN=2]="UNKNOWN",e[e.END_OF_INPUT=3]="END_OF_INPUT"}(X||(X={}));class Q{constructor(e){this._pos=0,this.currentToken=X.UNKNOWN,this.currentIdentifier="",this.currentString="",this.isLetterOrDigitPattern=/^[a-zA-Z0-9]+$/,this._toParse=e,this._maxPos=e.length}getNextToken(){if(this.isEnd())return X.END_OF_INPUT;if(this.currentString=this.read(),this.currentToken=X.UNKNOWN,"_"===this.currentString||this.isLetterOrDigitPattern.test(this.currentString))for(this.currentToken=X.IDENTIFIER,this.currentIdentifier=this.currentString;!this.isEnd()&&(this.isLetterOrDigitPattern.test(this.currentString=this.peek())||"_"===this.currentString);)this.currentIdentifier+=this.currentString,this.forward();return this.currentToken}peek(){return this._toParse[this._pos]}read(){return this._toParse[this._pos++]}forward(){this._pos++}isEnd(){return this._pos>=this._maxPos}}const ee=["MODEL","VIEW","PROJECTION","MODELVIEW","MODELVIEWPROJECTION","JOINTMATRIX"],te=["world","view","projection","worldView","worldViewProjection","mBones"],se=["translation","rotation","scale"],ne=["position","rotationQuaternion","scaling"],re=(e,t,s)=>{for(const n in e){const r=e[n];s[t][n]=r}},oe=e=>{if(e)for(let t=0;t<e.length/2;t++)e[2*t+1]=1-e[2*t+1]},ae=e=>{if("NORMAL"===e.semantic)return"normal";if("POSITION"===e.semantic)return"position";if("JOINT"===e.semantic)return"matricesIndices";if("WEIGHT"===e.semantic)return"matricesWeights";if("COLOR"===e.semantic)return"color";if(e.semantic&&-1!==e.semantic.indexOf("TEXCOORD_")){const t=Number(e.semantic.split("_")[1]);return"uv"+(0===t?"":t+1)}return null},ie=e=>{let t=null;if(e.translation||e.rotation||e.scale){const s=v.P.FromArray(e.scale||[1,1,1]),n=v._f.FromArray(e.rotation||[0,0,0,1]),r=v.P.FromArray(e.translation||[0,0,0]);t=v.y3.Compose(s,n,r)}else t=v.y3.FromArray(e.matrix);return t},le=(e,t,s,n)=>{for(let e=0;e<n.bones.length;e++)if(n.bones[e].name===s)return n.bones[e];const r=e.nodes;for(const o in r){const a=r[o];if(!a.jointName)continue;const i=a.children;for(let r=0;r<i.length;r++){const l=e.nodes[i[r]];if(l.jointName&&l.jointName===s){const s=ie(a),r=new P.N(a.name||"",n,le(e,t,a.jointName,n),s);return r.id=o,r}}}return null},ce=(e,t)=>{for(let s=0;s<e.length;s++){const n=e[s];for(let e=0;e<n.node.children.length;e++)if(n.node.children[e]===t)return n.bone}return null},he=(e,t)=>{const s=e.nodes;let n=s[t];if(n)return{node:n,id:t};for(const e in s)if(n=s[e],n.jointName===t)return{node:n,id:e};return null},de=(e,t)=>{for(let s=0;s<e.jointNames.length;s++)if(e.jointNames[s]===t)return!0;return!1},ue=(e,t,s,n,r)=>{if(r||(e.scene._blockEntityCollection=!!e.assetContainer,(r=new Y.Kj(t.name||"",e.scene))._parentContainer=e.assetContainer,e.scene._blockEntityCollection=!1,r.id=n),!t.babylonNode)return r;const o=[];let a=null;const i=new Array,l=new Array,c=new Array,h=new Array;for(let t=0;t<s.length;t++){const n=s[t],r=e.meshes[n];if(r)for(let t=0;t<r.primitives.length;t++){const s=new k.x,n=r.primitives[t];n.mode;const d=n.attributes;let u=null,_=null;for(const t in d)if(u=e.accessors[d[t]],_=Z.GetBufferFromAccessor(e,u),"NORMAL"===t)s.normals=new Float32Array(_.length),s.normals.set(_);else if("POSITION"===t){if(w.HomogeneousCoordinates){s.positions=new Float32Array(_.length-_.length/4);for(let e=0;e<_.length;e+=4)s.positions[e]=_[e],s.positions[e+1]=_[e+1],s.positions[e+2]=_[e+2]}else s.positions=new Float32Array(_.length),s.positions.set(_);l.push(s.positions.length)}else if(-1!==t.indexOf("TEXCOORD_")){const e=Number(t.split("_")[1]),n=U.o.UVKind+(0===e?"":e+1),r=new Float32Array(_.length);r.set(_),oe(r),s.set(r,n)}else"JOINT"===t?(s.matricesIndices=new Float32Array(_.length),s.matricesIndices.set(_)):"WEIGHT"===t?(s.matricesWeights=new Float32Array(_.length),s.matricesWeights.set(_)):"COLOR"===t&&(s.colors=new Float32Array(_.length),s.colors.set(_));if(u=e.accessors[n.indices],u)_=Z.GetBufferFromAccessor(e,u),s.indices=new Int32Array(_.length),s.indices.set(_),h.push(s.indices.length);else{const e=[];for(let t=0;t<s.positions.length/3;t++)e.push(t);s.indices=new Int32Array(e),h.push(s.indices.length)}a?a.merge(s):a=s;const m=e.scene.getMaterialById(n.material);o.push(null===m?Z.GetDefaultMaterial(e.scene):m),i.push(0===i.length?0:i[i.length-1]+l[l.length-2]),c.push(0===c.length?0:c[c.length-1]+h[h.length-2])}}let d;e.scene._blockEntityCollection=!!e.assetContainer,o.length>1?(d=new D.G("multimat"+n,e.scene),d.subMaterials=o):d=new $.K("multimat"+n,e.scene),1===o.length&&(d=o[0]),d._parentContainer=e.assetContainer,r.material||(r.material=d),new G.Z(n,e.scene,a,!1,r),r.computeWorldMatrix(!0),e.scene._blockEntityCollection=!1,r.subMeshes=[];let u=0;for(let t=0;t<s.length;t++){const n=s[t],o=e.meshes[n];if(o)for(let e=0;e<o.primitives.length;e++)o.primitives[e].mode,W.P.AddToMesh(u,i[u],l[u],c[u],h[u],r,r,!0),u++}return r},_e=(e,t,s,n)=>{e.position&&(e.position=t),(e.rotationQuaternion||e.rotation)&&(e.rotationQuaternion=s),e.scaling&&(e.scaling=n)},me=(e,t,s)=>{let n=null;if(e.importOnlyMeshes&&(t.skin||t.meshes)&&e.importMeshesNames&&e.importMeshesNames.length>0&&-1===e.importMeshesNames.indexOf(t.name||""))return null;if(t.skin){if(t.meshes){const o=e.skins[t.skin],a=ue(e,t,t.meshes,s,t.babylonNode);a.skeleton=e.scene.getLastSkeletonById(t.skin),null===a.skeleton&&(a.skeleton=((e,t,s,n)=>{if(n||(n=new I.O(t.name||"","",e.scene)),!t.babylonSkeleton)return n;const o=[],a=[];((e,t,s,n)=>{for(const r in e.nodes){const o=e.nodes[r],a=r;if(!o.jointName||de(s,o.jointName))continue;const i=ie(o),l=new P.N(o.name||"",t,null,i);l.id=a,n.push({bone:l,node:o,id:a})}for(let e=0;e<n.length;e++){const t=n[e],s=t.node.children;for(let e=0;e<s.length;e++){let r=null;for(let t=0;t<n.length;t++)if(n[t].id===s[e]){r=n[t];break}r&&(r.bone._parent=t.bone,t.bone.children.push(r.bone))}}})(e,n,t,o),n.bones=[];for(let s=0;s<t.jointNames.length;s++){const i=he(e,t.jointNames[s]);if(!i)continue;const l=i.node;if(!l){r.w1.Warn("Joint named "+t.jointNames[s]+" does not exist");continue}const c=i.id,h=e.scene.getBoneById(c);if(h){n.bones.push(h);continue}let d=!1,u=null;for(let o=0;o<s;o++){const s=he(e,t.jointNames[o]);if(!s)continue;const a=s.node;if(!a){r.w1.Warn("Joint named "+t.jointNames[o]+" does not exist when looking for parent");continue}const i=a.children;if(i){d=!1;for(let s=0;s<i.length;s++)if(i[s]===c){u=le(e,t,t.jointNames[o],n),d=!0;break}if(d)break}}const _=ie(l);!u&&o.length>0&&(u=ce(o,c),u&&-1===a.indexOf(u)&&a.push(u)),new P.N(l.jointName||"",n,u,_).id=c}const i=n.bones;n.bones=[];for(let s=0;s<t.jointNames.length;s++){const r=he(e,t.jointNames[s]);if(r)for(let e=0;e<i.length;e++)if(i[e].id===r.id){n.bones.push(i[e]);break}}n.prepare();for(let e=0;e<a.length;e++)n.bones.push(a[e]);return n})(e,o,0,o.babylonSkeleton),o.babylonSkeleton||(o.babylonSkeleton=a.skeleton)),n=a}}else if(t.meshes)n=ue(e,t,t.mesh?[t.mesh]:t.meshes,s,t.babylonNode);else if(!t.light||t.babylonNode||e.importOnlyMeshes){if(t.camera&&!t.babylonNode&&!e.importOnlyMeshes){const s=e.cameras[t.camera];if(s){if(e.scene._blockEntityCollection=!!e.assetContainer,"orthographic"===s.type){const s=new N.c(t.camera,v.P.Zero(),e.scene,!1);s.name=t.name||"",s.mode=L.V.ORTHOGRAPHIC_CAMERA,s.attachControl(),n=s,s._parentContainer=e.assetContainer}else if("perspective"===s.type){const r=s[s.type],o=new N.c(t.camera,v.P.Zero(),e.scene,!1);o.name=t.name||"",o.attachControl(),r.aspectRatio||(r.aspectRatio=e.scene.getEngine().getRenderWidth()/e.scene.getEngine().getRenderHeight()),r.znear&&r.zfar&&(o.maxZ=r.zfar,o.minZ=r.znear),n=o,o._parentContainer=e.assetContainer}e.scene._blockEntityCollection=!1}}}else{const s=e.lights[t.light];if(s)if("ambient"===s.type){const r=s[s.type],o=new H.e(t.light,v.P.Zero(),e.scene);o.name=t.name||"",r.color&&(o.diffuse=C.Wo.FromArray(r.color)),n=o}else if("directional"===s.type){const r=s[s.type],o=new K.O(t.light,v.P.Zero(),e.scene);o.name=t.name||"",r.color&&(o.diffuse=C.Wo.FromArray(r.color)),n=o}else if("point"===s.type){const r=s[s.type],o=new q.c(t.light,v.P.Zero(),e.scene);o.name=t.name||"",r.color&&(o.diffuse=C.Wo.FromArray(r.color)),n=o}else if("spot"===s.type){const r=s[s.type],o=new z.P(t.light,v.P.Zero(),v.P.Zero(),0,0,e.scene);o.name=t.name||"",r.color&&(o.diffuse=C.Wo.FromArray(r.color)),r.fallOfAngle&&(o.angle=r.fallOfAngle),r.fallOffExponent&&(o.exponent=r.fallOffExponent),n=o}}if(!t.jointName){if(t.babylonNode)return t.babylonNode;if(null===n){e.scene._blockEntityCollection=!!e.assetContainer;const s=new Y.Kj(t.name||"",e.scene);s._parentContainer=e.assetContainer,e.scene._blockEntityCollection=!1,t.babylonNode=s,n=s}}if(null!==n){if(t.matrix&&n instanceof Y.Kj)((e,t)=>{if(t.matrix){const s=new v.P(0,0,0),n=new v._f,r=new v.P(0,0,0);v.y3.FromArray(t.matrix).decompose(r,n,s),_e(e,s,n,r)}else t.translation&&t.rotation&&t.scale&&_e(e,v.P.FromArray(t.translation),v._f.FromArray(t.rotation),v.P.FromArray(t.scale));e.computeWorldMatrix(!0)})(n,t);else{const e=t.translation||[0,0,0],s=t.rotation||[0,0,0,1],r=t.scale||[1,1,1];_e(n,v.P.FromArray(e),v._f.FromArray(s),v.P.FromArray(r))}n.updateCache(!0),t.babylonNode=n}return n},fe=(e,t,s,n=!1)=>{const r=e.nodes[t];let o=null;if(n=!(e.importOnlyMeshes&&!n&&e.importMeshesNames)||-1!==e.importMeshesNames.indexOf(r.name||"")||0===e.importMeshesNames.length,!r.jointName&&n&&(o=me(e,r,t),null!==o&&(o.id=t,o.parent=s)),r.children)for(let t=0;t<r.children.length;t++)fe(e,r.children[t],o,n)},pe=e=>{let t=e.currentScene;if(t)for(let s=0;s<t.nodes.length;s++)fe(e,t.nodes[s],null);else for(const s in e.scenes){t=e.scenes[s];for(let s=0;s<t.nodes.length;s++)fe(e,t.nodes[s],null)}(e=>{for(const t in e.animations){const s=e.animations[t];if(!s.channels||!s.samplers)continue;let n=null;for(let o=0;o<s.channels.length;o++){const a=s.channels[o],i=s.samplers[a.sampler];if(!i)continue;let l=null,c=null;s.parameters?(l=s.parameters[i.input],c=s.parameters[i.output]):(l=i.input,c=i.output);const h=Z.GetBufferFromAccessor(e,e.accessors[l]),d=Z.GetBufferFromAccessor(e,e.accessors[c]),u=a.target.id;let _=e.scene.getNodeById(u);if(null===_&&(_=e.scene.getNodeByName(u)),null===_){r.w1.Warn("Creating animation named "+t+". But cannot find node named "+u+" to attach to");continue}const m=_ instanceof P.N;let f=a.target.path;const p=se.indexOf(f);-1!==p&&(f=ne[p]);let y=S.f.ANIMATIONTYPE_MATRIX;m||("rotationQuaternion"===f?(y=S.f.ANIMATIONTYPE_QUATERNION,_.rotationQuaternion=new v._f):y=S.f.ANIMATIONTYPE_VECTOR3);let A=null;const g=[];let b=0,T=!1;m&&n&&n.getKeys().length===h.length&&(A=n,T=!0),T||(e.scene._blockEntityCollection=!!e.assetContainer,A=new S.f(t,m?"_matrix":f,1,y,S.f.ANIMATIONLOOPMODE_CYCLE),e.scene._blockEntityCollection=!1);for(let e=0;e<h.length;e++){let t=null;if("rotationQuaternion"===f?(t=v._f.FromArray([d[b],d[b+1],d[b+2],d[b+3]]),b+=4):(t=v.P.FromArray([d[b],d[b+1],d[b+2]]),b+=3),m){const s=_;let r=v.P.Zero(),o=new v._f,a=v.P.Zero(),i=s.getBaseMatrix();T&&n&&(i=n.getKeys()[e].value),i.decompose(a,o,r),"position"===f?r=t:"rotationQuaternion"===f?o=t:a=t,t=v.y3.Compose(a,o,r)}T?n&&(n.getKeys()[e].value=t):g.push({frame:h[e],value:t})}!T&&A&&(A.setKeys(g),_.animations.push(A)),n=A,e.scene.stopAnimation(_),e.scene.beginAnimation(_,0,h[h.length-1],!0,1)}}})(e);for(let t=0;t<e.scene.skeletons.length;t++){const s=e.scene.skeletons[t];e.scene.beginAnimation(s,0,Number.MAX_VALUE,!0,1)}},ye=(e,t,s)=>{for(const n in t.uniforms){const r=t.uniforms[n],o=t.parameters[r];if(e.currentIdentifier===n&&o.semantic&&!o.source&&!o.node){const e=ee.indexOf(o.semantic);if(-1!==e)return delete s[n],te[e]}}return e.currentIdentifier},Ae=e=>{for(const t in e.materials)Te.LoadMaterialAsync(e,t,(()=>{}),(()=>{}))};class ge{static CreateRuntime(e,t,s){const n={extensions:{},accessors:{},buffers:{},bufferViews:{},meshes:{},lights:{},cameras:{},nodes:{},images:{},textures:{},shaders:{},programs:{},samplers:{},techniques:{},materials:{},animations:{},skins:{},extensionsUsed:[],scenes:{},buffersCount:0,shaderscount:0,scene:t,rootUrl:s,loadedBufferCount:0,loadedBufferViews:{},loadedShaderCount:0,importOnlyMeshes:!1,dummyNodes:[],assetContainer:null};return e.extensions&&re(e.extensions,"extensions",n),e.extensionsUsed&&re(e.extensionsUsed,"extensionsUsed",n),e.buffers&&((e,t)=>{for(const s in e){const n=e[s];t.buffers[s]=n,t.buffersCount++}})(e.buffers,n),e.bufferViews&&re(e.bufferViews,"bufferViews",n),e.accessors&&re(e.accessors,"accessors",n),e.meshes&&re(e.meshes,"meshes",n),e.lights&&re(e.lights,"lights",n),e.cameras&&re(e.cameras,"cameras",n),e.nodes&&re(e.nodes,"nodes",n),e.images&&re(e.images,"images",n),e.textures&&re(e.textures,"textures",n),e.shaders&&((e,t)=>{for(const s in e){const n=e[s];t.shaders[s]=n,t.shaderscount++}})(e.shaders,n),e.programs&&re(e.programs,"programs",n),e.samplers&&re(e.samplers,"samplers",n),e.techniques&&re(e.techniques,"techniques",n),e.materials&&re(e.materials,"materials",n),e.animations&&re(e.animations,"animations",n),e.skins&&re(e.skins,"skins",n),e.scenes&&(n.scenes=e.scenes),e.scene&&e.scenes&&(n.currentScene=e.scenes[e.scene]),n}static LoadBufferAsync(e,t,s,n,o){const a=e.buffers[t];r.w1.IsBase64(a.uri)?setTimeout((()=>s(new Uint8Array(r.w1.DecodeBase64(a.uri))))):r.w1.LoadFile(e.rootUrl+a.uri,(e=>s(new Uint8Array(e))),o,void 0,!0,(e=>{e&&n(e.status+" "+e.statusText)}))}static LoadTextureBufferAsync(e,t,s,n){const o=e.textures[t];if(!o||!o.source)return void n("");if(o.babylonTexture)return void s(null);const a=e.images[o.source];r.w1.IsBase64(a.uri)?setTimeout((()=>s(new Uint8Array(r.w1.DecodeBase64(a.uri))))):r.w1.LoadFile(e.rootUrl+a.uri,(e=>s(new Uint8Array(e))),void 0,void 0,!0,(e=>{e&&n(e.status+" "+e.statusText)}))}static CreateTextureAsync(e,t,s,n){const r=e.textures[t];if(r.babylonTexture)return void n(r.babylonTexture);const o=e.samplers[r.sampler],a=o.minFilter===g.NEAREST_MIPMAP_NEAREST||o.minFilter===g.NEAREST_MIPMAP_LINEAR||o.minFilter===g.LINEAR_MIPMAP_NEAREST||o.minFilter===g.LINEAR_MIPMAP_LINEAR,i=V.x.BILINEAR_SAMPLINGMODE,l=null==s?new Blob:new Blob([s]),c=URL.createObjectURL(l),h=()=>URL.revokeObjectURL(c),d=new V.x(c,e.scene,!a,!0,i,h,h);void 0!==o.wrapS&&(d.wrapU=Z.GetWrapMode(o.wrapS)),void 0!==o.wrapT&&(d.wrapV=Z.GetWrapMode(o.wrapT)),d.name=t,r.babylonTexture=d,n(d)}static LoadShaderStringAsync(e,t,s,n){const o=e.shaders[t];if(r.w1.IsBase64(o.uri)){const e=atob(o.uri.split(",")[1]);s&&s(e)}else r.w1.LoadFile(e.rootUrl+o.uri,s,void 0,void 0,!1,(e=>{e&&n&&n(e.status+" "+e.statusText)}))}static LoadMaterialAsync(e,t,s,n){const r=e.materials[t];if(!r.technique)return void(n&&n("No technique found."));const o=e.techniques[r.technique];if(!o){e.scene._blockEntityCollection=!!e.assetContainer;const n=new $.K(t,e.scene);return n._parentContainer=e.assetContainer,e.scene._blockEntityCollection=!1,n.diffuseColor=new C.Wo(.5,.5,.5),n.sideOrientation=F.F.CounterClockWiseSideOrientation,void s(n)}const a=e.programs[o.program],i=o.states,l=R.Q.ShadersStore[a.vertexShader+"VertexShader"],c=R.Q.ShadersStore[a.fragmentShader+"PixelShader"];let h="",d="";const u=new Q(l),_=new Q(c),m={},f=[],p=[],A=[];for(const e in o.uniforms){const t=o.uniforms[e],s=o.parameters[t];if(m[e]=s,!s.semantic||s.node||s.source)s.type===y.SAMPLER_2D?A.push(e):f.push(e);else{const t=ee.indexOf(s.semantic);-1!==t?(f.push(te[t]),delete m[e]):f.push(e)}}for(const e in o.attributes){const t=o.attributes[e],s=o.parameters[t];if(s.semantic){const e=ae(s);e&&p.push(e)}}for(;!u.isEnd()&&u.getNextToken();){if(u.currentToken!==X.IDENTIFIER){h+=u.currentString;continue}let e=!1;for(const t in o.attributes){const s=o.attributes[t],n=o.parameters[s];if(u.currentIdentifier===t&&n.semantic){h+=ae(n),e=!0;break}}e||(h+=ye(u,o,m))}for(;!_.isEnd()&&_.getNextToken();)_.currentToken===X.IDENTIFIER?d+=ye(_,o,m):d+=_.currentString;const g={vertex:a.vertexShader+t,fragment:a.fragmentShader+t},b={attributes:p,uniforms:f,samplers:A,needAlphaBlending:i&&i.enable&&-1!==i.enable.indexOf(3042)};R.Q.ShadersStore[a.vertexShader+t+"VertexShader"]=h,R.Q.ShadersStore[a.fragmentShader+t+"PixelShader"]=d;const E=new B.j(t,e.scene,g,b);if(E.onError=((e,t,s)=>(n,r)=>{t.dispose(!0),s("Cannot compile program named "+e.name+". Error: "+r+". Default material will be applied")})(a,E,n),E.onCompiled=((e,t,s,n,r,o)=>a=>{((e,t,s,n,r)=>{const o=n.values||s.parameters,a=s.uniforms;for(const s in r){const i=r[s],l=i.type;let c=o[a[s]];if(void 0===c&&(c=i.value),!c)continue;const h=e=>s=>{i.value&&e&&(t.setTexture(e,s),delete r[e])};l===y.SAMPLER_2D?Te.LoadTextureAsync(e,n.values?c:i.value,h(s),(()=>h(null))):i.value&&Z.SetUniform(t,s,n.values?c:i.value,l)&&delete r[s]}})(e,t,s,n,r),t.onBind=a=>{((e,t,s,n,r,o,a)=>{const i=o.values||r.parameters;for(const a in s){const l=s[a],c=l.type;if(c===y.FLOAT_MAT2||c===y.FLOAT_MAT3||c===y.FLOAT_MAT4)if(!l.semantic||l.source||l.node){if(l.semantic&&(l.source||l.node)){let e=t.scene.getNodeByName(l.source||l.node||"");if(null===e&&(e=t.scene.getNodeById(l.source||l.node||"")),null===e)continue;Z.SetMatrix(t.scene,e,l,a,n.getEffect())}}else Z.SetMatrix(t.scene,e,l,a,n.getEffect());else{const e=i[r.uniforms[a]];if(!e)continue;if(c===y.SAMPLER_2D){const s=t.textures[o.values?e:l.value].babylonTexture;if(null==s)continue;n.getEffect().setTexture(a,s)}else Z.SetUniform(n.getEffect(),a,e,c)}}a(n)})(a,e,r,t,s,n,o)}})(e,E,o,r,m,s),E.sideOrientation=F.F.CounterClockWiseSideOrientation,i&&i.functions){const e=i.functions;e.cullFace&&e.cullFace[0]!==T.BACK&&(E.backFaceCulling=!1);const t=e.blendFuncSeparate;t&&(t[0]===x.SRC_ALPHA&&t[1]===x.ONE_MINUS_SRC_ALPHA&&t[2]===x.ONE&&t[3]===x.ONE?E.alphaMode=J.g.ALPHA_COMBINE:t[0]===x.ONE&&t[1]===x.ONE&&t[2]===x.ZERO&&t[3]===x.ONE?E.alphaMode=J.g.ALPHA_ONEONE:t[0]===x.SRC_ALPHA&&t[1]===x.ONE&&t[2]===x.ZERO&&t[3]===x.ONE?E.alphaMode=J.g.ALPHA_ADD:t[0]===x.ZERO&&t[1]===x.ONE_MINUS_SRC_COLOR&&t[2]===x.ONE&&t[3]===x.ONE?E.alphaMode=J.g.ALPHA_SUBTRACT:t[0]===x.DST_COLOR&&t[1]===x.ZERO&&t[2]===x.ONE&&t[3]===x.ONE?E.alphaMode=J.g.ALPHA_MULTIPLY:t[0]===x.SRC_ALPHA&&t[1]===x.ONE_MINUS_SRC_COLOR&&t[2]===x.ONE&&t[3]===x.ONE&&(E.alphaMode=J.g.ALPHA_MAXIMIZED))}}}class be{static RegisterExtension(e){be.Extensions[e.name]?r.w1.Error('Tool with the same name "'+e.name+'" already exists'):be.Extensions[e.name]=e}dispose(){}_importMeshAsync(e,t,s,n,o,a,i,l){return t.useRightHandedSystem=!0,Te.LoadRuntimeAsync(t,s,n,(t=>{t.assetContainer=o,t.importOnlyMeshes=!0,""===e?t.importMeshesNames=[]:"string"==typeof e?t.importMeshesNames=[e]:!e||e instanceof Array?(t.importMeshesNames=[],r.w1.Warn("Argument meshesNames must be of type string or string[]")):t.importMeshesNames=[e],this._createNodes(t);const s=new Array,n=new Array;for(const e in t.nodes){const n=t.nodes[e];n.babylonNode instanceof j.x&&s.push(n.babylonNode)}for(const e in t.skins){const s=t.skins[e];s.babylonSkeleton instanceof I.O&&n.push(s.babylonSkeleton)}this._loadBuffersAsync(t,(()=>{this._loadShadersAsync(t,(()=>{Ae(t),pe(t),!w.IncrementalLoading&&a&&a(s,n)}))})),w.IncrementalLoading&&a&&a(s,n)}),l),!0}importMeshAsync(e,t,s,n,r,o){return new Promise(((a,i)=>{this._importMeshAsync(e,t,n,r,s,((e,t)=>{a({meshes:e,particleSystems:[],skeletons:t,animationGroups:[],lights:[],transformNodes:[],geometries:[]})}),o,(e=>{i(new Error(e))}))}))}_loadAsync(e,t,s,n,r,o){e.useRightHandedSystem=!0,Te.LoadRuntimeAsync(e,t,s,(e=>{Te.LoadRuntimeExtensionsAsync(e,(()=>{this._createNodes(e),this._loadBuffersAsync(e,(()=>{this._loadShadersAsync(e,(()=>{Ae(e),pe(e),w.IncrementalLoading||n()}))})),w.IncrementalLoading&&n()}),o)}),o)}loadAsync(e,t,s,n){return new Promise(((r,o)=>{this._loadAsync(e,t,s,(()=>{r()}),n,(e=>{o(new Error(e))}))}))}_loadShadersAsync(e,t){let s=!1;const n=(s,n)=>{Te.LoadShaderStringAsync(e,s,(r=>{r instanceof ArrayBuffer||(e.loadedShaderCount++,r&&(R.Q.ShadersStore[s+(n.type===p.VERTEX?"VertexShader":"PixelShader")]=r),e.loadedShaderCount===e.shaderscount&&t())}),(()=>{r.w1.Error("Error when loading shader program named "+s+" located at "+n.uri)}))};for(const t in e.shaders){s=!0;const o=e.shaders[t];o?n.bind(this,t,o)():r.w1.Error("No shader named: "+t)}s||t()}_loadBuffersAsync(e,t){let s=!1;const n=(s,n)=>{Te.LoadBufferAsync(e,s,(o=>{e.loadedBufferCount++,o&&(o.byteLength!=e.buffers[s].byteLength&&r.w1.Error("Buffer named "+s+" is length "+o.byteLength+". Expected: "+n.byteLength),e.loadedBufferViews[s]=o),e.loadedBufferCount===e.buffersCount&&t()}),(()=>{r.w1.Error("Error when loading buffer named "+s+" located at "+n.uri)}))};for(const t in e.buffers){s=!0;const o=e.buffers[t];o?n.bind(this,t,o)():r.w1.Error("No buffer named: "+t)}s||t()}_createNodes(e){let t=e.currentScene;if(t)for(let s=0;s<t.nodes.length;s++)fe(e,t.nodes[s],null);else for(const s in e.scenes){t=e.scenes[s];for(let s=0;s<t.nodes.length;s++)fe(e,t.nodes[s],null)}}}be.Extensions={};class Te{constructor(e){this._name=e}get name(){return this._name}loadRuntimeAsync(e,t,s,n,r){return!1}loadRuntimeExtensionsAsync(e,t,s){return!1}loadBufferAsync(e,t,s,n,r){return!1}loadTextureBufferAsync(e,t,s,n){return!1}createTextureAsync(e,t,s,n,r){return!1}loadShaderStringAsync(e,t,s,n){return!1}loadMaterialAsync(e,t,s,n){return!1}static LoadRuntimeAsync(e,t,s,n,r){Te._ApplyExtensions((o=>o.loadRuntimeAsync(e,t,s,n,r)),(()=>{setTimeout((()=>{n&&n(ge.CreateRuntime(t.json,e,s))}))}))}static LoadRuntimeExtensionsAsync(e,t,s){Te._ApplyExtensions((n=>n.loadRuntimeExtensionsAsync(e,t,s)),(()=>{setTimeout((()=>{t()}))}))}static LoadBufferAsync(e,t,s,n,r){Te._ApplyExtensions((o=>o.loadBufferAsync(e,t,s,n,r)),(()=>{ge.LoadBufferAsync(e,t,s,n,r)}))}static LoadTextureAsync(e,t,s,n){Te._LoadTextureBufferAsync(e,t,(r=>{r&&Te._CreateTextureAsync(e,t,r,s,n)}),n)}static LoadShaderStringAsync(e,t,s,n){Te._ApplyExtensions((r=>r.loadShaderStringAsync(e,t,s,n)),(()=>{ge.LoadShaderStringAsync(e,t,s,n)}))}static LoadMaterialAsync(e,t,s,n){Te._ApplyExtensions((r=>r.loadMaterialAsync(e,t,s,n)),(()=>{ge.LoadMaterialAsync(e,t,s,n)}))}static _LoadTextureBufferAsync(e,t,s,n){Te._ApplyExtensions((r=>r.loadTextureBufferAsync(e,t,s,n)),(()=>{ge.LoadTextureBufferAsync(e,t,s,n)}))}static _CreateTextureAsync(e,t,s,n,r){Te._ApplyExtensions((o=>o.createTextureAsync(e,t,s,n,r)),(()=>{ge.CreateTextureAsync(e,t,s,n)}))}static _ApplyExtensions(e,t){for(const t in be.Extensions)if(e(be.Extensions[t]))return;t()}}w._CreateGLTF1Loader=()=>new be,be.RegisterExtension(new class extends Te{constructor(){super("KHR_binary_glTF")}loadRuntimeAsync(e,t,s,n){const r=t.json.extensionsUsed;return!(!r||-1===r.indexOf(this.name)||!t.bin||(this._bin=t.bin,n(ge.CreateRuntime(t.json,e,s)),0))}loadBufferAsync(e,t,s,n){return-1!==e.extensionsUsed.indexOf(this.name)&&"binary_glTF"===t&&(this._bin.readAsync(0,this._bin.byteLength).then(s,(e=>n(e.message))),!0)}loadTextureBufferAsync(e,t,s){const n=e.textures[t],r=e.images[n.source];if(!r.extensions||!(this.name in r.extensions))return!1;const o=r.extensions[this.name],a=e.bufferViews[o.bufferView];return s(Z.GetBufferFromBufferView(e,a,0,a.byteLength,f.UNSIGNED_BYTE)),!0}loadShaderStringAsync(e,t,s){const n=e.shaders[t];if(!n.extensions||!(this.name in n.extensions))return!1;const r=n.extensions[this.name],o=e.bufferViews[r.bufferView],a=Z.GetBufferFromBufferView(e,o,0,o.byteLength,f.UNSIGNED_BYTE);return setTimeout((()=>{const e=Z.DecodeBufferToText(a);s(e)})),!0}}),be.RegisterExtension(new class extends Te{constructor(){super("KHR_materials_common")}loadRuntimeExtensionsAsync(e){if(!e.extensions)return!1;const t=e.extensions[this.name];if(!t)return!1;const s=t.lights;if(s)for(const t in s){const n=s[t];switch(n.type){case"ambient":{const t=new H.e(n.name,new v.P(0,1,0),e.scene),s=n.ambient;s&&(t.diffuse=C.Wo.FromArray(s.color||[1,1,1]));break}case"point":{const t=new q.c(n.name,new v.P(10,10,10),e.scene),s=n.point;s&&(t.diffuse=C.Wo.FromArray(s.color||[1,1,1]));break}case"directional":{const t=new K.O(n.name,new v.P(0,-1,0),e.scene),s=n.directional;s&&(t.diffuse=C.Wo.FromArray(s.color||[1,1,1]));break}case"spot":{const t=n.spot;t&&(new z.P(n.name,new v.P(0,10,0),new v.P(0,-1,0),t.fallOffAngle||Math.PI,t.fallOffExponent||0,e.scene).diffuse=C.Wo.FromArray(t.color||[1,1,1]));break}default:r.w1.Warn('GLTF Material Common extension: light type "'+n.type+"â€ not supported")}}return!1}loadMaterialAsync(e,t,s,n){const r=e.materials[t];if(!r||!r.extensions)return!1;const o=r.extensions[this.name];if(!o)return!1;const a=new $.K(t,e.scene);return a.sideOrientation=F.F.CounterClockWiseSideOrientation,"CONSTANT"===o.technique&&(a.disableLighting=!0),a.backFaceCulling=void 0!==o.doubleSided&&!o.doubleSided,a.alpha=void 0===o.values.transparency?1:o.values.transparency,a.specularPower=void 0===o.values.shininess?0:o.values.shininess,"string"==typeof o.values.ambient?this._loadTexture(e,o.values.ambient,a,"ambientTexture",n):a.ambientColor=C.Wo.FromArray(o.values.ambient||[0,0,0]),"string"==typeof o.values.diffuse?this._loadTexture(e,o.values.diffuse,a,"diffuseTexture",n):a.diffuseColor=C.Wo.FromArray(o.values.diffuse||[0,0,0]),"string"==typeof o.values.emission?this._loadTexture(e,o.values.emission,a,"emissiveTexture",n):a.emissiveColor=C.Wo.FromArray(o.values.emission||[0,0,0]),"string"==typeof o.values.specular?this._loadTexture(e,o.values.specular,a,"specularTexture",n):a.specularColor=C.Wo.FromArray(o.values.specular||[0,0,0]),!0}_loadTexture(e,t,s,n,r){ge.LoadTextureBufferAsync(e,t,(r=>{ge.CreateTextureAsync(e,t,r,(e=>s[n]=e))}),r)}});var xe=s(5414),Ee=s(4629),Oe=s(5726),Me=s(8331),we=s(4482),ve=s(2590),Ce=s(4150),Le=s(9251);function Ne(e,t,s,n){return v.P.FromArray(t,s).scaleInPlace(n)}class Se{constructor(e,t,s,n){this.type=e,this.name=t,this.getValue=s,this.getStride=n}_buildAnimation(e,t,s){const n=new S.f(e,this.name,t,this.type);return n.setKeys(s),n}}class Pe extends Se{buildAnimations(e,t,s,n,r){r(e._babylonTransformNode,this._buildAnimation(t,s,n))}}const Ie={translation:[new Pe(S.f.ANIMATIONTYPE_VECTOR3,"position",Ne,(()=>3))],rotation:[new Pe(S.f.ANIMATIONTYPE_QUATERNION,"rotationQuaternion",(function(e,t,s,n){return v._f.FromArray(t,s).scaleInPlace(n)}),(()=>4))],scale:[new Pe(S.f.ANIMATIONTYPE_VECTOR3,"scaling",Ne,(()=>3))],weights:[new class extends Se{buildAnimations(e,t,s,n,r){if(e._numMorphTargets)for(let o=0;o<e._numMorphTargets;o++){const a=new S.f(`${t}_${o}`,this.name,s,this.type);if(a.setKeys(n.map((e=>({frame:e.frame,inTangent:e.inTangent?e.inTangent[o]:void 0,value:e.value[o],outTangent:e.outTangent?e.outTangent[o]:void 0,interpolation:e.interpolation})))),e._primitiveBabylonMeshes)for(const t of e._primitiveBabylonMeshes)if(t.morphTargetManager){const e=t.morphTargetManager.getTarget(o),s=a.clone();e.animations.push(s),r(e,s)}}}}(S.f.ANIMATIONTYPE_FLOAT,"influence",(function(e,t,s,n){const r=new Array(e._numMorphTargets);for(let e=0;e<r.length;e++)r[e]=t[s++]*n;return r}),(e=>e._numMorphTargets))]};function Re(...e){const t=e=>e&&"object"==typeof e;return e.reduce(((e,s)=>(Object.keys(s).forEach((n=>{const r=e[n],o=s[n];Array.isArray(r)&&Array.isArray(o)?e[n]=r.concat(...o):t(r)&&t(o)?e[n]=Re(r,o):e[n]=o})),e)),{})}class Fe{static Get(e,t,s){if(!t||null==s||!t[s])throw new Error(`${e}: Failed to find index (${s})`);return t[s]}static Assign(e){if(e)for(let t=0;t<e.length;t++)e[t].index=t}}class De{constructor(e){this._completePromises=new Array,this._assetContainer=null,this._babylonLights=[],this._disableInstancedMesh=0,this._extensions=new Array,this._disposed=!1,this._rootUrl=null,this._fileName=null,this._uniqueRootUrl=null,this._bin=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions=new Array,this._parent=e}static RegisterExtension(e,t){De.UnregisterExtension(e)&&i.Y.Warn(`Extension with the name '${e}' already exists`),De._RegisteredExtensions[e]={factory:t}}static UnregisterExtension(e){return!!De._RegisteredExtensions[e]&&(delete De._RegisteredExtensions[e],!0)}get gltf(){if(!this._gltf)throw new Error("glTF JSON is not available");return this._gltf}get bin(){return this._bin}get parent(){return this._parent}get babylonScene(){if(!this._babylonScene)throw new Error("Scene is not available");return this._babylonScene}get rootBabylonMesh(){return this._rootBabylonMesh}dispose(){this._disposed||(this._disposed=!0,this._completePromises.length=0,this._extensions.forEach((e=>e.dispose&&e.dispose())),this._extensions.length=0,this._gltf=null,this._bin=null,this._babylonScene=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions.length=0,this._parent.dispose())}importMeshAsync(e,t,s,n,r,o,a=""){return Promise.resolve().then((()=>{this._babylonScene=t,this._assetContainer=s,this._loadData(n);let o=null;if(e){const t={};if(this._gltf.nodes)for(const e of this._gltf.nodes)e.name&&(t[e.name]=e.index);o=(e instanceof Array?e:[e]).map((e=>{const s=t[e];if(void 0===s)throw new Error(`Failed to find node '${e}'`);return s}))}return this._loadAsync(r,a,o,(()=>({meshes:this._getMeshes(),particleSystems:[],skeletons:this._getSkeletons(),animationGroups:this._getAnimationGroups(),lights:this._babylonLights,transformNodes:this._getTransformNodes(),geometries:this._getGeometries()})))}))}loadAsync(e,t,s,n,r=""){return Promise.resolve().then((()=>(this._babylonScene=e,this._loadData(t),this._loadAsync(s,r,null,(()=>{})))))}_loadAsync(e,t,s,n){return Promise.resolve().then((()=>{this._rootUrl=e,this._uniqueRootUrl=!e.startsWith("file:")&&t?e:`${e}${Date.now()}/`,this._fileName=t,this._loadExtensions(),this._checkExtensions();const o=`${m[m.LOADING]} => ${m[m.READY]}`,a=`${m[m.LOADING]} => ${m[m.COMPLETE]}`;this._parent._startPerformanceCounter(o),this._parent._startPerformanceCounter(a),this._parent._setState(m.LOADING),this._extensionsOnLoading();const i=new Array,l=this._babylonScene.blockMaterialDirtyMechanism;if(this._babylonScene.blockMaterialDirtyMechanism=!0,!this.parent.loadOnlyMaterials)if(s)i.push(this.loadSceneAsync("/nodes",{nodes:s,index:-1}));else if(null!=this._gltf.scene||this._gltf.scenes&&this._gltf.scenes[0]){const e=Fe.Get("/scene",this._gltf.scenes,this._gltf.scene||0);i.push(this.loadSceneAsync(`/scenes/${e.index}`,e))}if(!this.parent.skipMaterials&&this.parent.loadAllMaterials&&this._gltf.materials)for(let e=0;e<this._gltf.materials.length;++e){const t=this._gltf.materials[e],s="/materials/"+e,n=F.F.TriangleFillMode;i.push(this._loadMaterialAsync(s,t,null,n,(()=>{})))}return this._babylonScene.blockMaterialDirtyMechanism=l,this._parent.compileMaterials&&i.push(this._compileMaterialsAsync()),this._parent.compileShadowGenerators&&i.push(this._compileShadowGeneratorsAsync()),Promise.all(i).then((()=>(this._rootBabylonMesh&&this._rootBabylonMesh.setEnabled(!0),this._extensionsOnReady(),this._parent._setState(m.READY),this._startAnimations(),n()))).then((e=>(this._parent._endPerformanceCounter(o),r.w1.SetImmediate((()=>{this._disposed||Promise.all(this._completePromises).then((()=>{this._parent._endPerformanceCounter(a),this._parent._setState(m.COMPLETE),this._parent.onCompleteObservable.notifyObservers(void 0),this._parent.onCompleteObservable.clear(),this.dispose()}),(e=>{this._parent.onErrorObservable.notifyObservers(e),this._parent.onErrorObservable.clear(),this.dispose()}))})),e)))})).catch((e=>{throw this._disposed||(this._parent.onErrorObservable.notifyObservers(e),this._parent.onErrorObservable.clear(),this.dispose()),e}))}_loadData(e){if(this._gltf=e.json,this._setupData(),e.bin){const t=this._gltf.buffers;if(t&&t[0]&&!t[0].uri){const s=t[0];(s.byteLength<e.bin.byteLength-3||s.byteLength>e.bin.byteLength)&&i.Y.Warn(`Binary buffer length (${s.byteLength}) from JSON does not match chunk length (${e.bin.byteLength})`),this._bin=e.bin}else i.Y.Warn("Unexpected BIN chunk")}}_setupData(){if(Fe.Assign(this._gltf.accessors),Fe.Assign(this._gltf.animations),Fe.Assign(this._gltf.buffers),Fe.Assign(this._gltf.bufferViews),Fe.Assign(this._gltf.cameras),Fe.Assign(this._gltf.images),Fe.Assign(this._gltf.materials),Fe.Assign(this._gltf.meshes),Fe.Assign(this._gltf.nodes),Fe.Assign(this._gltf.samplers),Fe.Assign(this._gltf.scenes),Fe.Assign(this._gltf.skins),Fe.Assign(this._gltf.textures),this._gltf.nodes){const e={};for(const t of this._gltf.nodes)if(t.children)for(const s of t.children)e[s]=t.index;const t=this._createRootNode();for(const s of this._gltf.nodes){const n=e[s.index];s.parent=void 0===n?t:this._gltf.nodes[n]}}}_loadExtensions(){for(const e in De._RegisteredExtensions){const t=De._RegisteredExtensions[e].factory(this);t.name!==e&&i.Y.Warn(`The name of the glTF loader extension instance does not match the registered name: ${t.name} !== ${e}`),this._extensions.push(t),this._parent.onExtensionLoadedObservable.notifyObservers(t)}this._extensions.sort(((e,t)=>(e.order||Number.MAX_VALUE)-(t.order||Number.MAX_VALUE))),this._parent.onExtensionLoadedObservable.clear()}_checkExtensions(){if(this._gltf.extensionsRequired)for(const e of this._gltf.extensionsRequired)if(!this._extensions.some((t=>t.name===e&&t.enabled)))throw new Error(`Require extension ${e} is not available`)}_createRootNode(){this._babylonScene._blockEntityCollection=!!this._assetContainer,this._rootBabylonMesh=new Y.Kj("__root__",this._babylonScene),this._rootBabylonMesh._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._rootBabylonMesh.setEnabled(!1);const e={_babylonTransformNode:this._rootBabylonMesh,index:-1};switch(this._parent.coordinateSystemMode){case u.AUTO:this._babylonScene.useRightHandedSystem||(e.rotation=[0,1,0,0],e.scale=[1,1,-1],De._LoadTransform(e,this._rootBabylonMesh));break;case u.FORCE_RIGHT_HANDED:this._babylonScene.useRightHandedSystem=!0;break;default:throw new Error(`Invalid coordinate system mode (${this._parent.coordinateSystemMode})`)}return this._parent.onMeshLoadedObservable.notifyObservers(this._rootBabylonMesh),e}loadSceneAsync(e,t){const s=this._extensionsLoadSceneAsync(e,t);if(s)return s;const n=new Array;if(this.logOpen(`${e} ${t.name||""}`),t.nodes)for(const s of t.nodes){const t=Fe.Get(`${e}/nodes/${s}`,this._gltf.nodes,s);n.push(this.loadNodeAsync(`/nodes/${t.index}`,t,(e=>{e.parent=this._rootBabylonMesh})))}for(const e of this._postSceneLoadActions)e();return n.push(this._loadAnimationsAsync()),this.logClose(),Promise.all(n).then((()=>{}))}_forEachPrimitive(e,t){if(e._primitiveBabylonMeshes)for(const s of e._primitiveBabylonMeshes)t(s)}_getGeometries(){const e=new Array,t=this._gltf.nodes;if(t)for(const s of t)this._forEachPrimitive(s,(t=>{const s=t.geometry;s&&-1===e.indexOf(s)&&e.push(s)}));return e}_getMeshes(){const e=new Array;this._rootBabylonMesh&&e.push(this._rootBabylonMesh);const t=this._gltf.nodes;if(t)for(const s of t)this._forEachPrimitive(s,(t=>{e.push(t)}));return e}_getTransformNodes(){const e=new Array,t=this._gltf.nodes;if(t)for(const s of t)s._babylonTransformNode&&"TransformNode"===s._babylonTransformNode.getClassName()&&e.push(s._babylonTransformNode),s._babylonTransformNodeForSkin&&e.push(s._babylonTransformNodeForSkin);return e}_getSkeletons(){const e=new Array,t=this._gltf.skins;if(t)for(const s of t)s._data&&e.push(s._data.babylonSkeleton);return e}_getAnimationGroups(){const e=new Array,t=this._gltf.animations;if(t)for(const s of t)s._babylonAnimationGroup&&e.push(s._babylonAnimationGroup);return e}_startAnimations(){switch(this._parent.animationStartMode){case _.NONE:break;case _.FIRST:{const e=this._getAnimationGroups();0!==e.length&&e[0].start(!0);break}case _.ALL:{const e=this._getAnimationGroups();for(const t of e)t.start(!0);break}default:return void i.Y.Error(`Invalid animation start mode (${this._parent.animationStartMode})`)}}loadNodeAsync(e,t,s=(()=>{})){const n=this._extensionsLoadNodeAsync(e,t,s);if(n)return n;if(t._babylonTransformNode)throw new Error(`${e}: Invalid recursive node hierarchy`);const r=new Array;this.logOpen(`${e} ${t.name||""}`);const o=n=>{if(De.AddPointerMetadata(n,e),De._LoadTransform(t,n),null!=t.camera){const s=Fe.Get(`${e}/camera`,this._gltf.cameras,t.camera);r.push(this.loadCameraAsync(`/cameras/${s.index}`,s,(e=>{e.parent=n})))}if(t.children)for(const s of t.children){const t=Fe.Get(`${e}/children/${s}`,this._gltf.nodes,s);r.push(this.loadNodeAsync(`/nodes/${t.index}`,t,(e=>{e.parent=n})))}s(n)};if(null==t.mesh||null!=t.skin){const e=t.name||`node${t.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const s=new we.Y(e,this._babylonScene);s._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,null==t.mesh?t._babylonTransformNode=s:t._babylonTransformNodeForSkin=s,o(s)}if(null!=t.mesh)if(null==t.skin){const s=Fe.Get(`${e}/mesh`,this._gltf.meshes,t.mesh);r.push(this._loadMeshAsync(`/meshes/${s.index}`,t,s,o))}else{const s=Fe.Get(`${e}/mesh`,this._gltf.meshes,t.mesh);r.push(this._loadMeshAsync(`/meshes/${s.index}`,t,s,(s=>{const n=t._babylonTransformNodeForSkin;s.metadata=Re(n.metadata,s.metadata||{});const o=Fe.Get(`${e}/skin`,this._gltf.skins,t.skin);r.push(this._loadSkinAsync(`/skins/${o.index}`,t,o,(e=>{this._forEachPrimitive(t,(t=>{t.skeleton=e})),this._postSceneLoadActions.push((()=>{if(null!=o.skeleton){const e=Fe.Get(`/skins/${o.index}/skeleton`,this._gltf.nodes,o.skeleton).parent;t.index===e.index?s.parent=n.parent:s.parent=e._babylonTransformNode}else s.parent=this._rootBabylonMesh;this._parent.onSkinLoadedObservable.notifyObservers({node:n,skinnedNode:s})}))})))})))}return this.logClose(),Promise.all(r).then((()=>(this._forEachPrimitive(t,(e=>{e.geometry&&e.geometry.useBoundingInfoFromGeometry?e._updateBoundingInfo():e.refreshBoundingInfo(!0)})),t._babylonTransformNode)))}_loadMeshAsync(e,t,s,n){const r=s.primitives;if(!r||!r.length)throw new Error(`${e}: Primitives are missing`);null==r[0].index&&Fe.Assign(r);const o=new Array;this.logOpen(`${e} ${s.name||""}`);const a=t.name||`node${t.index}`;if(1===r.length){const n=s.primitives[0];o.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${n.index}`,a,t,s,n,(e=>{t._babylonTransformNode=e,t._primitiveBabylonMeshes=[e]})))}else{this._babylonScene._blockEntityCollection=!!this._assetContainer,t._babylonTransformNode=new we.Y(a,this._babylonScene),t._babylonTransformNode._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._primitiveBabylonMeshes=[];for(const n of r)o.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${n.index}`,`${a}_primitive${n.index}`,t,s,n,(e=>{e.parent=t._babylonTransformNode,t._primitiveBabylonMeshes.push(e)})))}return n(t._babylonTransformNode),this.logClose(),Promise.all(o).then((()=>t._babylonTransformNode))}_loadMeshPrimitiveAsync(e,t,s,n,r,o){const a=this._extensionsLoadMeshPrimitiveAsync(e,t,s,n,r,o);if(a)return a;this.logOpen(`${e}`);const i=0===this._disableInstancedMesh&&this._parent.createInstances&&null==s.skin&&!n.primitives[0].targets;let l,c;if(i&&r._instanceData)this._babylonScene._blockEntityCollection=!!this._assetContainer,l=r._instanceData.babylonSourceMesh.createInstance(t),l._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,c=r._instanceData.promise;else{const o=new Array;this._babylonScene._blockEntityCollection=!!this._assetContainer;const a=new Y.Kj(t,this._babylonScene);a._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,a.overrideMaterialSideOrientation=this._babylonScene.useRightHandedSystem?F.F.CounterClockWiseSideOrientation:F.F.ClockWiseSideOrientation,this._createMorphTargets(e,s,n,r,a),o.push(this._loadVertexDataAsync(e,r,a).then((t=>this._loadMorphTargetsAsync(e,r,a,t).then((()=>{this._disposed||(this._babylonScene._blockEntityCollection=!!this._assetContainer,t.applyToMesh(a),t._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1)})))));const h=De._GetDrawMode(e,r.mode);if(null==r.material){let e=this._defaultBabylonMaterialData[h];e||(e=this._createDefaultMaterial("__GLTFLoader._default",h),this._parent.onMaterialLoadedObservable.notifyObservers(e),this._defaultBabylonMaterialData[h]=e),a.material=e}else if(!this.parent.skipMaterials){const t=Fe.Get(`${e}/material`,this._gltf.materials,r.material);o.push(this._loadMaterialAsync(`/materials/${t.index}`,t,a,h,(e=>{a.material=e})))}c=Promise.all(o),i&&(r._instanceData={babylonSourceMesh:a,promise:c}),l=a}return De.AddPointerMetadata(l,e),this._parent.onMeshLoadedObservable.notifyObservers(l),o(l),this.logClose(),c.then((()=>l))}_loadVertexDataAsync(e,t,s){const n=this._extensionsLoadVertexDataAsync(e,t,s);if(n)return n;const r=t.attributes;if(!r)throw new Error(`${e}: Attributes are missing`);const o=new Array,a=new G.Z(s.name,this._babylonScene);if(null==t.indices)s.isUnIndexed=!0;else{const s=Fe.Get(`${e}/indices`,this._gltf.accessors,t.indices);o.push(this._loadIndicesAccessorAsync(`/accessors/${s.index}`,s).then((e=>{a.setIndices(e)})))}const i=(t,n,i)=>{if(null==r[t])return;s._delayInfo=s._delayInfo||[],-1===s._delayInfo.indexOf(n)&&s._delayInfo.push(n);const l=Fe.Get(`${e}/attributes/${t}`,this._gltf.accessors,r[t]);o.push(this._loadVertexAccessorAsync(`/accessors/${l.index}`,l,n).then((e=>{if(e.getKind()===U.o.PositionKind&&!this.parent.alwaysComputeBoundingBox&&!s.skeleton){const e=l.min,t=l.max;if(void 0!==e&&void 0!==t){if(l.normalized&&5126!==l.componentType){let s=1;switch(l.componentType){case 5120:s=127;break;case 5121:s=255;break;case 5122:s=32767;break;case 5123:s=65535}for(let n=0;n<3;++n)e[n]=Math.max(e[n]/s,-1),t[n]=Math.max(t[n]/s,-1)}const s=v.jp.Vector3[0],n=v.jp.Vector3[1];s.copyFromFloats(...e),n.copyFromFloats(...t),a._boundingInfo=new Le.j(s,n),a.useBoundingInfoFromGeometry=!0}}a.setVerticesBuffer(e,l.count)}))),n==U.o.MatricesIndicesExtraKind&&(s.numBoneInfluencers=8),i&&i(l)};return i("POSITION",U.o.PositionKind),i("NORMAL",U.o.NormalKind),i("TANGENT",U.o.TangentKind),i("TEXCOORD_0",U.o.UVKind),i("TEXCOORD_1",U.o.UV2Kind),i("TEXCOORD_2",U.o.UV3Kind),i("TEXCOORD_3",U.o.UV4Kind),i("TEXCOORD_4",U.o.UV5Kind),i("TEXCOORD_5",U.o.UV6Kind),i("JOINTS_0",U.o.MatricesIndicesKind),i("WEIGHTS_0",U.o.MatricesWeightsKind),i("JOINTS_1",U.o.MatricesIndicesExtraKind),i("WEIGHTS_1",U.o.MatricesWeightsExtraKind),i("COLOR_0",U.o.ColorKind,(e=>{"VEC4"===e.type&&(s.hasVertexAlpha=!0)})),Promise.all(o).then((()=>a))}_createMorphTargets(e,t,s,n,r){if(!n.targets)return;if(null==t._numMorphTargets)t._numMorphTargets=n.targets.length;else if(n.targets.length!==t._numMorphTargets)throw new Error(`${e}: Primitives do not have the same number of targets`);const o=s.extras?s.extras.targetNames:null;r.morphTargetManager=new Ce.O(r.getScene()),r.morphTargetManager.areUpdatesFrozen=!0;for(let e=0;e<n.targets.length;e++){const n=t.weights?t.weights[e]:s.weights?s.weights[e]:0,a=o?o[e]:`morphTarget${e}`;r.morphTargetManager.addTarget(new ve.Y(a,n,r.getScene()))}}_loadMorphTargetsAsync(e,t,s,n){if(!t.targets)return Promise.resolve();const r=new Array,o=s.morphTargetManager;for(let s=0;s<o.numTargets;s++){const a=o.getTarget(s);r.push(this._loadMorphTargetVertexDataAsync(`${e}/targets/${s}`,n,t.targets[s],a))}return Promise.all(r).then((()=>{o.areUpdatesFrozen=!1}))}_loadMorphTargetVertexDataAsync(e,t,s,n){const r=new Array,o=(n,o,a)=>{if(null==s[n])return;const i=t.getVertexBuffer(o);if(!i)return;const l=Fe.Get(`${e}/${n}`,this._gltf.accessors,s[n]);r.push(this._loadFloatAccessorAsync(`/accessors/${l.index}`,l).then((e=>{a(i,e)})))};return o("POSITION",U.o.PositionKind,((e,t)=>{const s=new Float32Array(t.length);e.forEach(t.length,((e,n)=>{s[n]=t[n]+e})),n.setPositions(s)})),o("NORMAL",U.o.NormalKind,((e,t)=>{const s=new Float32Array(t.length);e.forEach(s.length,((e,n)=>{s[n]=t[n]+e})),n.setNormals(s)})),o("TANGENT",U.o.TangentKind,((e,t)=>{const s=new Float32Array(t.length/3*4);let r=0;e.forEach(t.length/3*4,((e,n)=>{(n+1)%4!=0&&(s[r]=t[r]+e,r++)})),n.setTangents(s)})),Promise.all(r).then((()=>{}))}static _LoadTransform(e,t){if(null!=e.skin)return;let s=v.P.Zero(),n=v._f.Identity(),r=v.P.One();e.matrix?v.y3.FromArray(e.matrix).decompose(r,n,s):(e.translation&&(s=v.P.FromArray(e.translation)),e.rotation&&(n=v._f.FromArray(e.rotation)),e.scale&&(r=v.P.FromArray(e.scale))),t.position=s,t.rotationQuaternion=n,t.scaling=r}_loadSkinAsync(e,t,s,n){const r=this._extensionsLoadSkinAsync(e,t,s);if(r)return r;if(s._data)return n(s._data.babylonSkeleton),s._data.promise;const o=`skeleton${s.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const a=new I.O(s.name||o,o,this._babylonScene);a._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._loadBones(e,s,a);const i=this._loadSkinInverseBindMatricesDataAsync(e,s).then((e=>{this._updateBoneMatrices(a,e)}));return s._data={babylonSkeleton:a,promise:i},n(a),i}_loadBones(e,t,s){if(null==t.skeleton||this._parent.alwaysComputeSkeletonRootNode){const s=this._findSkeletonRootNode(`${e}/joints`,t.joints);if(s)if(void 0===t.skeleton)t.skeleton=s.index;else{const n=(e,t)=>{for(;t.parent;t=t.parent)if(t.parent===e)return!0;return!1},r=Fe.Get(`${e}/skeleton`,this._gltf.nodes,t.skeleton);r===s||n(r,s)||(i.Y.Warn(`${e}/skeleton: Overriding with nearest common ancestor as skeleton node is not a common root`),t.skeleton=s.index)}else i.Y.Warn(`${e}: Failed to find common root`)}const n={};for(const r of t.joints){const o=Fe.Get(`${e}/joints/${r}`,this._gltf.nodes,r);this._loadBone(o,t,s,n)}}_findSkeletonRootNode(e,t){if(0===t.length)return null;const s={};for(const n of t){const t=new Array;let r=Fe.Get(`${e}/${n}`,this._gltf.nodes,n);for(;-1!==r.index;)t.unshift(r),r=r.parent;s[n]=t}let n=null;for(let e=0;;++e){let r=s[t[0]];if(e>=r.length)return n;const o=r[e];for(let a=1;a<t.length;++a)if(r=s[t[a]],e>=r.length||o!==r[e])return n;n=o}}_loadBone(e,t,s,n){let r=n[e.index];if(r)return r;let o=null;e.index!==t.skeleton&&(e.parent&&-1!==e.parent.index?o=this._loadBone(e.parent,t,s,n):void 0!==t.skeleton&&i.Y.Warn(`/skins/${t.index}/skeleton: Skeleton node is not a common root`));const a=t.joints.indexOf(e.index);return r=new P.N(e.name||`joint${e.index}`,s,o,this._getNodeMatrix(e),null,null,a),n[e.index]=r,this._postSceneLoadActions.push((()=>{r.linkTransformNode(e._babylonTransformNode)})),r}_loadSkinInverseBindMatricesDataAsync(e,t){if(null==t.inverseBindMatrices)return Promise.resolve(null);const s=Fe.Get(`${e}/inverseBindMatrices`,this._gltf.accessors,t.inverseBindMatrices);return this._loadFloatAccessorAsync(`/accessors/${s.index}`,s)}_updateBoneMatrices(e,t){for(const s of e.bones){const e=v.y3.Identity(),n=s._index;t&&-1!==n&&(v.y3.FromArrayToRef(t,16*n,e),e.invertToRef(e));const r=s.getParent();r&&e.multiplyToRef(r.getInvertedAbsoluteTransform(),e),s.updateMatrix(e,!1,!1),s._updateDifferenceMatrix(void 0,!1)}}_getNodeMatrix(e){return e.matrix?v.y3.FromArray(e.matrix):v.y3.Compose(e.scale?v.P.FromArray(e.scale):v.P.One(),e.rotation?v._f.FromArray(e.rotation):v._f.Identity(),e.translation?v.P.FromArray(e.translation):v.P.Zero())}loadCameraAsync(e,t,s=(()=>{})){const n=this._extensionsLoadCameraAsync(e,t,s);if(n)return n;const r=new Array;this.logOpen(`${e} ${t.name||""}`),this._babylonScene._blockEntityCollection=!!this._assetContainer;const o=new N.c(t.name||`camera${t.index}`,v.P.Zero(),this._babylonScene,!1);switch(o._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,o.ignoreParentScaling=!0,t._babylonCamera=o,o.rotation=new v.P(0,Math.PI,0),t.type){case"perspective":{const s=t.perspective;if(!s)throw new Error(`${e}: Camera perspective properties are missing`);o.fov=s.yfov,o.minZ=s.znear,o.maxZ=s.zfar||0;break}case"orthographic":if(!t.orthographic)throw new Error(`${e}: Camera orthographic properties are missing`);o.mode=L.V.ORTHOGRAPHIC_CAMERA,o.orthoLeft=-t.orthographic.xmag,o.orthoRight=t.orthographic.xmag,o.orthoBottom=-t.orthographic.ymag,o.orthoTop=t.orthographic.ymag,o.minZ=t.orthographic.znear,o.maxZ=t.orthographic.zfar;break;default:throw new Error(`${e}: Invalid camera type (${t.type})`)}return De.AddPointerMetadata(o,e),this._parent.onCameraLoadedObservable.notifyObservers(o),s(o),this.logClose(),Promise.all(r).then((()=>o))}_loadAnimationsAsync(){const e=this._gltf.animations;if(!e)return Promise.resolve();const t=new Array;for(let s=0;s<e.length;s++){const n=e[s];t.push(this.loadAnimationAsync(`/animations/${n.index}`,n).then((e=>{0===e.targetedAnimations.length&&e.dispose()})))}return Promise.all(t).then((()=>{}))}loadAnimationAsync(e,t){const s=this._extensionsLoadAnimationAsync(e,t);if(s)return s;this._babylonScene._blockEntityCollection=!!this._assetContainer;const n=new Oe.O(t.name||`animation${t.index}`,this._babylonScene);n._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._babylonAnimationGroup=n;const r=new Array;Fe.Assign(t.channels),Fe.Assign(t.samplers);for(const s of t.channels)r.push(this._loadAnimationChannelAsync(`${e}/channels/${s.index}`,e,t,s,((e,t)=>{e.animations=e.animations||[],e.animations.push(t),n.addTargetedAnimation(t,e)})));return Promise.all(r).then((()=>(n.normalize(0),n)))}_loadAnimationChannelAsync(e,t,s,n,r){const o=this._extensionsLoadAnimationChannelAsync(e,t,s,n,r);if(o)return o;if(null==n.target.node)return Promise.resolve();const a=Fe.Get(`${e}/target/node`,this._gltf.nodes,n.target.node);if("weights"===n.target.path&&!a._numMorphTargets||"weights"!==n.target.path&&!a._babylonTransformNode)return Promise.resolve();let i;switch(n.target.path){case"translation":i=Ie.translation;break;case"rotation":i=Ie.rotation;break;case"scale":i=Ie.scale;break;case"weights":i=Ie.weights;break;default:throw new Error(`${e}/target/path: Invalid value (${n.target.path})`)}const l={target:a,properties:i};return this._loadAnimationChannelFromTargetInfoAsync(e,t,s,n,l,r)}_loadAnimationChannelFromTargetInfoAsync(e,t,s,n,r,o){const a=this.parent.targetFps,i=1/a,l=Fe.Get(`${e}/sampler`,s.samplers,n.sampler);return this._loadAnimationSamplerAsync(`${t}/samplers/${n.sampler}`,l).then((e=>{let t=0;for(const l of r.properties){const c=l.getStride(r.target),h=e.input,d=e.output,u=new Array(h.length);let _=0;switch(e.interpolation){case"STEP":for(let e=0;e<h.length;e++){const t=l.getValue(r.target,d,_,1);_+=c,u[e]={frame:h[e]*a,value:t,interpolation:Ee.N.STEP}}break;case"CUBICSPLINE":for(let e=0;e<h.length;e++){const t=l.getValue(r.target,d,_,i);_+=c;const s=l.getValue(r.target,d,_,1);_+=c;const n=l.getValue(r.target,d,_,i);_+=c,u[e]={frame:h[e]*a,inTangent:t,value:s,outTangent:n}}break;case"LINEAR":for(let e=0;e<h.length;e++){const t=l.getValue(r.target,d,_,1);_+=c,u[e]={frame:h[e]*a,value:t}}}if(_>0){const e=`${s.name||`animation${s.index}`}_channel${n.index}_${t}`;l.buildAnimations(r.target,e,a,u,((e,s)=>{++t,o(e,s)}))}}}))}_loadAnimationSamplerAsync(e,t){if(t._data)return t._data;const s=t.interpolation||"LINEAR";switch(s){case"STEP":case"LINEAR":case"CUBICSPLINE":break;default:throw new Error(`${e}/interpolation: Invalid value (${t.interpolation})`)}const n=Fe.Get(`${e}/input`,this._gltf.accessors,t.input),r=Fe.Get(`${e}/output`,this._gltf.accessors,t.output);return t._data=Promise.all([this._loadFloatAccessorAsync(`/accessors/${n.index}`,n),this._loadFloatAccessorAsync(`/accessors/${r.index}`,r)]).then((([e,t])=>({input:e,interpolation:s,output:t}))),t._data}loadBufferAsync(e,t,s,n){const r=this._extensionsLoadBufferAsync(e,t,s,n);if(r)return r;if(!t._data)if(t.uri)t._data=this.loadUriAsync(`${e}/uri`,t,t.uri);else{if(!this._bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);t._data=this._bin.readAsync(0,t.byteLength)}return t._data.then((t=>{try{return new Uint8Array(t.buffer,t.byteOffset+s,n)}catch(t){throw new Error(`${e}: ${t.message}`)}}))}loadBufferViewAsync(e,t){const s=this._extensionsLoadBufferViewAsync(e,t);if(s)return s;if(t._data)return t._data;const n=Fe.Get(`${e}/buffer`,this._gltf.buffers,t.buffer);return t._data=this.loadBufferAsync(`/buffers/${n.index}`,n,t.byteOffset||0,t.byteLength),t._data}_loadAccessorAsync(e,t,s){if(t._data)return t._data;const n=De._GetNumComponents(e,t.type),r=n*U.o.GetTypeByteLength(t.componentType),o=n*t.count;if(null==t.bufferView)t._data=Promise.resolve(new s(o));else{const a=Fe.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${a.index}`,a).then((i=>{if(5126!==t.componentType||t.normalized||a.byteStride&&a.byteStride!==r){const e=new s(o);return U.o.ForEach(i,t.byteOffset||0,a.byteStride||r,n,t.componentType,e.length,t.normalized||!1,((t,s)=>{e[s]=t})),e}return De._GetTypedArray(e,t.componentType,i,t.byteOffset,o)}))}if(t.sparse){const o=t.sparse;t._data=t._data.then((a=>{const i=a,l=Fe.Get(`${e}/sparse/indices/bufferView`,this._gltf.bufferViews,o.indices.bufferView),c=Fe.Get(`${e}/sparse/values/bufferView`,this._gltf.bufferViews,o.values.bufferView);return Promise.all([this.loadBufferViewAsync(`/bufferViews/${l.index}`,l),this.loadBufferViewAsync(`/bufferViews/${c.index}`,c)]).then((([a,l])=>{const c=De._GetTypedArray(`${e}/sparse/indices`,o.indices.componentType,a,o.indices.byteOffset,o.count),h=n*o.count;let d;if(5126!==t.componentType||t.normalized){const a=De._GetTypedArray(`${e}/sparse/values`,t.componentType,l,o.values.byteOffset,h);d=new s(h),U.o.ForEach(a,0,r,n,t.componentType,d.length,t.normalized||!1,((e,t)=>{d[t]=e}))}else d=De._GetTypedArray(`${e}/sparse/values`,t.componentType,l,o.values.byteOffset,h);let u=0;for(let e=0;e<c.length;e++){let t=c[e]*n;for(let e=0;e<n;e++)i[t++]=d[u++]}return i}))}))}return t._data}_loadFloatAccessorAsync(e,t){return this._loadAccessorAsync(e,t,Float32Array)}_loadIndicesAccessorAsync(e,t){if("SCALAR"!==t.type)throw new Error(`${e}/type: Invalid value ${t.type}`);if(5121!==t.componentType&&5123!==t.componentType&&5125!==t.componentType)throw new Error(`${e}/componentType: Invalid value ${t.componentType}`);if(t._data)return t._data;if(t.sparse){const s=De._GetTypedArrayConstructor(`${e}/componentType`,t.componentType);t._data=this._loadAccessorAsync(e,t,s)}else{const s=Fe.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${s.index}`,s).then((s=>De._GetTypedArray(e,t.componentType,s,t.byteOffset,t.count)))}return t._data}_loadVertexBufferViewAsync(e){if(e._babylonBuffer)return e._babylonBuffer;const t=this._babylonScene.getEngine();return e._babylonBuffer=this.loadBufferViewAsync(`/bufferViews/${e.index}`,e).then((e=>new U.l(t,e,!1))),e._babylonBuffer}_loadVertexAccessorAsync(e,t,s){var n;if(null===(n=t._babylonVertexBuffer)||void 0===n?void 0:n[s])return t._babylonVertexBuffer[s];t._babylonVertexBuffer||(t._babylonVertexBuffer={});const r=this._babylonScene.getEngine();if(t.sparse)t._babylonVertexBuffer[s]=this._loadFloatAccessorAsync(e,t).then((e=>new U.o(r,e,s,!1)));else if(s===U.o.MatricesIndicesKind||s===U.o.MatricesIndicesExtraKind)t._babylonVertexBuffer[s]=this._loadFloatAccessorAsync(e,t).then((e=>new U.o(r,e,s,!1)));else{const n=Fe.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._babylonVertexBuffer[s]=this._loadVertexBufferViewAsync(n).then((o=>{const a=De._GetNumComponents(e,t.type);return new U.o(r,o,s,!1,!1,n.byteStride,!1,t.byteOffset,a,t.componentType,t.normalized,!0,1,!0)}))}return t._babylonVertexBuffer[s]}_loadMaterialMetallicRoughnessPropertiesAsync(e,t,s){if(!(s instanceof Me.Y))throw new Error(`${e}: Material type not supported`);const n=new Array;return t&&(t.baseColorFactor?(s.albedoColor=C.Wo.FromArray(t.baseColorFactor),s.alpha=t.baseColorFactor[3]):s.albedoColor=C.Wo.White(),s.metallic=null==t.metallicFactor?1:t.metallicFactor,s.roughness=null==t.roughnessFactor?1:t.roughnessFactor,t.baseColorTexture&&n.push(this.loadTextureInfoAsync(`${e}/baseColorTexture`,t.baseColorTexture,(e=>{e.name=`${s.name} (Base Color)`,s.albedoTexture=e}))),t.metallicRoughnessTexture&&(t.metallicRoughnessTexture.nonColorData=!0,n.push(this.loadTextureInfoAsync(`${e}/metallicRoughnessTexture`,t.metallicRoughnessTexture,(e=>{e.name=`${s.name} (Metallic Roughness)`,s.metallicTexture=e}))),s.useMetallnessFromMetallicTextureBlue=!0,s.useRoughnessFromMetallicTextureGreen=!0,s.useRoughnessFromMetallicTextureAlpha=!1)),Promise.all(n).then((()=>{}))}_loadMaterialAsync(e,t,s,n,r=(()=>{})){const o=this._extensionsLoadMaterialAsync(e,t,s,n,r);if(o)return o;t._data=t._data||{};let a=t._data[n];if(!a){this.logOpen(`${e} ${t.name||""}`);const s=this.createMaterial(e,t,n);a={babylonMaterial:s,babylonMeshes:[],promise:this.loadMaterialPropertiesAsync(e,t,s)},t._data[n]=a,De.AddPointerMetadata(s,e),this._parent.onMaterialLoadedObservable.notifyObservers(s),this.logClose()}return s&&(a.babylonMeshes.push(s),s.onDisposeObservable.addOnce((()=>{const e=a.babylonMeshes.indexOf(s);-1!==e&&a.babylonMeshes.splice(e,1)}))),r(a.babylonMaterial),a.promise.then((()=>a.babylonMaterial))}_createDefaultMaterial(e,t){this._babylonScene._blockEntityCollection=!!this._assetContainer;const s=new Me.Y(e,this._babylonScene);return s._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,s.fillMode=t,s.enableSpecularAntiAliasing=!0,s.useRadianceOverAlpha=!this._parent.transparencyAsCoverage,s.useSpecularOverAlpha=!this._parent.transparencyAsCoverage,s.transparencyMode=Me.Y.PBRMATERIAL_OPAQUE,s.metallic=1,s.roughness=1,s}createMaterial(e,t,s){const n=this._extensionsCreateMaterial(e,t,s);if(n)return n;const r=t.name||`material${t.index}`;return this._createDefaultMaterial(r,s)}loadMaterialPropertiesAsync(e,t,s){const n=this._extensionsLoadMaterialPropertiesAsync(e,t,s);if(n)return n;const r=new Array;return r.push(this.loadMaterialBasePropertiesAsync(e,t,s)),t.pbrMetallicRoughness&&r.push(this._loadMaterialMetallicRoughnessPropertiesAsync(`${e}/pbrMetallicRoughness`,t.pbrMetallicRoughness,s)),this.loadMaterialAlphaProperties(e,t,s),Promise.all(r).then((()=>{}))}loadMaterialBasePropertiesAsync(e,t,s){if(!(s instanceof Me.Y))throw new Error(`${e}: Material type not supported`);const n=new Array;return s.emissiveColor=t.emissiveFactor?C.Wo.FromArray(t.emissiveFactor):new C.Wo(0,0,0),t.doubleSided&&(s.backFaceCulling=!1,s.twoSidedLighting=!0),t.normalTexture&&(t.normalTexture.nonColorData=!0,n.push(this.loadTextureInfoAsync(`${e}/normalTexture`,t.normalTexture,(e=>{e.name=`${s.name} (Normal)`,s.bumpTexture=e}))),s.invertNormalMapX=!this._babylonScene.useRightHandedSystem,s.invertNormalMapY=this._babylonScene.useRightHandedSystem,null!=t.normalTexture.scale&&s.bumpTexture&&(s.bumpTexture.level=t.normalTexture.scale),s.forceIrradianceInFragment=!0),t.occlusionTexture&&(t.occlusionTexture.nonColorData=!0,n.push(this.loadTextureInfoAsync(`${e}/occlusionTexture`,t.occlusionTexture,(e=>{e.name=`${s.name} (Occlusion)`,s.ambientTexture=e}))),s.useAmbientInGrayScale=!0,null!=t.occlusionTexture.strength&&(s.ambientTextureStrength=t.occlusionTexture.strength)),t.emissiveTexture&&n.push(this.loadTextureInfoAsync(`${e}/emissiveTexture`,t.emissiveTexture,(e=>{e.name=`${s.name} (Emissive)`,s.emissiveTexture=e}))),Promise.all(n).then((()=>{}))}loadMaterialAlphaProperties(e,t,s){if(!(s instanceof Me.Y))throw new Error(`${e}: Material type not supported`);switch(t.alphaMode||"OPAQUE"){case"OPAQUE":s.transparencyMode=Me.Y.PBRMATERIAL_OPAQUE;break;case"MASK":s.transparencyMode=Me.Y.PBRMATERIAL_ALPHATEST,s.alphaCutOff=null==t.alphaCutoff?.5:t.alphaCutoff,s.albedoTexture&&(s.albedoTexture.hasAlpha=!0);break;case"BLEND":s.transparencyMode=Me.Y.PBRMATERIAL_ALPHABLEND,s.albedoTexture&&(s.albedoTexture.hasAlpha=!0,s.useAlphaFromAlbedoTexture=!0);break;default:throw new Error(`${e}/alphaMode: Invalid value (${t.alphaMode})`)}}loadTextureInfoAsync(e,t,s=(()=>{})){const n=this._extensionsLoadTextureInfoAsync(e,t,s);if(n)return n;if(this.logOpen(`${e}`),t.texCoord>=6)throw new Error(`${e}/texCoord: Invalid value (${t.texCoord})`);const r=Fe.Get(`${e}/index`,this._gltf.textures,t.index);r._textureInfo=t;const o=this._loadTextureAsync(`/textures/${t.index}`,r,(n=>{n.coordinatesIndex=t.texCoord||0,De.AddPointerMetadata(n,e),this._parent.onTextureLoadedObservable.notifyObservers(n),s(n)}));return this.logClose(),o}_loadTextureAsync(e,t,s=(()=>{})){const n=this._extensionsLoadTextureAsync(e,t,s);if(n)return n;this.logOpen(`${e} ${t.name||""}`);const r=null==t.sampler?De.DefaultSampler:Fe.Get(`${e}/sampler`,this._gltf.samplers,t.sampler),o=Fe.Get(`${e}/source`,this._gltf.images,t.source),a=this._createTextureAsync(e,r,o,s,void 0,!t._textureInfo.nonColorData);return this.logClose(),a}_createTextureAsync(e,t,s,n=(()=>{}),r,o){const a=this._loadSampler(`/samplers/${t.index}`,t),i=new Array,l=new xe.B;this._babylonScene._blockEntityCollection=!!this._assetContainer;const c={noMipmap:a.noMipMaps,invertY:!1,samplingMode:a.samplingMode,onLoad:()=>{this._disposed||l.resolve()},onError:(t,s)=>{this._disposed||l.reject(new Error(`${e}: ${s&&s.message?s.message:t||"Failed to load texture"}`))},mimeType:s.mimeType,loaderOptions:r,useSRGBBuffer:!!o&&this._parent.useSRGBBuffers},h=new V.x(null,this._babylonScene,c);return h._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,i.push(l.promise),i.push(this.loadImageAsync(`/images/${s.index}`,s).then((e=>{const t=s.uri||`${this._fileName}#image${s.index}`,n=`data:${this._uniqueRootUrl}${t}`;h.updateURL(n,e)}))),h.wrapU=a.wrapU,h.wrapV=a.wrapV,n(h),Promise.all(i).then((()=>h))}_loadSampler(e,t){return t._data||(t._data={noMipMaps:9728===t.minFilter||9729===t.minFilter,samplingMode:De._GetTextureSamplingMode(e,t),wrapU:De._GetTextureWrapMode(`${e}/wrapS`,t.wrapS),wrapV:De._GetTextureWrapMode(`${e}/wrapT`,t.wrapT)}),t._data}loadImageAsync(e,t){if(!t._data){if(this.logOpen(`${e} ${t.name||""}`),t.uri)t._data=this.loadUriAsync(`${e}/uri`,t,t.uri);else{const s=Fe.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${s.index}`,s)}this.logClose()}return t._data}loadUriAsync(e,t,s){const n=this._extensionsLoadUriAsync(e,t,s);if(n)return n;if(!De._ValidateUri(s))throw new Error(`${e}: '${s}' is invalid`);if((0,E.VL)(s)){const t=new Uint8Array((0,E.$K)(s));return this.log(`${e}: Decoded ${s.substr(0,64)}... (${t.length} bytes)`),Promise.resolve(t)}return this.log(`${e}: Loading ${s}`),this._parent.preprocessUrlAsync(this._rootUrl+s).then((t=>new Promise(((n,r)=>{this._parent._loadFile(this._babylonScene,t,(t=>{this._disposed||(this.log(`${e}: Loaded ${s} (${t.byteLength} bytes)`),n(new Uint8Array(t)))}),!0,(t=>{r(new E.eh(`${e}: Failed to load '${s}'${t?": "+t.status+" "+t.statusText:""}`,t))}))}))))}static AddPointerMetadata(e,t){const s=e.metadata=e.metadata||{},n=s.gltf=s.gltf||{};(n.pointers=n.pointers||[]).push(t)}static _GetTextureWrapMode(e,t){switch(t=null==t?10497:t){case 33071:return V.x.CLAMP_ADDRESSMODE;case 33648:return V.x.MIRROR_ADDRESSMODE;case 10497:return V.x.WRAP_ADDRESSMODE;default:return i.Y.Warn(`${e}: Invalid value (${t})`),V.x.WRAP_ADDRESSMODE}}static _GetTextureSamplingMode(e,t){const s=null==t.magFilter?9729:t.magFilter,n=null==t.minFilter?9987:t.minFilter;if(9729===s)switch(n){case 9728:return V.x.LINEAR_NEAREST;case 9729:return V.x.LINEAR_LINEAR;case 9984:return V.x.LINEAR_NEAREST_MIPNEAREST;case 9985:return V.x.LINEAR_LINEAR_MIPNEAREST;case 9986:return V.x.LINEAR_NEAREST_MIPLINEAR;case 9987:return V.x.LINEAR_LINEAR_MIPLINEAR;default:return i.Y.Warn(`${e}/minFilter: Invalid value (${n})`),V.x.LINEAR_LINEAR_MIPLINEAR}else switch(9728!==s&&i.Y.Warn(`${e}/magFilter: Invalid value (${s})`),n){case 9728:return V.x.NEAREST_NEAREST;case 9729:return V.x.NEAREST_LINEAR;case 9984:return V.x.NEAREST_NEAREST_MIPNEAREST;case 9985:return V.x.NEAREST_LINEAR_MIPNEAREST;case 9986:return V.x.NEAREST_NEAREST_MIPLINEAR;case 9987:return V.x.NEAREST_LINEAR_MIPLINEAR;default:return i.Y.Warn(`${e}/minFilter: Invalid value (${n})`),V.x.NEAREST_NEAREST_MIPNEAREST}}static _GetTypedArrayConstructor(e,t){switch(t){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:throw new Error(`${e}: Invalid component type ${t}`)}}static _GetTypedArray(e,t,s,n,r){const o=s.buffer;n=s.byteOffset+(n||0);const a=De._GetTypedArrayConstructor(`${e}/componentType`,t),l=U.o.GetTypeByteLength(t);return n%l!=0?(i.Y.Warn(`${e}: Copying buffer as byte offset (${n}) is not a multiple of component type byte length (${l})`),new a(o.slice(n,n+r*l),0)):new a(o,n,r)}static _GetNumComponents(e,t){switch(t){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}throw new Error(`${e}: Invalid type (${t})`)}static _ValidateUri(e){return r.w1.IsBase64(e)||-1===e.indexOf("..")}static _GetDrawMode(e,t){switch(null==t&&(t=4),t){case 0:return F.F.PointListDrawMode;case 1:return F.F.LineListDrawMode;case 2:return F.F.LineLoopDrawMode;case 3:return F.F.LineStripDrawMode;case 4:return F.F.TriangleFillMode;case 5:return F.F.TriangleStripDrawMode;case 6:return F.F.TriangleFanDrawMode}throw new Error(`${e}: Invalid mesh primitive mode (${t})`)}_compileMaterialsAsync(){this._parent._startPerformanceCounter("Compile materials");const e=new Array;if(this._gltf.materials)for(const t of this._gltf.materials)if(t._data)for(const s in t._data){const n=t._data[s];for(const t of n.babylonMeshes){t.computeWorldMatrix(!0);const s=n.babylonMaterial;e.push(s.forceCompilationAsync(t)),e.push(s.forceCompilationAsync(t,{useInstances:!0})),this._parent.useClipPlane&&(e.push(s.forceCompilationAsync(t,{clipPlane:!0})),e.push(s.forceCompilationAsync(t,{clipPlane:!0,useInstances:!0})))}}return Promise.all(e).then((()=>{this._parent._endPerformanceCounter("Compile materials")}))}_compileShadowGeneratorsAsync(){this._parent._startPerformanceCounter("Compile shadow generators");const e=new Array,t=this._babylonScene.lights;for(const s of t){const t=s.getShadowGenerator();t&&e.push(t.forceCompilationAsync())}return Promise.all(e).then((()=>{this._parent._endPerformanceCounter("Compile shadow generators")}))}_forEachExtensions(e){for(const t of this._extensions)t.enabled&&e(t)}_applyExtensions(e,t,s){for(const n of this._extensions)if(n.enabled){const r=`${n.name}.${t}`,o=e;o._activeLoaderExtensionFunctions=o._activeLoaderExtensionFunctions||{};const a=o._activeLoaderExtensionFunctions;if(!a[r]){a[r]=!0;try{const e=s(n);if(e)return e}finally{delete a[r]}}}return null}_extensionsOnLoading(){this._forEachExtensions((e=>e.onLoading&&e.onLoading()))}_extensionsOnReady(){this._forEachExtensions((e=>e.onReady&&e.onReady()))}_extensionsLoadSceneAsync(e,t){return this._applyExtensions(t,"loadScene",(s=>s.loadSceneAsync&&s.loadSceneAsync(e,t)))}_extensionsLoadNodeAsync(e,t,s){return this._applyExtensions(t,"loadNode",(n=>n.loadNodeAsync&&n.loadNodeAsync(e,t,s)))}_extensionsLoadCameraAsync(e,t,s){return this._applyExtensions(t,"loadCamera",(n=>n.loadCameraAsync&&n.loadCameraAsync(e,t,s)))}_extensionsLoadVertexDataAsync(e,t,s){return this._applyExtensions(t,"loadVertexData",(n=>n._loadVertexDataAsync&&n._loadVertexDataAsync(e,t,s)))}_extensionsLoadMeshPrimitiveAsync(e,t,s,n,r,o){return this._applyExtensions(r,"loadMeshPrimitive",(a=>a._loadMeshPrimitiveAsync&&a._loadMeshPrimitiveAsync(e,t,s,n,r,o)))}_extensionsLoadMaterialAsync(e,t,s,n,r){return this._applyExtensions(t,"loadMaterial",(o=>o._loadMaterialAsync&&o._loadMaterialAsync(e,t,s,n,r)))}_extensionsCreateMaterial(e,t,s){return this._applyExtensions(t,"createMaterial",(n=>n.createMaterial&&n.createMaterial(e,t,s)))}_extensionsLoadMaterialPropertiesAsync(e,t,s){return this._applyExtensions(t,"loadMaterialProperties",(n=>n.loadMaterialPropertiesAsync&&n.loadMaterialPropertiesAsync(e,t,s)))}_extensionsLoadTextureInfoAsync(e,t,s){return this._applyExtensions(t,"loadTextureInfo",(n=>n.loadTextureInfoAsync&&n.loadTextureInfoAsync(e,t,s)))}_extensionsLoadTextureAsync(e,t,s){return this._applyExtensions(t,"loadTexture",(n=>n._loadTextureAsync&&n._loadTextureAsync(e,t,s)))}_extensionsLoadAnimationAsync(e,t){return this._applyExtensions(t,"loadAnimation",(s=>s.loadAnimationAsync&&s.loadAnimationAsync(e,t)))}_extensionsLoadAnimationChannelAsync(e,t,s,n,r){return this._applyExtensions(s,"loadAnimationChannel",(o=>o._loadAnimationChannelAsync&&o._loadAnimationChannelAsync(e,t,s,n,r)))}_extensionsLoadSkinAsync(e,t,s){return this._applyExtensions(s,"loadSkin",(n=>n._loadSkinAsync&&n._loadSkinAsync(e,t,s)))}_extensionsLoadUriAsync(e,t,s){return this._applyExtensions(t,"loadUri",(n=>n._loadUriAsync&&n._loadUriAsync(e,t,s)))}_extensionsLoadBufferViewAsync(e,t){return this._applyExtensions(t,"loadBufferView",(s=>s.loadBufferViewAsync&&s.loadBufferViewAsync(e,t)))}_extensionsLoadBufferAsync(e,t,s,n){return this._applyExtensions(t,"loadBuffer",(r=>r.loadBufferAsync&&r.loadBufferAsync(e,t,s,n)))}static LoadExtensionAsync(e,t,s,n){if(!t.extensions)return null;const r=t.extensions[s];return r?n(`${e}/extensions/${s}`,r):null}static LoadExtraAsync(e,t,s,n){if(!t.extras)return null;const r=t.extras[s];return r?n(`${e}/extras/${s}`,r):null}isExtensionUsed(e){return!!this._gltf.extensionsUsed&&-1!==this._gltf.extensionsUsed.indexOf(e)}logOpen(e){this._parent._logOpen(e)}logClose(){this._parent._logClose()}log(e){this._parent._log(e)}startPerformanceCounter(e){this._parent._startPerformanceCounter(e)}endPerformanceCounter(e){this._parent._endPerformanceCounter(e)}}De._RegisteredExtensions={},De.DefaultSampler={index:-1},w._CreateGLTF2Loader=e=>new De(e);var $e=s(1865),Be=s(3375),Ve=s(1011);const ke="EXT_lights_image_based";class Ue{constructor(e){this.name=ke,this._loader=e,this.enabled=this._loader.isExtensionUsed(ke)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights}}loadSceneAsync(e,t){return De.LoadExtensionAsync(e,t,this.name,((s,n)=>{const r=new Array;r.push(this._loader.loadSceneAsync(e,t)),this._loader.logOpen(`${s}`);const o=Fe.Get(`${s}/light`,this._lights,n.light);return r.push(this._loadLightAsync(`/extensions/${this.name}/lights/${n.light}`,o).then((e=>{this._loader.babylonScene.environmentTexture=e}))),this._loader.logClose(),Promise.all(r).then((()=>{}))}))}_loadLightAsync(e,t){if(!t._loaded){const s=new Array;this._loader.logOpen(`${e}`);const n=new Array(t.specularImages.length);for(let r=0;r<t.specularImages.length;r++){const o=t.specularImages[r];n[r]=new Array(o.length);for(let t=0;t<o.length;t++){const a=`${e}/specularImages/${r}/${t}`;this._loader.logOpen(`${a}`);const i=o[t],l=Fe.Get(a,this._loader.gltf.images,i);s.push(this._loader.loadImageAsync(`/images/${i}`,l).then((e=>{n[r][t]=e}))),this._loader.logClose()}}this._loader.logClose(),t._loaded=Promise.all(s).then((()=>{const s=new Ve.N(this._loader.babylonScene,null,t.specularImageSize);if(s.name=t.name||"environment",t._babylonTexture=s,null!=t.intensity&&(s.level=t.intensity),t.rotation){let e=v._f.FromArray(t.rotation);this._loader.babylonScene.useRightHandedSystem||(e=v._f.Inverse(e)),v.y3.FromQuaternionToRef(e,s.getReflectionTextureMatrix())}if(!t.irradianceCoefficients)throw new Error(`${e}: Irradiance coefficients are missing`);const r=Be._.FromArray(t.irradianceCoefficients);r.scaleInPlace(t.intensity),r.convertIrradianceToLambertianRadiance();const o=Be.i.FromHarmonics(r),a=(n.length-1)/$e.R.Log2(t.specularImageSize);return s.updateRGBDAsync(n,o,a)}))}return t._loaded.then((()=>t._babylonTexture))}}De.RegisterExtension(ke,(e=>new Ue(e))),s(7709);const Ge="EXT_mesh_gpu_instancing";class We{constructor(e){this.name=Ge,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ge)}dispose(){this._loader=null}loadNodeAsync(e,t,s){return De.LoadExtensionAsync(e,t,this.name,((e,n)=>{this._loader._disableInstancedMesh++;const r=this._loader.loadNodeAsync(`/nodes/${t.index}`,t,s);if(this._loader._disableInstancedMesh--,!t._primitiveBabylonMeshes)return r;const o=new Array;let a=0;const i=t=>{if(null==n.attributes[t])return void o.push(Promise.resolve(null));const s=Fe.Get(`${e}/attributes/${t}`,this._loader.gltf.accessors,n.attributes[t]);if(o.push(this._loader._loadFloatAccessorAsync(`/accessors/${s.bufferView}`,s)),0===a)a=s.count;else if(a!==s.count)throw new Error(`${e}/attributes: Instance buffer accessors do not have the same count.`)};return i("TRANSLATION"),i("ROTATION"),i("SCALE"),r.then((e=>Promise.all(o).then((([s,n,r])=>{const o=new Float32Array(16*a);v.jp.Vector3[0].copyFromFloats(0,0,0),v.jp.Quaternion[0].copyFromFloats(0,0,0,1),v.jp.Vector3[1].copyFromFloats(1,1,1);for(let e=0;e<a;++e)s&&v.P.FromArrayToRef(s,3*e,v.jp.Vector3[0]),n&&v._f.FromArrayToRef(n,4*e,v.jp.Quaternion[0]),r&&v.P.FromArrayToRef(r,3*e,v.jp.Vector3[1]),v.y3.ComposeToRef(v.jp.Vector3[1],v.jp.Quaternion[0],v.jp.Vector3[0],v.jp.Matrix[0]),v.jp.Matrix[0].copyToArray(o,16*e);for(const e of t._primitiveBabylonMeshes)e.thinInstanceSetBuffer("matrix",o,16,!0);return e}))))}))}}De.RegisterExtension(Ge,(e=>new We(e)));var je=s(3908);const Ye="EXT_meshopt_compression";class He{constructor(e){this.name=Ye,this.enabled=e.isExtensionUsed(Ye),this._loader=e}dispose(){this._loader=null}loadBufferViewAsync(e,t){return De.LoadExtensionAsync(e,t,this.name,((s,n)=>{const r=t;if(r._meshOptData)return r._meshOptData;const o=Fe.Get(`${e}/buffer`,this._loader.gltf.buffers,n.buffer);return r._meshOptData=this._loader.loadBufferAsync(`/buffers/${o.index}`,o,n.byteOffset||0,n.byteLength).then((e=>je.K.Default.decodeGltfBufferAsync(e,n.count,n.byteStride,n.mode,n.filter))),r._meshOptData}))}}De.RegisterExtension(Ye,(e=>new He(e)));const Ke="EXT_texture_webp";class qe{constructor(e){this.name=Ke,this._loader=e,this.enabled=e.isExtensionUsed(Ke)}dispose(){this._loader=null}_loadTextureAsync(e,t,s){return De.LoadExtensionAsync(e,t,this.name,((n,r)=>{const o=null==t.sampler?De.DefaultSampler:Fe.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),a=Fe.Get(`${n}/source`,this._loader.gltf.images,r.source);return this._loader._createTextureAsync(e,o,a,(e=>{s(e)}),void 0,!t._textureInfo.nonColorData)}))}}De.RegisterExtension(Ke,(e=>new qe(e)));var ze=s(7181);const Ze="KHR_draco_mesh_compression";class Xe{constructor(e){this.name=Ze,this._loader=e,this.enabled=ze.J.DecoderAvailable&&this._loader.isExtensionUsed(Ze)}dispose(){delete this.dracoCompression,this._loader=null}_loadVertexDataAsync(e,t,s){return De.LoadExtensionAsync(e,t,this.name,((n,r)=>{if(null!=t.mode){if(5!==t.mode&&4!==t.mode)throw new Error(`${e}: Unsupported mode ${t.mode}`);if(5===t.mode)throw new Error(`${e}: Mode ${t.mode} is not currently supported`)}const o={},a={},i=(n,i)=>{const l=r.attributes[n];if(void 0===l||void 0===t.attributes[n])return;o[i]=l;const c=Fe.Get(`${e}/attributes/${n}`,this._loader.gltf.accessors,t.attributes[n]);if(c.normalized&&5126!==c.componentType){let e=1;switch(c.componentType){case 5120:e=127;break;case 5121:e=255;break;case 5122:e=32767;break;case 5123:e=65535}a[i]=e}s._delayInfo=s._delayInfo||[],-1===s._delayInfo.indexOf(i)&&s._delayInfo.push(i)};i("POSITION",U.o.PositionKind),i("NORMAL",U.o.NormalKind),i("TANGENT",U.o.TangentKind),i("TEXCOORD_0",U.o.UVKind),i("TEXCOORD_1",U.o.UV2Kind),i("TEXCOORD_2",U.o.UV3Kind),i("TEXCOORD_3",U.o.UV4Kind),i("TEXCOORD_4",U.o.UV5Kind),i("TEXCOORD_5",U.o.UV6Kind),i("JOINTS_0",U.o.MatricesIndicesKind),i("WEIGHTS_0",U.o.MatricesWeightsKind),i("COLOR_0",U.o.ColorKind);const l=Fe.Get(n,this._loader.gltf.bufferViews,r.bufferView);return l._dracoBabylonGeometry||(l._dracoBabylonGeometry=this._loader.loadBufferViewAsync(`/bufferViews/${l.index}`,l).then((t=>(this.dracoCompression||ze.J.Default).decodeMeshAsync(t,o,a).then((e=>{const t=new G.Z(s.name,this._loader.babylonScene);return e.applyToGeometry(t),t})).catch((t=>{throw new Error(`${e}: ${t.message}`)}))))),l._dracoBabylonGeometry}))}}De.RegisterExtension(Ze,(e=>new Xe(e)));var Je=s(5046);const Qe="KHR_lights_punctual";class et{constructor(e){this.name=Qe,this._loader=e,this.enabled=this._loader.isExtensionUsed(Qe)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights,Fe.Assign(this._lights)}}loadNodeAsync(e,t,s){return De.LoadExtensionAsync(e,t,this.name,((n,r)=>this._loader.loadNodeAsync(e,t,(e=>{let t;const o=Fe.Get(n,this._lights,r.light),a=o.name||e.name;switch(this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer,o.type){case"directional":t=new K.O(a,v.P.Backward(),this._loader.babylonScene);break;case"point":t=new q.c(a,v.P.Zero(),this._loader.babylonScene);break;case"spot":{const e=new z.P(a,v.P.Zero(),v.P.Backward(),0,1,this._loader.babylonScene);e.angle=2*(o.spot&&o.spot.outerConeAngle||Math.PI/4),e.innerAngle=2*(o.spot&&o.spot.innerConeAngle||0),t=e;break}default:throw this._loader.babylonScene._blockEntityCollection=!1,new Error(`${n}: Invalid light type (${o.type})`)}t._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,o._babylonLight=t,t.falloffType=Je._.FALLOFF_GLTF,t.diffuse=o.color?C.Wo.FromArray(o.color):C.Wo.White(),t.intensity=null==o.intensity?1:o.intensity,t.range=null==o.range?Number.MAX_VALUE:o.range,t.parent=e,this._loader._babylonLights.push(t),De.AddPointerMetadata(t,n),s(e)}))))}}De.RegisterExtension(Qe,(e=>new et(e)));const tt="KHR_materials_pbrSpecularGlossiness";class st{constructor(e){this.name=tt,this.order=200,this._loader=e,this.enabled=this._loader.isExtensionUsed(tt)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return De.LoadExtensionAsync(e,t,this.name,((n,r)=>{const o=new Array;return o.push(this._loader.loadMaterialBasePropertiesAsync(e,t,s)),o.push(this._loadSpecularGlossinessPropertiesAsync(n,t,r,s)),this._loader.loadMaterialAlphaProperties(e,t,s),Promise.all(o).then((()=>{}))}))}_loadSpecularGlossinessPropertiesAsync(e,t,s,n){if(!(n instanceof Me.Y))throw new Error(`${e}: Material type not supported`);const r=new Array;return n.metallic=null,n.roughness=null,s.diffuseFactor?(n.albedoColor=C.Wo.FromArray(s.diffuseFactor),n.alpha=s.diffuseFactor[3]):n.albedoColor=C.Wo.White(),n.reflectivityColor=s.specularFactor?C.Wo.FromArray(s.specularFactor):C.Wo.White(),n.microSurface=null==s.glossinessFactor?1:s.glossinessFactor,s.diffuseTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTexture`,s.diffuseTexture,(e=>{e.name=`${n.name} (Diffuse)`,n.albedoTexture=e}))),s.specularGlossinessTexture&&(r.push(this._loader.loadTextureInfoAsync(`${e}/specularGlossinessTexture`,s.specularGlossinessTexture,(e=>{e.name=`${n.name} (Specular Glossiness)`,n.reflectivityTexture=e,n.reflectivityTexture.hasAlpha=!0}))),n.useMicroSurfaceFromReflectivityMapAlpha=!0),Promise.all(r).then((()=>{}))}}De.RegisterExtension(tt,(e=>new st(e)));const nt="KHR_materials_unlit";class rt{constructor(e){this.name=nt,this.order=210,this._loader=e,this.enabled=this._loader.isExtensionUsed(nt)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return De.LoadExtensionAsync(e,t,this.name,(()=>this._loadUnlitPropertiesAsync(e,t,s)))}_loadUnlitPropertiesAsync(e,t,s){if(!(s instanceof Me.Y))throw new Error(`${e}: Material type not supported`);const n=new Array;s.unlit=!0;const r=t.pbrMetallicRoughness;return r&&(r.baseColorFactor?(s.albedoColor=C.Wo.FromArray(r.baseColorFactor),s.alpha=r.baseColorFactor[3]):s.albedoColor=C.Wo.White(),r.baseColorTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/baseColorTexture`,r.baseColorTexture,(e=>{e.name=`${s.name} (Base Color)`,s.albedoTexture=e})))),t.doubleSided&&(s.backFaceCulling=!1,s.twoSidedLighting=!0),this._loader.loadMaterialAlphaProperties(e,t,s),Promise.all(n).then((()=>{}))}}De.RegisterExtension(nt,(e=>new rt(e)));const ot="KHR_materials_clearcoat";class at{constructor(e){this.name=ot,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(ot)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return De.LoadExtensionAsync(e,t,this.name,((n,r)=>{const o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,s)),o.push(this._loadClearCoatPropertiesAsync(n,r,s)),Promise.all(o).then((()=>{}))}))}_loadClearCoatPropertiesAsync(e,t,s){if(!(s instanceof Me.Y))throw new Error(`${e}: Material type not supported`);const n=new Array;return s.clearCoat.isEnabled=!0,s.clearCoat.useRoughnessFromMainTexture=!1,s.clearCoat.remapF0OnInterfaceChange=!1,null!=t.clearcoatFactor?s.clearCoat.intensity=t.clearcoatFactor:s.clearCoat.intensity=0,t.clearcoatTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatTexture`,t.clearcoatTexture,(e=>{e.name=`${s.name} (ClearCoat Intensity)`,s.clearCoat.texture=e}))),null!=t.clearcoatRoughnessFactor?s.clearCoat.roughness=t.clearcoatRoughnessFactor:s.clearCoat.roughness=0,t.clearcoatRoughnessTexture&&(t.clearcoatRoughnessTexture.nonColorData=!0,n.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatRoughnessTexture`,t.clearcoatRoughnessTexture,(e=>{e.name=`${s.name} (ClearCoat Roughness)`,s.clearCoat.textureRoughness=e})))),t.clearcoatNormalTexture&&(t.clearcoatNormalTexture.nonColorData=!0,n.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatNormalTexture`,t.clearcoatNormalTexture,(e=>{e.name=`${s.name} (ClearCoat Normal)`,s.clearCoat.bumpTexture=e}))),s.invertNormalMapX=!s.getScene().useRightHandedSystem,s.invertNormalMapY=s.getScene().useRightHandedSystem,null!=t.clearcoatNormalTexture.scale&&(s.clearCoat.bumpTexture.level=t.clearcoatNormalTexture.scale)),Promise.all(n).then((()=>{}))}}De.RegisterExtension(ot,(e=>new at(e)));const it="KHR_materials_iridescence";class lt{constructor(e){this.name=it,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(it)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return De.LoadExtensionAsync(e,t,this.name,((n,r)=>{const o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,s)),o.push(this._loadIridescencePropertiesAsync(n,r,s)),Promise.all(o).then((()=>{}))}))}_loadIridescencePropertiesAsync(e,t,s){var n,r,o,a,i;if(!(s instanceof Me.Y))throw new Error(`${e}: Material type not supported`);const l=new Array;return s.iridescence.isEnabled=!0,s.iridescence.intensity=null!==(n=t.iridescenceFactor)&&void 0!==n?n:0,s.iridescence.indexOfRefraction=null!==(o=null!==(r=t.iridescenceIor)&&void 0!==r?r:t.iridescenceIOR)&&void 0!==o?o:1.3,s.iridescence.minimumThickness=null!==(a=t.iridescenceThicknessMinimum)&&void 0!==a?a:100,s.iridescence.maximumThickness=null!==(i=t.iridescenceThicknessMaximum)&&void 0!==i?i:400,t.iridescenceTexture&&l.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceTexture`,t.iridescenceTexture,(e=>{e.name=`${s.name} (Iridescence Intensity)`,s.iridescence.texture=e}))),t.iridescenceThicknessTexture&&l.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceThicknessTexture`,t.iridescenceThicknessTexture,(e=>{e.name=`${s.name} (Iridescence Thickness)`,s.iridescence.thicknessTexture=e}))),Promise.all(l).then((()=>{}))}}De.RegisterExtension(it,(e=>new lt(e)));const ct="KHR_materials_emissive_strength";class ht{constructor(e){this.name=ct,this.order=170,this._loader=e,this.enabled=this._loader.isExtensionUsed(ct)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return De.LoadExtensionAsync(e,t,this.name,((n,r)=>this._loader.loadMaterialPropertiesAsync(e,t,s).then((()=>{this._loadEmissiveProperties(n,r,s)}))))}_loadEmissiveProperties(e,t,s){if(!(s instanceof Me.Y))throw new Error(`${e}: Material type not supported`);void 0!==t.emissiveStrength&&s.emissiveColor.scaleToRef(t.emissiveStrength,s.emissiveColor)}}De.RegisterExtension(ct,(e=>new ht(e)));const dt="KHR_materials_sheen";class ut{constructor(e){this.name=dt,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(dt)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return De.LoadExtensionAsync(e,t,this.name,((n,r)=>{const o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,s)),o.push(this._loadSheenPropertiesAsync(n,r,s)),Promise.all(o).then((()=>{}))}))}_loadSheenPropertiesAsync(e,t,s){if(!(s instanceof Me.Y))throw new Error(`${e}: Material type not supported`);const n=new Array;return s.sheen.isEnabled=!0,s.sheen.intensity=1,null!=t.sheenColorFactor?s.sheen.color=C.Wo.FromArray(t.sheenColorFactor):s.sheen.color=C.Wo.Black(),t.sheenColorTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/sheenColorTexture`,t.sheenColorTexture,(e=>{e.name=`${s.name} (Sheen Color)`,s.sheen.texture=e}))),void 0!==t.sheenRoughnessFactor?s.sheen.roughness=t.sheenRoughnessFactor:s.sheen.roughness=0,t.sheenRoughnessTexture&&(t.sheenRoughnessTexture.nonColorData=!0,n.push(this._loader.loadTextureInfoAsync(`${e}/sheenRoughnessTexture`,t.sheenRoughnessTexture,(e=>{e.name=`${s.name} (Sheen Roughness)`,s.sheen.textureRoughness=e})))),s.sheen.albedoScaling=!0,s.sheen.useRoughnessFromMainTexture=!1,Promise.all(n).then((()=>{}))}}De.RegisterExtension(dt,(e=>new ut(e)));const _t="KHR_materials_specular";class mt{constructor(e){this.name=_t,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(_t)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return De.LoadExtensionAsync(e,t,this.name,((n,r)=>{const o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,s)),o.push(this._loadSpecularPropertiesAsync(n,r,s)),Promise.all(o).then((()=>{}))}))}_loadSpecularPropertiesAsync(e,t,s){if(!(s instanceof Me.Y))throw new Error(`${e}: Material type not supported`);const n=new Array;return void 0!==t.specularFactor&&(s.metallicF0Factor=t.specularFactor),void 0!==t.specularColorFactor&&(s.metallicReflectanceColor=C.Wo.FromArray(t.specularColorFactor)),t.specularTexture&&(t.specularTexture.nonColorData=!0,n.push(this._loader.loadTextureInfoAsync(`${e}/specularTexture`,t.specularTexture,(e=>{e.name=`${s.name} (Specular F0 Strength)`,s.metallicReflectanceTexture=e,s.useOnlyMetallicFromMetallicReflectanceTexture=!0})))),t.specularColorTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/specularColorTexture`,t.specularColorTexture,(e=>{e.name=`${s.name} (Specular F0 Color)`,s.reflectanceTexture=e}))),Promise.all(n).then((()=>{}))}}De.RegisterExtension(_t,(e=>new mt(e)));const ft="KHR_materials_ior";class pt{constructor(e){this.name=ft,this.order=180,this._loader=e,this.enabled=this._loader.isExtensionUsed(ft)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return De.LoadExtensionAsync(e,t,this.name,((n,r)=>{const o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,s)),o.push(this._loadIorPropertiesAsync(n,r,s)),Promise.all(o).then((()=>{}))}))}_loadIorPropertiesAsync(e,t,s){if(!(s instanceof Me.Y))throw new Error(`${e}: Material type not supported`);return void 0!==t.ior?s.indexOfRefraction=t.ior:s.indexOfRefraction=pt._DEFAULT_IOR,Promise.resolve()}}pt._DEFAULT_IOR=1.5,De.RegisterExtension(ft,(e=>new pt(e)));const yt="KHR_materials_variants";class At{constructor(e){this.name=yt,this._loader=e,this.enabled=this._loader.isExtensionUsed(yt)}dispose(){this._loader=null}static GetAvailableVariants(e){const t=this._GetExtensionMetadata(e);return t?Object.keys(t.variants):[]}getAvailableVariants(e){return At.GetAvailableVariants(e)}static SelectVariant(e,t){const s=this._GetExtensionMetadata(e);if(!s)throw new Error("Cannot select variant on a glTF mesh that does not have the KHR_materials_variants extension");const n=e=>{const t=s.variants[e];if(t)for(const e of t)e.mesh.material=e.material};if(t instanceof Array)for(const e of t)n(e);else n(t);s.lastSelected=t}selectVariant(e,t){return At.SelectVariant(e,t)}static Reset(e){const t=this._GetExtensionMetadata(e);if(!t)throw new Error("Cannot reset on a glTF mesh that does not have the KHR_materials_variants extension");for(const e of t.original)e.mesh.material=e.material;t.lastSelected=null}reset(e){return At.Reset(e)}static GetLastSelectedVariant(e){const t=this._GetExtensionMetadata(e);if(!t)throw new Error("Cannot get the last selected variant on a glTF mesh that does not have the KHR_materials_variants extension");return t.lastSelected}getLastSelectedVariant(e){return At.GetLastSelectedVariant(e)}static _GetExtensionMetadata(e){var t,s;return(null===(s=null===(t=null==e?void 0:e.metadata)||void 0===t?void 0:t.gltf)||void 0===s?void 0:s.KHR_materials_variants)||null}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._variants=t.variants}}_loadMeshPrimitiveAsync(e,t,s,n,r,o){return De.LoadExtensionAsync(e,r,this.name,((a,i)=>{const l=new Array;return l.push(this._loader._loadMeshPrimitiveAsync(e,t,s,n,r,(t=>{if(o(t),t instanceof Y.Kj){const s=De._GetDrawMode(e,r.mode),n=this._loader.rootBabylonMesh,o=n?n.metadata=n.metadata||{}:{},c=o.gltf=o.gltf||{},h=c.KHR_materials_variants=c.KHR_materials_variants||{lastSelected:null,original:[],variants:{}};h.original.push({mesh:t,material:t.material});for(let e=0;e<i.mappings.length;++e){const r=i.mappings[e],o=Fe.Get(`${a}/mappings/${e}/material`,this._loader.gltf.materials,r.material);l.push(this._loader._loadMaterialAsync(`#/materials/${r.material}`,o,t,s,(e=>{for(let s=0;s<r.variants.length;++s){const o=r.variants[s],a=Fe.Get(`/extensions/KHR_materials_variants/variants/${o}`,this._variants,o);h.variants[a.name]=h.variants[a.name]||[],h.variants[a.name].push({mesh:t,material:e}),t.onClonedObservable.add((e=>{const s=e;let r=null,o=s;do{if(o=o.parent,!o)return;r=At._GetExtensionMetadata(o)}while(null===r);if(n&&r===At._GetExtensionMetadata(n)){o.metadata={};for(const e in n.metadata)o.metadata[e]=n.metadata[e];o.metadata.gltf=[];for(const e in n.metadata.gltf)o.metadata.gltf[e]=n.metadata.gltf[e];o.metadata.gltf.KHR_materials_variants={lastSelected:null,original:[],variants:{}};for(const e of r.original)o.metadata.gltf.KHR_materials_variants.original.push({mesh:e.mesh,material:e.material});for(const e in r.variants)if(Object.prototype.hasOwnProperty.call(r.variants,e)){o.metadata.gltf.KHR_materials_variants.variants[e]=[];for(const t of r.variants[e])o.metadata.gltf.KHR_materials_variants.variants[e].push({mesh:t.mesh,material:t.material})}r=o.metadata.gltf.KHR_materials_variants}for(const e of r.original)e.mesh===t&&(e.mesh=s);for(const e of r.variants[a.name])e.mesh===t&&(e.mesh=s)}))}})))}}}))),Promise.all(l).then((([e])=>e))}))}}De.RegisterExtension(yt,(e=>new At(e)));var gt=s(3073);class bt{constructor(e,t){this._opaqueRenderTarget=null,this._opaqueMeshesCache=[],this._transparentMeshesCache=[],this._materialObservers={},this._options={...bt._GetDefaultOptions(),...e},this._scene=t,this._scene._transmissionHelper=this,this.onErrorObservable=new n.y$,this._scene.onDisposeObservable.addOnce((()=>{this.dispose()})),this._parseScene(),this._setupRenderTargets()}static _GetDefaultOptions(){return{renderSize:1024,samples:4,lodGenerationScale:1,lodGenerationOffset:-4,renderTargetTextureType:J.g.TEXTURETYPE_HALF_FLOAT,generateMipmaps:!0}}updateOptions(e){if(!Object.keys(e).filter((t=>this._options[t]!==e[t])).length)return;const t={...this._options,...e},s=this._options;this._options=t,t.renderSize===s.renderSize&&t.renderTargetTextureType===s.renderTargetTextureType&&t.generateMipmaps===s.generateMipmaps&&this._opaqueRenderTarget?(this._opaqueRenderTarget.samples=t.samples,this._opaqueRenderTarget.lodGenerationScale=t.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=t.lodGenerationOffset):this._setupRenderTargets()}getOpaqueTarget(){return this._opaqueRenderTarget}_shouldRenderAsTransmission(e){return!!e&&!!(e instanceof Me.Y&&e.subSurface.isRefractionEnabled)}_addMesh(e){this._materialObservers[e.uniqueId]=e.onMaterialChangedObservable.add(this._onMeshMaterialChanged.bind(this)),r.w1.SetImmediate((()=>{this._shouldRenderAsTransmission(e.material)?(e.material.refractionTexture=this._opaqueRenderTarget,this._transparentMeshesCache.push(e)):this._opaqueMeshesCache.push(e)}))}_removeMesh(e){e.onMaterialChangedObservable.remove(this._materialObservers[e.uniqueId]),delete this._materialObservers[e.uniqueId];let t=this._transparentMeshesCache.indexOf(e);-1!==t&&this._transparentMeshesCache.splice(t,1),t=this._opaqueMeshesCache.indexOf(e),-1!==t&&this._opaqueMeshesCache.splice(t,1)}_parseScene(){this._scene.meshes.forEach(this._addMesh.bind(this)),this._scene.onNewMeshAddedObservable.add(this._addMesh.bind(this)),this._scene.onMeshRemovedObservable.add(this._removeMesh.bind(this))}_onMeshMaterialChanged(e){const t=this._transparentMeshesCache.indexOf(e),s=this._opaqueMeshesCache.indexOf(e);this._shouldRenderAsTransmission(e.material)?(e.material instanceof Me.Y&&(e.material.subSurface.refractionTexture=this._opaqueRenderTarget),-1!==s?(this._opaqueMeshesCache.splice(s,1),this._transparentMeshesCache.push(e)):-1===t&&this._transparentMeshesCache.push(e)):-1!==t?(this._transparentMeshesCache.splice(t,1),this._opaqueMeshesCache.push(e)):-1===s&&this._opaqueMeshesCache.push(e)}_setupRenderTargets(){var e,t;let s,n;this._opaqueRenderTarget&&this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=new gt._("opaqueSceneTexture",this._options.renderSize,this._scene,this._options.generateMipmaps,void 0,this._options.renderTargetTextureType),this._opaqueRenderTarget.ignoreCameraViewport=!0,this._opaqueRenderTarget.renderList=this._opaqueMeshesCache,this._opaqueRenderTarget.clearColor=null!==(t=null===(e=this._options.clearColor)||void 0===e?void 0:e.clone())&&void 0!==t?t:this._scene.clearColor.clone(),this._opaqueRenderTarget.gammaSpace=!1,this._opaqueRenderTarget.lodGenerationScale=this._options.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=this._options.lodGenerationOffset,this._opaqueRenderTarget.samples=this._options.samples,this._opaqueRenderTarget.onBeforeBindObservable.add((e=>{n=this._scene.environmentIntensity,this._scene.environmentIntensity=1,s=this._scene.imageProcessingConfiguration.applyByPostProcess,this._options.clearColor?e.clearColor.copyFrom(this._options.clearColor):this._scene.clearColor.toLinearSpaceToRef(e.clearColor),this._scene.imageProcessingConfiguration._applyByPostProcess=!0})),this._opaqueRenderTarget.onAfterUnbindObservable.add((()=>{this._scene.environmentIntensity=n,this._scene.imageProcessingConfiguration._applyByPostProcess=s})),this._transparentMeshesCache.forEach((e=>{this._shouldRenderAsTransmission(e.material)&&(e.material.refractionTexture=this._opaqueRenderTarget)}))}dispose(){this._scene._transmissionHelper=void 0,this._opaqueRenderTarget&&(this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=null),this._transparentMeshesCache=[],this._opaqueMeshesCache=[]}}const Tt="KHR_materials_transmission";class xt{constructor(e){this.name=Tt,this.order=175,this._loader=e,this.enabled=this._loader.isExtensionUsed(Tt),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return De.LoadExtensionAsync(e,t,this.name,((n,r)=>{const o=new Array;return o.push(this._loader.loadMaterialBasePropertiesAsync(e,t,s)),o.push(this._loader.loadMaterialPropertiesAsync(e,t,s)),o.push(this._loadTransparentPropertiesAsync(n,t,s,r)),Promise.all(o).then((()=>{}))}))}_loadTransparentPropertiesAsync(e,t,s,n){if(!(s instanceof Me.Y))throw new Error(`${e}: Material type not supported`);const r=s;if(r.subSurface.isRefractionEnabled=!0,r.subSurface.volumeIndexOfRefraction=1,r.subSurface.useAlbedoToTintRefraction=!0,void 0===n.transmissionFactor)return r.subSurface.refractionIntensity=0,r.subSurface.isRefractionEnabled=!1,Promise.resolve();{r.subSurface.refractionIntensity=n.transmissionFactor;const e=r.getScene();r.subSurface.refractionIntensity&&!e._transmissionHelper&&new bt({},r.getScene())}return r.subSurface.minimumThickness=0,r.subSurface.maximumThickness=0,n.transmissionTexture?(n.transmissionTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/transmissionTexture`,n.transmissionTexture,void 0).then((e=>{r.subSurface.refractionIntensityTexture=e,r.subSurface.useGltfStyleTextures=!0}))):Promise.resolve()}}De.RegisterExtension(Tt,(e=>new xt(e)));const Et="KHR_materials_translucency";class Ot{constructor(e){this.name=Et,this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed(Et),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return De.LoadExtensionAsync(e,t,this.name,((n,r)=>{const o=new Array;return o.push(this._loader.loadMaterialBasePropertiesAsync(e,t,s)),o.push(this._loader.loadMaterialPropertiesAsync(e,t,s)),o.push(this._loadTranslucentPropertiesAsync(n,t,s,r)),Promise.all(o).then((()=>{}))}))}_loadTranslucentPropertiesAsync(e,t,s,n){if(!(s instanceof Me.Y))throw new Error(`${e}: Material type not supported`);const r=s;return r.subSurface.isTranslucencyEnabled=!0,r.subSurface.volumeIndexOfRefraction=1,r.subSurface.minimumThickness=0,r.subSurface.maximumThickness=0,r.subSurface.useAlbedoToTintTranslucency=!0,void 0===n.translucencyFactor?(r.subSurface.translucencyIntensity=0,r.subSurface.isTranslucencyEnabled=!1,Promise.resolve()):(r.subSurface.translucencyIntensity=n.translucencyFactor,n.translucencyTexture?(n.translucencyTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/translucencyTexture`,n.translucencyTexture).then((e=>{r.subSurface.translucencyIntensityTexture=e}))):Promise.resolve())}}De.RegisterExtension(Et,(e=>new Ot(e)));const Mt="KHR_materials_volume";class wt{constructor(e){this.name=Mt,this.order=173,this._loader=e,this.enabled=this._loader.isExtensionUsed(Mt),this.enabled&&this._loader._disableInstancedMesh++}dispose(){this.enabled&&this._loader._disableInstancedMesh--,this._loader=null}loadMaterialPropertiesAsync(e,t,s){return De.LoadExtensionAsync(e,t,this.name,((n,r)=>{const o=new Array;return o.push(this._loader.loadMaterialBasePropertiesAsync(e,t,s)),o.push(this._loader.loadMaterialPropertiesAsync(e,t,s)),o.push(this._loadVolumePropertiesAsync(n,t,s,r)),Promise.all(o).then((()=>{}))}))}_loadVolumePropertiesAsync(e,t,s,n){if(!(s instanceof Me.Y))throw new Error(`${e}: Material type not supported`);if(!s.subSurface.isRefractionEnabled&&!s.subSurface.isTranslucencyEnabled||!n.thicknessFactor)return Promise.resolve();s.subSurface.volumeIndexOfRefraction=s.indexOfRefraction;const r=void 0!==n.attenuationDistance?n.attenuationDistance:Number.MAX_VALUE;return s.subSurface.tintColorAtDistance=r,void 0!==n.attenuationColor&&3==n.attenuationColor.length&&s.subSurface.tintColor.copyFromFloats(n.attenuationColor[0],n.attenuationColor[1],n.attenuationColor[2]),s.subSurface.minimumThickness=0,s.subSurface.maximumThickness=n.thicknessFactor,s.subSurface.useThicknessAsDepth=!0,n.thicknessTexture?(n.thicknessTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/thicknessTexture`,n.thicknessTexture).then((e=>{s.subSurface.thicknessTexture=e,s.subSurface.useGltfStyleTextures=!0}))):Promise.resolve()}}De.RegisterExtension(Mt,(e=>new wt(e)));const vt="KHR_mesh_quantization";class Ct{constructor(e){this.name=vt,this.enabled=e.isExtensionUsed(vt)}dispose(){}}De.RegisterExtension(vt,(e=>new Ct(e)));const Lt="KHR_texture_basisu";class Nt{constructor(e){this.name=Lt,this._loader=e,this.enabled=e.isExtensionUsed(Lt)}dispose(){this._loader=null}_loadTextureAsync(e,t,s){return De.LoadExtensionAsync(e,t,this.name,((n,r)=>{const o=null==t.sampler?De.DefaultSampler:Fe.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),a=Fe.Get(`${n}/source`,this._loader.gltf.images,r.source);return this._loader._createTextureAsync(e,o,a,(e=>{s(e)}),t._textureInfo.nonColorData?{useRGBAIfASTCBC7NotAvailableWhenUASTC:!0}:void 0,!t._textureInfo.nonColorData)}))}}De.RegisterExtension(Lt,(e=>new Nt(e)));const St="KHR_texture_transform";class Pt{constructor(e){this.name=St,this._loader=e,this.enabled=this._loader.isExtensionUsed(St)}dispose(){this._loader=null}loadTextureInfoAsync(e,t,s){return De.LoadExtensionAsync(e,t,this.name,((n,r)=>this._loader.loadTextureInfoAsync(e,t,(e=>{if(!(e instanceof V.x))throw new Error(`${n}: Texture type not supported`);r.offset&&(e.uOffset=r.offset[0],e.vOffset=r.offset[1]),e.uRotationCenter=0,e.vRotationCenter=0,r.rotation&&(e.wAng=-r.rotation),r.scale&&(e.uScale=r.scale[0],e.vScale=r.scale[1]),null!=r.texCoord&&(e.coordinatesIndex=r.texCoord),s(e)}))))}}De.RegisterExtension(St,(e=>new Pt(e)));const It="KHR_xmp_json_ld";class Rt{constructor(e){this.name=It,this.order=100,this._loader=e,this.enabled=this._loader.isExtensionUsed(It)}dispose(){this._loader=null}onLoading(){var e,t,s;if(null===this._loader.rootBabylonMesh)return;const n=null===(e=this._loader.gltf.extensions)||void 0===e?void 0:e.KHR_xmp_json_ld,r=null===(s=null===(t=this._loader.gltf.asset)||void 0===t?void 0:t.extensions)||void 0===s?void 0:s.KHR_xmp_json_ld;if(n&&r){const e=+r.packet;n.packets&&e<n.packets.length&&(this._loader.rootBabylonMesh.metadata=this._loader.rootBabylonMesh.metadata||{},this._loader.rootBabylonMesh.metadata.xmp=n.packets[e])}}}function Ft(e,t,s,n){return C.Wo.FromArray(t,s).scale(n)}function Dt(e,t,s,n){return t[s]*n}function $t(e,t,s,n){return-t[s]*n}function Bt(e,t,s,n){return t[s+1]*n}function Vt(e,t,s,n){return t[s]*n*2}function kt(e){return{scale:[new Gt(S.f.ANIMATIONTYPE_FLOAT,`${e}.uScale`,Dt,(()=>2)),new Gt(S.f.ANIMATIONTYPE_FLOAT,`${e}.vScale`,Bt,(()=>2))],offset:[new Gt(S.f.ANIMATIONTYPE_FLOAT,`${e}.uOffset`,Dt,(()=>2)),new Gt(S.f.ANIMATIONTYPE_FLOAT,`${e}.vOffset`,Bt,(()=>2))],rotation:[new Gt(S.f.ANIMATIONTYPE_FLOAT,`${e}.wAng`,$t,(()=>1))]}}De.RegisterExtension(It,(e=>new Rt(e)));class Ut extends Se{buildAnimations(e,t,s,n,r){r(e._babylonCamera,this._buildAnimation(t,s,n))}}class Gt extends Se{buildAnimations(e,t,s,n,r){for(const o in e._data)r(e._data[o].babylonMaterial,this._buildAnimation(t,s,n))}}class Wt extends Se{buildAnimations(e,t,s,n,r){r(e._babylonLight,this._buildAnimation(t,s,n))}}const jt={__array__:{__target__:!0,...Ie}},Yt={__array__:{__target__:!0,orthographic:{xmag:[new Ut(S.f.ANIMATIONTYPE_FLOAT,"orthoLeft",$t,(()=>1)),new Ut(S.f.ANIMATIONTYPE_FLOAT,"orthoRight",Bt,(()=>1))],ymag:[new Ut(S.f.ANIMATIONTYPE_FLOAT,"orthoBottom",$t,(()=>1)),new Ut(S.f.ANIMATIONTYPE_FLOAT,"orthoTop",Bt,(()=>1))],zfar:[new Ut(S.f.ANIMATIONTYPE_FLOAT,"maxZ",Dt,(()=>1))],znear:[new Ut(S.f.ANIMATIONTYPE_FLOAT,"minZ",Dt,(()=>1))]},perspective:{yfov:[new Ut(S.f.ANIMATIONTYPE_FLOAT,"fov",Dt,(()=>1))],zfar:[new Ut(S.f.ANIMATIONTYPE_FLOAT,"maxZ",Dt,(()=>1))],znear:[new Ut(S.f.ANIMATIONTYPE_FLOAT,"minZ",Dt,(()=>1))]}}},Ht={nodes:jt,materials:{__array__:{__target__:!0,pbrMetallicRoughness:{baseColorFactor:[new Gt(S.f.ANIMATIONTYPE_COLOR3,"albedoColor",Ft,(()=>4)),new Gt(S.f.ANIMATIONTYPE_FLOAT,"alpha",(function(e,t,s,n){return t[s+3]*n}),(()=>4))],metallicFactor:[new Gt(S.f.ANIMATIONTYPE_FLOAT,"metallic",Dt,(()=>1))],roughnessFactor:[new Gt(S.f.ANIMATIONTYPE_FLOAT,"roughness",Dt,(()=>1))],baseColorTexture:{extensions:{KHR_texture_transform:kt("albedoTexture")}}},emissiveFactor:[new Gt(S.f.ANIMATIONTYPE_COLOR3,"emissiveColor",Ft,(()=>3))],normalTexture:{scale:[new Gt(S.f.ANIMATIONTYPE_FLOAT,"bumpTexture.level",Dt,(()=>1))]},occlusionTexture:{strength:[new Gt(S.f.ANIMATIONTYPE_FLOAT,"ambientTextureStrength",Dt,(()=>1))],extensions:{KHR_texture_transform:kt("ambientTexture")}},emissiveTexture:{extensions:{KHR_texture_transform:kt("emissiveTexture")}},extensions:{KHR_materials_ior:{ior:[new Gt(S.f.ANIMATIONTYPE_FLOAT,"indexOfRefraction",Dt,(()=>1))]},KHR_materials_clearcoat:{clearcoatFactor:[new Gt(S.f.ANIMATIONTYPE_FLOAT,"clearCoat.intensity",Dt,(()=>1))],clearcoatRoughnessFactor:[new Gt(S.f.ANIMATIONTYPE_FLOAT,"clearCoat.roughness",Dt,(()=>1))]},KHR_materials_sheen:{sheenColorFactor:[new Gt(S.f.ANIMATIONTYPE_COLOR3,"sheen.color",Ft,(()=>3))],sheenRoughnessFactor:[new Gt(S.f.ANIMATIONTYPE_FLOAT,"sheen.roughness",Dt,(()=>1))]},KHR_materials_specular:{specularFactor:[new Gt(S.f.ANIMATIONTYPE_FLOAT,"metallicF0Factor",Dt,(()=>1))],specularColorFactor:[new Gt(S.f.ANIMATIONTYPE_COLOR3,"metallicReflectanceColor",Ft,(()=>3))]},KHR_materials_emissive_strength:{emissiveStrength:[new Gt(S.f.ANIMATIONTYPE_FLOAT,"emissiveIntensity",Dt,(()=>1))]},KHR_materials_transmission:{transmissionFactor:[new Gt(S.f.ANIMATIONTYPE_FLOAT,"subSurface.refractionIntensity",Dt,(()=>1))]},KHR_materials_volume:{attenuationColor:[new Gt(S.f.ANIMATIONTYPE_COLOR3,"subSurface.tintColor",Ft,(()=>3))],attenuationDistance:[new Gt(S.f.ANIMATIONTYPE_FLOAT,"subSurface.tintColorAtDistance",Dt,(()=>1))],thicknessFactor:[new Gt(S.f.ANIMATIONTYPE_FLOAT,"subSurface.maximumThickness",Dt,(()=>1))]},KHR_materials_iridescence:{iridescenceFactor:[new Gt(S.f.ANIMATIONTYPE_FLOAT,"iridescence.intensity",Dt,(()=>1))],iridescenceIor:[new Gt(S.f.ANIMATIONTYPE_FLOAT,"iridescence.indexOfRefraction",Dt,(()=>1))],iridescenceThicknessMinimum:[new Gt(S.f.ANIMATIONTYPE_FLOAT,"iridescence.minimumThickness",Dt,(()=>1))],iridescenceThicknessMaximum:[new Gt(S.f.ANIMATIONTYPE_FLOAT,"iridescence.maximumThickness",Dt,(()=>1))]}}}},cameras:Yt,extensions:{KHR_lights_punctual:{lights:{__array__:{__target__:!0,color:[new Wt(S.f.ANIMATIONTYPE_COLOR3,"diffuse",Ft,(()=>3))],intensity:[new Wt(S.f.ANIMATIONTYPE_FLOAT,"intensity",Dt,(()=>1))],range:[new Wt(S.f.ANIMATIONTYPE_FLOAT,"range",Dt,(()=>1))],spot:{innerConeAngle:[new Wt(S.f.ANIMATIONTYPE_FLOAT,"innerAngle",Vt,(()=>1))],outerConeAngle:[new Wt(S.f.ANIMATIONTYPE_FLOAT,"angle",Vt,(()=>1))]}}}}}},Kt="KHR_animation_pointer";class qt{constructor(e){this.name=Kt,this._loader=e}get enabled(){return this._loader.isExtensionUsed(Kt)}dispose(){this._loader=null}_loadAnimationChannelAsync(e,t,s,n,r){var o;const a=null===(o=n.target.extensions)||void 0===o?void 0:o.KHR_animation_pointer;if(!a)return null;"pointer"!==n.target.path&&i.Y.Warn(`${e}/target/path: Value (${n.target.path}) must be (pointer) when using the ${this.name} extension`),null!=n.target.node&&i.Y.Warn(`${e}/target/node: Value (${n.target.node}) must not be present when using the ${this.name} extension`);const l=`${e}/extensions/${this.name}`,c=a.pointer;if(!c)throw new Error(`${l}: Pointer is missing`);const h=this._parseAnimationPointer(`${l}/pointer`,c);return h?this._loader._loadAnimationChannelFromTargetInfoAsync(e,t,s,n,h,r):(i.Y.Warn(`${l}/pointer: Invalid pointer (${c}) skipped`),null)}_parseAnimationPointer(e,t){if(!t.startsWith("/"))return i.Y.Warn(`${e}: Value (${t}) must start with a slash`),null;const s=t.split("/");s.shift();let n,r=Ht,o=this._loader.gltf;for(const e of s){if(r.__array__)r=r.__array__;else if(r=r[e],!r)return null;o=o&&o[e],r.__target__&&(n=o)}return n&&Array.isArray(r)?{target:n,properties:r}:null}}De.RegisterExtension(Kt,(e=>new qt(e)));var zt=s(4867),Zt=s(749),Xt=s(3357);const Jt="MSFT_audio_emitter";class Qt{constructor(e){this.name=Jt,this._loader=e,this.enabled=this._loader.isExtensionUsed(Jt)}dispose(){this._loader=null,this._clips=null,this._emitters=null}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._clips=t.clips,this._emitters=t.emitters,Fe.Assign(this._clips),Fe.Assign(this._emitters)}}loadSceneAsync(e,t){return De.LoadExtensionAsync(e,t,this.name,((s,n)=>{const r=new Array;r.push(this._loader.loadSceneAsync(e,t));for(const e of n.emitters){const t=Fe.Get(`${s}/emitters`,this._emitters,e);if(null!=t.refDistance||null!=t.maxDistance||null!=t.rolloffFactor||null!=t.distanceModel||null!=t.innerAngle||null!=t.outerAngle)throw new Error(`${s}: Direction or Distance properties are not allowed on emitters attached to a scene`);r.push(this._loadEmitterAsync(`${s}/emitters/${t.index}`,t))}return Promise.all(r).then((()=>{}))}))}loadNodeAsync(e,t,s){return De.LoadExtensionAsync(e,t,this.name,((e,n)=>{const o=new Array;return this._loader.loadNodeAsync(e,t,(t=>{for(const s of n.emitters){const n=Fe.Get(`${e}/emitters`,this._emitters,s);o.push(this._loadEmitterAsync(`${e}/emitters/${n.index}`,n).then((()=>{for(const e of n._babylonSounds)e.attachToMesh(t),null==n.innerAngle&&null==n.outerAngle||(e.setLocalDirectionToMesh(v.P.Forward()),e.setDirectionalCone(2*r.w1.ToDegrees(null==n.innerAngle?Math.PI:n.innerAngle),2*r.w1.ToDegrees(null==n.outerAngle?Math.PI:n.outerAngle),0))})))}s(t)})).then((e=>Promise.all(o).then((()=>e))))}))}loadAnimationAsync(e,t){return De.LoadExtensionAsync(e,t,this.name,((s,n)=>this._loader.loadAnimationAsync(e,t).then((r=>{const o=new Array;Fe.Assign(n.events);for(const a of n.events)o.push(this._loadAnimationEventAsync(`${s}/events/${a.index}`,e,t,a,r));return Promise.all(o).then((()=>r))}))))}_loadClipAsync(e,t){if(t._objectURL)return t._objectURL;let s;if(t.uri)s=this._loader.loadUriAsync(e,t,t.uri);else{const n=Fe.Get(`${e}/bufferView`,this._loader.gltf.bufferViews,t.bufferView);s=this._loader.loadBufferViewAsync(`/bufferViews/${n.index}`,n)}return t._objectURL=s.then((e=>URL.createObjectURL(new Blob([e],{type:t.mimeType})))),t._objectURL}_loadEmitterAsync(e,t){if(t._babylonSounds=t._babylonSounds||[],!t._babylonData){const e=new Array,s=t.name||`emitter${t.index}`,n={loop:!1,autoplay:!1,volume:null==t.volume?1:t.volume};for(let r=0;r<t.clips.length;r++){const o=`/extensions/${this.name}/clips`,a=Fe.Get(o,this._clips,t.clips[r].clip);e.push(this._loadClipAsync(`${o}/${t.clips[r].clip}`,a).then((e=>{const o=t._babylonSounds[r]=new Zt.$(s,e,this._loader.babylonScene,null,n);o.refDistance=t.refDistance||1,o.maxDistance=t.maxDistance||256,o.rolloffFactor=t.rolloffFactor||1,o.distanceModel=t.distanceModel||"exponential"})))}const o=Promise.all(e).then((()=>{const e=t.clips.map((e=>e.weight||1)),s=new Xt.s(t.loop||!1,t._babylonSounds,e);t.innerAngle&&(s.directionalConeInnerAngle=2*r.w1.ToDegrees(t.innerAngle)),t.outerAngle&&(s.directionalConeOuterAngle=2*r.w1.ToDegrees(t.outerAngle)),t.volume&&(s.volume=t.volume),t._babylonData.sound=s}));t._babylonData={loaded:o}}return t._babylonData.loaded}_getEventAction(e,t,s,n,r){switch(s){case"play":return e=>{const s=(r||0)+(e-n);t.play(s)};case"stop":return()=>{t.stop()};case"pause":return()=>{t.pause()};default:throw new Error(`${e}: Unsupported action ${s}`)}}_loadAnimationEventAsync(e,t,s,n,r){if(0==r.targetedAnimations.length)return Promise.resolve();const o=r.targetedAnimations[0],a=n.emitter,i=Fe.Get(`/extensions/${this.name}/emitters`,this._emitters,a);return this._loadEmitterAsync(e,i).then((()=>{const t=i._babylonData.sound;if(t){const s=new zt.O(n.time,this._getEventAction(e,t,n.action,n.time,n.startOffset));o.animation.addEvent(s),r.onAnimationGroupEndObservable.add((()=>{t.stop()})),r.onAnimationGroupPauseObservable.add((()=>{t.pause()}))}}))}}De.RegisterExtension(Jt,(e=>new Qt(e)));const es="MSFT_lod";class ts{constructor(e){this.name=es,this.order=100,this.maxLODsToLoad=10,this.onNodeLODsLoadedObservable=new n.y$,this.onMaterialLODsLoadedObservable=new n.y$,this._bufferLODs=new Array,this._nodeIndexLOD=null,this._nodeSignalLODs=new Array,this._nodePromiseLODs=new Array,this._nodeBufferLODs=new Array,this._materialIndexLOD=null,this._materialSignalLODs=new Array,this._materialPromiseLODs=new Array,this._materialBufferLODs=new Array,this._loader=e,this.enabled=this._loader.isExtensionUsed(es)}dispose(){this._loader=null,this._nodeIndexLOD=null,this._nodeSignalLODs.length=0,this._nodePromiseLODs.length=0,this._nodeBufferLODs.length=0,this._materialIndexLOD=null,this._materialSignalLODs.length=0,this._materialPromiseLODs.length=0,this._materialBufferLODs.length=0,this.onMaterialLODsLoadedObservable.clear(),this.onNodeLODsLoadedObservable.clear()}onReady(){for(let e=0;e<this._nodePromiseLODs.length;e++){const t=Promise.all(this._nodePromiseLODs[e]).then((()=>{0!==e&&(this._loader.endPerformanceCounter(`Node LOD ${e}`),this._loader.log(`Loaded node LOD ${e}`)),this.onNodeLODsLoadedObservable.notifyObservers(e),e!==this._nodePromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Node LOD ${e+1}`),this._loadBufferLOD(this._nodeBufferLODs,e+1),this._nodeSignalLODs[e]&&this._nodeSignalLODs[e].resolve())}));this._loader._completePromises.push(t)}for(let e=0;e<this._materialPromiseLODs.length;e++){const t=Promise.all(this._materialPromiseLODs[e]).then((()=>{0!==e&&(this._loader.endPerformanceCounter(`Material LOD ${e}`),this._loader.log(`Loaded material LOD ${e}`)),this.onMaterialLODsLoadedObservable.notifyObservers(e),e!==this._materialPromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Material LOD ${e+1}`),this._loadBufferLOD(this._materialBufferLODs,e+1),this._materialSignalLODs[e]&&this._materialSignalLODs[e].resolve())}));this._loader._completePromises.push(t)}}loadSceneAsync(e,t){const s=this._loader.loadSceneAsync(e,t);return this._loadBufferLOD(this._bufferLODs,0),s}loadNodeAsync(e,t,s){return De.LoadExtensionAsync(e,t,this.name,((e,n)=>{let r;const o=this._getLODs(e,t,this._loader.gltf.nodes,n.ids);this._loader.logOpen(`${e}`);for(let e=0;e<o.length;e++){const t=o[e];0!==e&&(this._nodeIndexLOD=e,this._nodeSignalLODs[e]=this._nodeSignalLODs[e]||new xe.B);const n=e=>{s(e),e.setEnabled(!1)},a=this._loader.loadNodeAsync(`/nodes/${t.index}`,t,n).then((t=>{if(0!==e){const t=o[e-1];t._babylonTransformNode&&(this._disposeTransformNode(t._babylonTransformNode),delete t._babylonTransformNode)}return t.setEnabled(!0),t}));this._nodePromiseLODs[e]=this._nodePromiseLODs[e]||[],0===e?r=a:(this._nodeIndexLOD=null,this._nodePromiseLODs[e].push(a))}return this._loader.logClose(),r}))}_loadMaterialAsync(e,t,s,n,r){return this._nodeIndexLOD?null:De.LoadExtensionAsync(e,t,this.name,((e,o)=>{let a;const i=this._getLODs(e,t,this._loader.gltf.materials,o.ids);this._loader.logOpen(`${e}`);for(let e=0;e<i.length;e++){const t=i[e];0!==e&&(this._materialIndexLOD=e);const o=this._loader._loadMaterialAsync(`/materials/${t.index}`,t,s,n,(t=>{0===e&&r(t)})).then((t=>{if(0!==e){r(t);const s=i[e-1]._data;s[n]&&(this._disposeMaterials([s[n].babylonMaterial]),delete s[n])}return t}));this._materialPromiseLODs[e]=this._materialPromiseLODs[e]||[],0===e?a=o:(this._materialIndexLOD=null,this._materialPromiseLODs[e].push(o))}return this._loader.logClose(),a}))}_loadUriAsync(e,t,s){if(null!==this._nodeIndexLOD){this._loader.log("deferred");const n=this._nodeIndexLOD-1;return this._nodeSignalLODs[n]=this._nodeSignalLODs[n]||new xe.B,this._nodeSignalLODs[this._nodeIndexLOD-1].promise.then((()=>this._loader.loadUriAsync(e,t,s)))}if(null!==this._materialIndexLOD){this._loader.log("deferred");const n=this._materialIndexLOD-1;return this._materialSignalLODs[n]=this._materialSignalLODs[n]||new xe.B,this._materialSignalLODs[n].promise.then((()=>this._loader.loadUriAsync(e,t,s)))}return null}loadBufferAsync(e,t,s,n){if(this._loader.parent.useRangeRequests&&!t.uri){if(!this._loader.bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);const t=(e,t)=>{const r=s,o=r+n-1;let a=e[t];return a?(a.start=Math.min(a.start,r),a.end=Math.max(a.end,o)):(a={start:r,end:o,loaded:new xe.B},e[t]=a),a.loaded.promise.then((e=>new Uint8Array(e.buffer,e.byteOffset+s-a.start,n)))};return this._loader.log("deferred"),null!==this._nodeIndexLOD?t(this._nodeBufferLODs,this._nodeIndexLOD):null!==this._materialIndexLOD?t(this._materialBufferLODs,this._materialIndexLOD):t(this._bufferLODs,0)}return null}_loadBufferLOD(e,t){const s=e[t];s&&(this._loader.log(`Loading buffer range [${s.start}-${s.end}]`),this._loader.bin.readAsync(s.start,s.end-s.start+1).then((e=>{s.loaded.resolve(e)}),(e=>{s.loaded.reject(e)})))}_getLODs(e,t,s,n){if(this.maxLODsToLoad<=0)throw new Error("maxLODsToLoad must be greater than zero");const r=new Array;for(let t=n.length-1;t>=0;t--)if(r.push(Fe.Get(`${e}/ids/${n[t]}`,s,n[t])),r.length===this.maxLODsToLoad)return r;return r.push(t),r}_disposeTransformNode(e){const t=new Array,s=e.material;s&&t.push(s);for(const s of e.getChildMeshes())s.material&&t.push(s.material);e.dispose();const n=t.filter((e=>this._loader.babylonScene.meshes.every((t=>t.material!=e))));this._disposeMaterials(n)}_disposeMaterials(e){const t={};for(const s of e){for(const e of s.getActiveTextures())t[e.uniqueId]=e;s.dispose()}for(const e in t)for(const s of this._loader.babylonScene.materials)s.hasTexture(t[e])&&delete t[e];for(const e in t)t[e].dispose()}}De.RegisterExtension(es,(e=>new ts(e)));const ss="MSFT_minecraftMesh";class ns{constructor(e){this.name=ss,this._loader=e,this.enabled=this._loader.isExtensionUsed(ss)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return De.LoadExtraAsync(e,t,this.name,((n,r)=>{if(r){if(!(s instanceof Me.Y))throw new Error(`${n}: Material type not supported`);const r=this._loader.loadMaterialPropertiesAsync(e,t,s);return s.needAlphaBlending()&&(s.forceDepthWrite=!0,s.separateCullingPass=!0),s.backFaceCulling=s.forceDepthWrite,s.twoSidedLighting=!0,r}return null}))}}De.RegisterExtension(ss,(e=>new ns(e)));const rs="MSFT_sRGBFactors";class os{constructor(e){this.name=rs,this._loader=e,this.enabled=this._loader.isExtensionUsed(rs)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return De.LoadExtraAsync(e,t,this.name,((n,r)=>{if(r){if(!(s instanceof Me.Y))throw new Error(`${n}: Material type not supported`);const r=this._loader.loadMaterialPropertiesAsync(e,t,s);return s.albedoTexture||s.albedoColor.toLinearSpaceToRef(s.albedoColor),s.reflectivityTexture||s.reflectivityColor.toLinearSpaceToRef(s.reflectivityColor),r}return null}))}}De.RegisterExtension(rs,(e=>new os(e)));const as="ExtrasAsMetadata";class is{constructor(e){this.name=as,this.enabled=!0,this._loader=e}_assignExtras(e,t){if(t.extras&&Object.keys(t.extras).length>0){const s=e.metadata=e.metadata||{};(s.gltf=s.gltf||{}).extras=t.extras}}dispose(){this._loader=null}loadNodeAsync(e,t,s){return this._loader.loadNodeAsync(e,t,(e=>{this._assignExtras(e,t),s(e)}))}loadCameraAsync(e,t,s){return this._loader.loadCameraAsync(e,t,(e=>{this._assignExtras(e,t),s(e)}))}createMaterial(e,t,s){const n=this._loader.createMaterial(e,t,s);return this._assignExtras(n,t),n}}De.RegisterExtension(as,(e=>new is(e)));class ls{constructor(){this.materials=[]}parseMTL(e,t,s,n){if(t instanceof ArrayBuffer)return;const r=t.split("\n"),o=/\s+/;let a,i=null;for(let t=0;t<r.length;t++){const l=r[t].trim();if(0===l.length||"#"===l.charAt(0))continue;const c=l.indexOf(" ");let h=c>=0?l.substring(0,c):l;h=h.toLowerCase();const d=c>=0?l.substring(c+1).trim():"";if("newmtl"===h)i&&this.materials.push(i),e._blockEntityCollection=!!n,i=new $.K(d,e),i._parentContainer=n,e._blockEntityCollection=!1;else if("kd"===h&&i)a=d.split(o,3).map(parseFloat),i.diffuseColor=C.Wo.FromArray(a);else if("ka"===h&&i)a=d.split(o,3).map(parseFloat),i.ambientColor=C.Wo.FromArray(a);else if("ks"===h&&i)a=d.split(o,3).map(parseFloat),i.specularColor=C.Wo.FromArray(a);else if("ke"===h&&i)a=d.split(o,3).map(parseFloat),i.emissiveColor=C.Wo.FromArray(a);else if("ns"===h&&i)i.specularPower=parseFloat(d);else if("d"===h&&i)i.alpha=parseFloat(d);else if("map_ka"===h&&i)i.ambientTexture=ls._GetTexture(s,d,e);else if("map_kd"===h&&i)i.diffuseTexture=ls._GetTexture(s,d,e);else if("map_ks"===h&&i)i.specularTexture=ls._GetTexture(s,d,e);else if("map_ns"===h);else if("map_bump"===h&&i){const t=d.split(o),n=t.indexOf("-bm");let r=null;n>=0&&(r=t[n+1],t.splice(n,2)),i.bumpTexture=ls._GetTexture(s,t.join(" "),e),i.bumpTexture&&null!==r&&(i.bumpTexture.level=parseFloat(r))}else"map_d"===h&&i&&(i.opacityTexture=ls._GetTexture(s,d,e))}i&&this.materials.push(i)}static _GetTexture(e,t,s){if(!t)return null;let n=e;if("file:"===e){let e=t.lastIndexOf("\\");-1===e&&(e=t.lastIndexOf("/")),n+=e>-1?t.substr(e+1):t}else n+=t;return new V.x(n,s,!1,ls.INVERT_TEXTURE_Y)}}ls.INVERT_TEXTURE_Y=!0;class cs{constructor(e,t,s){this._positions=[],this._normals=[],this._uvs=[],this._colors=[],this._meshesFromObj=[],this._indicesForBabylon=[],this._wrappedPositionForBabylon=[],this._wrappedUvsForBabylon=[],this._wrappedColorsForBabylon=[],this._wrappedNormalsForBabylon=[],this._tuplePosNorm=[],this._curPositionInIndices=0,this._hasMeshes=!1,this._unwrappedPositionsForBabylon=[],this._unwrappedColorsForBabylon=[],this._unwrappedNormalsForBabylon=[],this._unwrappedUVForBabylon=[],this._triangles=[],this._materialNameFromObj="",this._objMeshName="",this._increment=1,this._isFirstMaterial=!0,this._grayColor=new C.HE(.5,.5,.5,1),this._materialToUse=e,this._babylonMeshesArray=t,this._loadingOptions=s}_isInArray(e,t){e[t[0]]||(e[t[0]]={normals:[],idx:[]});const s=e[t[0]].normals.indexOf(t[1]);return-1===s?-1:e[t[0]].idx[s]}_isInArrayUV(e,t){e[t[0]]||(e[t[0]]={normals:[],idx:[],uv:[]});const s=e[t[0]].normals.indexOf(t[1]);return 1!=s&&t[2]===e[t[0]].uv[s]?e[t[0]].idx[s]:-1}_setData(e,t,s,n,r,o,a){let i;i=this._loadingOptions.optimizeWithUV?this._isInArrayUV(this._tuplePosNorm,[e,s,t]):this._isInArray(this._tuplePosNorm,[e,s]),-1===i?(this._indicesForBabylon.push(this._wrappedPositionForBabylon.length),this._wrappedPositionForBabylon.push(n),this._wrappedUvsForBabylon.push(r),this._wrappedNormalsForBabylon.push(o),void 0!==a&&this._wrappedColorsForBabylon.push(a),this._tuplePosNorm[e].normals.push(s),this._tuplePosNorm[e].idx.push(this._curPositionInIndices++),this._loadingOptions.optimizeWithUV&&this._tuplePosNorm[e].uv.push(t)):this._indicesForBabylon.push(i)}_unwrapData(){for(let e=0;e<this._wrappedPositionForBabylon.length;e++)this._unwrappedPositionsForBabylon.push(this._wrappedPositionForBabylon[e].x,this._wrappedPositionForBabylon[e].y,this._wrappedPositionForBabylon[e].z),this._unwrappedNormalsForBabylon.push(this._wrappedNormalsForBabylon[e].x,this._wrappedNormalsForBabylon[e].y,this._wrappedNormalsForBabylon[e].z),this._unwrappedUVForBabylon.push(this._wrappedUvsForBabylon[e].x,this._wrappedUvsForBabylon[e].y),this._loadingOptions.importVertexColors&&this._unwrappedColorsForBabylon.push(this._wrappedColorsForBabylon[e].r,this._wrappedColorsForBabylon[e].g,this._wrappedColorsForBabylon[e].b,this._wrappedColorsForBabylon[e].a);this._wrappedPositionForBabylon.length=0,this._wrappedNormalsForBabylon.length=0,this._wrappedUvsForBabylon.length=0,this._wrappedColorsForBabylon.length=0,this._tuplePosNorm.length=0,this._curPositionInIndices=0}_getTriangles(e,t){for(let s=t;s<e.length-1;s++)this._triangles.push(e[0],e[s],e[s+1])}_setDataForCurrentFaceWithPattern1(e,t){this._getTriangles(e,t);for(let e=0;e<this._triangles.length;e++){const t=parseInt(this._triangles[e])-1;this._setData(t,0,0,this._positions[t],v.FM.Zero(),v.P.Up(),this._loadingOptions.importVertexColors?this._colors[t]:void 0)}this._triangles.length=0}_setDataForCurrentFaceWithPattern2(e,t){this._getTriangles(e,t);for(let e=0;e<this._triangles.length;e++){const t=this._triangles[e].split("/"),s=parseInt(t[0])-1,n=parseInt(t[1])-1;this._setData(s,n,0,this._positions[s],this._uvs[n],v.P.Up(),this._loadingOptions.importVertexColors?this._colors[s]:void 0)}this._triangles.length=0}_setDataForCurrentFaceWithPattern3(e,t){this._getTriangles(e,t);for(let e=0;e<this._triangles.length;e++){const t=this._triangles[e].split("/"),s=parseInt(t[0])-1,n=parseInt(t[1])-1,r=parseInt(t[2])-1;this._setData(s,n,r,this._positions[s],this._uvs[n],this._normals[r])}this._triangles.length=0}_setDataForCurrentFaceWithPattern4(e,t){this._getTriangles(e,t);for(let e=0;e<this._triangles.length;e++){const t=this._triangles[e].split("//"),s=parseInt(t[0])-1,n=parseInt(t[1])-1;this._setData(s,1,n,this._positions[s],v.FM.Zero(),this._normals[n],this._loadingOptions.importVertexColors?this._colors[s]:void 0)}this._triangles.length=0}_setDataForCurrentFaceWithPattern5(e,t){this._getTriangles(e,t);for(let e=0;e<this._triangles.length;e++){const t=this._triangles[e].split("/"),s=this._positions.length+parseInt(t[0]),n=this._uvs.length+parseInt(t[1]),r=this._normals.length+parseInt(t[2]);this._setData(s,n,r,this._positions[s],this._uvs[n],this._normals[r],this._loadingOptions.importVertexColors?this._colors[s]:void 0)}this._triangles.length=0}_addPreviousObjMesh(){this._meshesFromObj.length>0&&(this._handledMesh=this._meshesFromObj[this._meshesFromObj.length-1],this._unwrapData(),this._indicesForBabylon.reverse(),this._handledMesh.indices=this._indicesForBabylon.slice(),this._handledMesh.positions=this._unwrappedPositionsForBabylon.slice(),this._handledMesh.normals=this._unwrappedNormalsForBabylon.slice(),this._handledMesh.uvs=this._unwrappedUVForBabylon.slice(),this._loadingOptions.importVertexColors&&(this._handledMesh.colors=this._unwrappedColorsForBabylon.slice()),this._indicesForBabylon.length=0,this._unwrappedPositionsForBabylon.length=0,this._unwrappedColorsForBabylon.length=0,this._unwrappedNormalsForBabylon.length=0,this._unwrappedUVForBabylon.length=0)}_optimizeNormals(e){const t=e.getVerticesData(U.o.PositionKind),s=e.getVerticesData(U.o.NormalKind),n={};if(!t||!s)return;for(let e=0;e<t.length/3;e++){const s=t[3*e+0]+"_"+t[3*e+1]+"_"+t[3*e+2];let r=n[s];r||(r=[],n[s]=r),r.push(e)}const r=new v.P;for(const e in n){const t=n[e];if(t.length<2)continue;const o=t[0];for(let e=1;e<t.length;++e){const n=t[e];s[3*o+0]+=s[3*n+0],s[3*o+1]+=s[3*n+1],s[3*o+2]+=s[3*n+2]}r.copyFromFloats(s[3*o+0],s[3*o+1],s[3*o+2]),r.normalize();for(let e=0;e<t.length;++e){const n=t[e];s[3*n+0]=r.x,s[3*n+1]=r.y,s[3*n+2]=r.z}}e.setVerticesData(U.o.NormalKind,s)}parse(e,t,s,n,r){var o;const a=t.split("\n");for(let e=0;e<a.length;e++){const t=a[e].trim().replace(/\s\s/g," ");let s;if(0!==t.length&&"#"!==t.charAt(0))if(cs.VertexPattern.test(t)){if(s=t.match(/[^ ]+/g),this._positions.push(new v.P(parseFloat(s[1]),parseFloat(s[2]),parseFloat(s[3]))),this._loadingOptions.importVertexColors)if(s.length>=7){const e=parseFloat(s[4]),t=parseFloat(s[5]),n=parseFloat(s[6]);this._colors.push(new C.HE(e>1?e/255:e,t>1?t/255:t,n>1?n/255:n,7===s.length||void 0===s[7]?1:parseFloat(s[7])))}else this._colors.push(this._grayColor)}else if(null!==(s=cs.NormalPattern.exec(t)))this._normals.push(new v.P(parseFloat(s[1]),parseFloat(s[2]),parseFloat(s[3])));else if(null!==(s=cs.UVPattern.exec(t)))this._uvs.push(new v.FM(parseFloat(s[1])*this._loadingOptions.UVScaling.x,parseFloat(s[2])*this._loadingOptions.UVScaling.y));else if(null!==(s=cs.FacePattern3.exec(t)))this._setDataForCurrentFaceWithPattern3(s[1].trim().split(" "),1);else if(null!==(s=cs.FacePattern4.exec(t)))this._setDataForCurrentFaceWithPattern4(s[1].trim().split(" "),1);else if(null!==(s=cs.FacePattern5.exec(t)))this._setDataForCurrentFaceWithPattern5(s[1].trim().split(" "),1);else if(null!==(s=cs.FacePattern2.exec(t)))this._setDataForCurrentFaceWithPattern2(s[1].trim().split(" "),1);else if(null!==(s=cs.FacePattern1.exec(t)))this._setDataForCurrentFaceWithPattern1(s[1].trim().split(" "),1);else if(cs.GroupDescriptor.test(t)||cs.ObjectDescriptor.test(t)){const e={name:t.substring(2).trim(),indices:void 0,positions:void 0,normals:void 0,uvs:void 0,colors:void 0,materialName:this._materialNameFromObj};this._addPreviousObjMesh(),this._meshesFromObj.push(e),this._hasMeshes=!0,this._isFirstMaterial=!0,this._increment=1}else if(cs.UseMtlDescriptor.test(t)){if(this._materialNameFromObj=t.substring(7).trim(),!this._isFirstMaterial||!this._hasMeshes){this._addPreviousObjMesh();const e={name:(this._objMeshName||"mesh")+"_mm"+this._increment.toString(),indices:void 0,positions:void 0,normals:void 0,uvs:void 0,colors:void 0,materialName:this._materialNameFromObj};this._increment++,this._meshesFromObj.push(e),this._hasMeshes=!0}this._hasMeshes&&this._isFirstMaterial&&(this._meshesFromObj[this._meshesFromObj.length-1].materialName=this._materialNameFromObj,this._isFirstMaterial=!1)}else cs.MtlLibGroupDescriptor.test(t)?r(t.substring(7).trim()):cs.SmoothDescriptor.test(t)||console.log("Unhandled expression at line : "+t)}if(this._hasMeshes&&(this._handledMesh=this._meshesFromObj[this._meshesFromObj.length-1],this._indicesForBabylon.reverse(),this._unwrapData(),this._handledMesh.indices=this._indicesForBabylon,this._handledMesh.positions=this._unwrappedPositionsForBabylon,this._handledMesh.normals=this._unwrappedNormalsForBabylon,this._handledMesh.uvs=this._unwrappedUVForBabylon,this._loadingOptions.importVertexColors&&(this._handledMesh.colors=this._unwrappedColorsForBabylon)),!this._hasMeshes){let e=null;if(this._indicesForBabylon.length)this._indicesForBabylon.reverse(),this._unwrapData();else{for(const e of this._positions)this._unwrappedPositionsForBabylon.push(e.x,e.y,e.z);if(this._normals.length)for(const e of this._normals)this._unwrappedNormalsForBabylon.push(e.x,e.y,e.z);if(this._uvs.length)for(const e of this._uvs)this._unwrappedUVForBabylon.push(e.x,e.y);if(this._colors.length)for(const e of this._colors)this._unwrappedColorsForBabylon.push(e.r,e.g,e.b,e.a);this._materialNameFromObj||(e=new $.K(G.Z.RandomId(),s),e.pointsCloud=!0,this._materialNameFromObj=e.name,this._normals.length||(e.disableLighting=!0,e.emissiveColor=C.Wo.White()))}this._meshesFromObj.push({name:G.Z.RandomId(),indices:this._indicesForBabylon,positions:this._unwrappedPositionsForBabylon,colors:this._unwrappedColorsForBabylon,normals:this._unwrappedNormalsForBabylon,uvs:this._unwrappedUVForBabylon,materialName:this._materialNameFromObj,directMaterial:e})}for(let t=0;t<this._meshesFromObj.length;t++){if(e&&this._meshesFromObj[t].name)if(e instanceof Array){if(-1===e.indexOf(this._meshesFromObj[t].name))continue}else if(this._meshesFromObj[t].name!==e)continue;this._handledMesh=this._meshesFromObj[t],s._blockEntityCollection=!!n;const r=new Y.Kj(this._meshesFromObj[t].name,s);if(r._parentContainer=n,s._blockEntityCollection=!1,this._materialToUse.push(this._meshesFromObj[t].materialName),0===(null===(o=this._handledMesh.positions)||void 0===o?void 0:o.length)){this._babylonMeshesArray.push(r);continue}const a=new k.x;if(a.uvs=this._handledMesh.uvs,a.indices=this._handledMesh.indices,a.positions=this._handledMesh.positions,this._loadingOptions.computeNormals){const e=new Array;k.x.ComputeNormals(this._handledMesh.positions,this._handledMesh.indices,e),a.normals=e}else a.normals=this._handledMesh.normals;this._loadingOptions.importVertexColors&&(a.colors=this._handledMesh.colors),a.applyToMesh(r),this._loadingOptions.invertY&&(r.scaling.y*=-1),this._loadingOptions.optimizeNormals&&this._optimizeNormals(r),this._babylonMeshesArray.push(r),this._handledMesh.directMaterial&&(r.material=this._handledMesh.directMaterial)}}}cs.ObjectDescriptor=/^o/,cs.GroupDescriptor=/^g/,cs.MtlLibGroupDescriptor=/^mtllib /,cs.UseMtlDescriptor=/^usemtl /,cs.SmoothDescriptor=/^s /,cs.VertexPattern=/v(\s+[\d|.|+|\-|e|E]+){3,7}/,cs.NormalPattern=/vn(\s+[\d|.|+|\-|e|E]+)( +[\d|.|+|\-|e|E]+)( +[\d|.|+|\-|e|E]+)/,cs.UVPattern=/vt(\s+[\d|.|+|\-|e|E]+)( +[\d|.|+|\-|e|E]+)/,cs.FacePattern1=/f\s+(([\d]{1,}[\s]?){3,})+/,cs.FacePattern2=/f\s+((([\d]{1,}\/[\d]{1,}[\s]?){3,})+)/,cs.FacePattern3=/f\s+((([\d]{1,}\/[\d]{1,}\/[\d]{1,}[\s]?){3,})+)/,cs.FacePattern4=/f\s+((([\d]{1,}\/\/[\d]{1,}[\s]?){3,})+)/,cs.FacePattern5=/f\s+(((-[\d]{1,}\/-[\d]{1,}\/-[\d]{1,}[\s]?){3,})+)/;class hs{constructor(e){this.name="obj",this.extensions=".obj",this._assetContainer=null,this._loadingOptions=e||hs._DefaultLoadingOptions}static get INVERT_TEXTURE_Y(){return ls.INVERT_TEXTURE_Y}static set INVERT_TEXTURE_Y(e){ls.INVERT_TEXTURE_Y=e}static get _DefaultLoadingOptions(){return{computeNormals:hs.COMPUTE_NORMALS,optimizeNormals:hs.OPTIMIZE_NORMALS,importVertexColors:hs.IMPORT_VERTEX_COLORS,invertY:hs.INVERT_Y,invertTextureY:hs.INVERT_TEXTURE_Y,UVScaling:hs.UV_SCALING,materialLoadingFailsSilently:hs.MATERIAL_LOADING_FAILS_SILENTLY,optimizeWithUV:hs.OPTIMIZE_WITH_UV,skipMaterials:hs.SKIP_MATERIALS}}_loadMTL(e,t,s,n){const o=t+e;r.w1.LoadFile(o,s,void 0,void 0,!1,((e,t)=>{n(o,t)}))}createPlugin(){return new hs(hs._DefaultLoadingOptions)}canDirectLoad(){return!1}importMeshAsync(e,t,s,n){return this._parseSolid(e,t,s,n).then((e=>({meshes:e,particleSystems:[],skeletons:[],animationGroups:[],transformNodes:[],geometries:[],lights:[]})))}loadAsync(e,t,s){return this.importMeshAsync(null,e,t,s).then((()=>{}))}loadAssetContainerAsync(e,t,s){const n=new a.TJ(e);return this._assetContainer=n,this.importMeshAsync(null,e,t,s).then((e=>(e.meshes.forEach((e=>n.meshes.push(e))),e.meshes.forEach((e=>{const t=e.material;t&&-1==n.materials.indexOf(t)&&(n.materials.push(t),t.getActiveTextures().forEach((e=>{-1==n.textures.indexOf(e)&&n.textures.push(e)})))})),this._assetContainer=null,n))).catch((e=>{throw this._assetContainer=null,e}))}_parseSolid(e,t,s,n){let o="";const a=new ls,i=new Array,l=[];new cs(i,l,this._loadingOptions).parse(e,s,t,this._assetContainer,(e=>{o=e}));const c=[];return""===o||this._loadingOptions.skipMaterials||c.push(new Promise(((e,s)=>{this._loadMTL(o,n,(c=>{try{a.parseMTL(t,c,n,this._assetContainer);for(let e=0;e<a.materials.length;e++){let t=0;const s=[];let n;for(;(n=i.indexOf(a.materials[e].name,t))>-1;)s.push(n),t=n+1;if(-1===n&&0===s.length)a.materials[e].dispose();else for(let t=0;t<s.length;t++){const n=l[s[t]],r=a.materials[e];n.material=r,n.getTotalIndices()||(r.pointsCloud=!0)}}e()}catch(t){r.w1.Warn(`Error processing MTL file: '${o}'`),this._loadingOptions.materialLoadingFailsSilently?e():s(t)}}),((t,n)=>{r.w1.Warn(`Error downloading MTL file: '${o}'`),this._loadingOptions.materialLoadingFailsSilently?e():s(n)}))}))),Promise.all(c).then((()=>l))}}hs.OPTIMIZE_WITH_UV=!0,hs.INVERT_Y=!1,hs.IMPORT_VERTEX_COLORS=!1,hs.COMPUTE_NORMALS=!1,hs.OPTIMIZE_NORMALS=!1,hs.UV_SCALING=new v.FM(1,1),hs.SKIP_MATERIALS=!1,hs.MATERIAL_LOADING_FAILS_SILENTLY=!0,o.n&&o.n.RegisterPlugin(new hs);class ds{constructor(){this.solidPattern=/solid (\S*)([\S\s]*?)endsolid[ ]*(\S*)/g,this.facetsPattern=/facet([\s\S]*?)endfacet/g,this.normalPattern=/normal[\s]+([-+]?[0-9]+\.?[0-9]*([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+/g,this.vertexPattern=/vertex[\s]+([-+]?[0-9]+\.?[0-9]*([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+/g,this.name="stl",this.extensions={".stl":{isBinary:!0}}}importMesh(e,t,s,n,o){let a;if("string"!=typeof s){if(this._isBinary(s)){const e=new Y.Kj("stlmesh",t);return this._parseBinary(e,s,t.useRightHandedSystem),o&&o.push(e),!0}const e=new Uint8Array(s);let n="";for(let t=0;t<s.byteLength;t++)n+=String.fromCharCode(e[t]);s=n}for(;a=this.solidPattern.exec(s);){let s=a[1];if(s!=a[3])return r.w1.Error("Error in STL, solid name != endsolid name"),!1;if(e&&s)if(e instanceof Array){if(!e.indexOf(s))continue}else if(s!==e)continue;s=s||"stlmesh";const n=new Y.Kj(s,t);this._parseASCII(n,a[2],t.useRightHandedSystem),o&&o.push(n)}return!0}load(e,t,s){return this.importMesh(null,e,t,s,null)}loadAssetContainer(e,t,s){const n=new a.TJ(e);return e._blockEntityCollection=!0,this.importMesh(null,e,t,s,n.meshes),e._blockEntityCollection=!1,n}_isBinary(e){const t=new DataView(e);if(t.byteLength<=80)return!1;if(84+50*t.getUint32(80,!0)===t.byteLength)return!0;const s=t.byteLength;for(let e=0;e<s;e++)if(t.getUint8(e)>127)return!0;return!1}_parseBinary(e,t,s){const n=new DataView(t),r=n.getUint32(80,!0);let o=0;const a=new Float32Array(3*r*3),i=new Float32Array(3*r*3),l=new Uint32Array(3*r);let c=0;for(let e=0;e<r;e++){const t=84+50*e,r=n.getFloat32(t,!0),h=n.getFloat32(t+4,!0),d=n.getFloat32(t+8,!0);for(let e=1;e<=3;e++){const s=t+12*e;a[o]=n.getFloat32(s,!0),i[o]=r,ds.DO_NOT_ALTER_FILE_COORDINATES?(a[o+1]=n.getFloat32(s+4,!0),a[o+2]=n.getFloat32(s+8,!0),i[o+1]=h,i[o+2]=d):(a[o+2]=n.getFloat32(s+4,!0),a[o+1]=n.getFloat32(s+8,!0),i[o+2]=h,i[o+1]=d),o+=3}s?(l[c]=c,l[c+1]=c+2,l[c+2]=c+1,c+=3):(l[c]=c++,l[c]=c++,l[c]=c++)}e.setVerticesData(U.o.PositionKind,a),e.setVerticesData(U.o.NormalKind,i),e.setIndices(l),e.computeWorldMatrix(!0)}_parseASCII(e,t,s){const n=[],r=[],o=[];let a,i=0;for(;a=this.facetsPattern.exec(t);){const e=a[1],t=this.normalPattern.exec(e);if(this.normalPattern.lastIndex=0,!t)continue;const l=[Number(t[1]),Number(t[5]),Number(t[3])];let c;for(;c=this.vertexPattern.exec(e);)ds.DO_NOT_ALTER_FILE_COORDINATES?(n.push(Number(c[1]),Number(c[3]),Number(c[5])),r.push(l[0],l[2],l[1])):(n.push(Number(c[1]),Number(c[5]),Number(c[3])),r.push(l[0],l[1],l[2]));s?(o.push(i,i+2,i+1),i+=3):o.push(i++,i++,i++),this.vertexPattern.lastIndex=0}this.facetsPattern.lastIndex=0,e.setVerticesData(U.o.PositionKind,n),e.setVerticesData(U.o.NormalKind,r),e.setIndices(o),e.computeWorldMatrix(!0)}}ds.DO_NOT_ALTER_FILE_COORDINATES=!1,o.n&&o.n.RegisterPlugin(new ds)}}]);
//# sourceMappingURL=745.92929ddae63bbb484297.js.map
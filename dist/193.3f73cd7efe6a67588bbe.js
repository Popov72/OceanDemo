"use strict";(self.webpackChunkbabylonjs_ocean_demo=self.webpackChunkbabylonjs_ocean_demo||[]).push([[193],{7193:(e,t,r)=>{r.r(t),r.d(t,{WavesCascade:()=>a});var i=r(4432),n=r(6093),s=r(7014);class a{constructor(e,t,r,a,u,x){this._engine=x,this._size=e,this._fft=r,this._lambda=0,this._pingPongTurbulence=!1,this._initialSpectrum=new n.InitialSpectrum(x,a,u,e,t),this._timeDependentSpectrum=new i.ComputeShader("timeDependentSpectrumCS",this._engine,{computeSource:"@group(0) @binding(1) var H0 : texture_2d<f32>;\r\n@group(0) @binding(3) var WavesData : texture_2d<f32>;\r\n\r\nstruct Params {\r\n    Time : f32;\r\n};\r\n\r\n@group(0) @binding(4) var<uniform> params : Params;\r\n\r\n@group(0) @binding(5) var DxDz : texture_storage_2d<rg32float, write>;\r\n@group(0) @binding(6) var DyDxz : texture_storage_2d<rg32float, write>;\r\n@group(0) @binding(7) var DyxDyz : texture_storage_2d<rg32float, write>;\r\n@group(0) @binding(8) var DxxDzz : texture_storage_2d<rg32float, write>;\r\n\r\nfn complexMult(a: vec2<f32>, b: vec2<f32>) -> vec2<f32>\r\n{\r\n\treturn vec2<f32>(a.r * b.r - a.g * b.g, a.r * b.g + a.g * b.r);\r\n}\r\n\r\n@stage(compute) @workgroup_size(8,8,1)\r\nfn calculateAmplitudes(@builtin(global_invocation_id) id : vec3<u32>)\r\n{\r\n    let iid = vec3<i32>(id);\r\n\tlet wave = textureLoad(WavesData, iid.xy, 0);\r\n\tlet phase = wave.w * params.Time;\r\n\tlet exponent = vec2<f32>(cos(phase), sin(phase));\r\n    let h0 = textureLoad(H0, iid.xy, 0);\r\n\tlet h = complexMult(h0.xy, exponent) + complexMult(h0.zw, vec2<f32>(exponent.x, -exponent.y));\r\n\tlet ih = vec2<f32>(-h.y, h.x);\r\n\r\n\tlet displacementX = ih * wave.x * wave.y;\r\n\tlet displacementY = h;\r\n\tlet displacementZ = ih * wave.z * wave.y;\r\n\r\n\tlet displacementX_dx = -h * wave.x * wave.x * wave.y;\r\n\tlet displacementY_dx = ih * wave.x;\r\n\tlet displacementZ_dx = -h * wave.x * wave.z * wave.y;\r\n\t\t \r\n\tlet displacementY_dz = ih * wave.z;\r\n\tlet displacementZ_dz = -h * wave.z * wave.z * wave.y;\r\n\r\n\ttextureStore(DxDz,   iid.xy, vec4<f32>(displacementX.x - displacementZ.y, displacementX.y + displacementZ.x, 0., 0.));\r\n\ttextureStore(DyDxz,  iid.xy, vec4<f32>(displacementY.x - displacementZ_dx.y, displacementY.y + displacementZ_dx.x, 0., 0.));\r\n\ttextureStore(DyxDyz, iid.xy, vec4<f32>(displacementY_dx.x - displacementY_dz.y, displacementY_dx.y + displacementY_dz.x, 0., 0.));\r\n\ttextureStore(DxxDzz, iid.xy, vec4<f32>(displacementX_dx.x - displacementZ_dz.y, displacementX_dx.y + displacementZ_dz.x, 0., 0.));\r\n}\r\n"},{bindingsMapping:{H0:{group:0,binding:1},WavesData:{group:0,binding:3},params:{group:0,binding:4},DxDz:{group:0,binding:5},DyDxz:{group:0,binding:6},DyxDyz:{group:0,binding:7},DxxDzz:{group:0,binding:8}},entryPoint:"calculateAmplitudes"}),this._buffer=s.ComputeHelper.CreateStorageTexture("buffer",this._engine,this._size,this._size,i.Constants.TEXTUREFORMAT_RG),this._DxDz=s.ComputeHelper.CreateStorageTexture("DxDz",this._engine,this._size,this._size,i.Constants.TEXTUREFORMAT_RG),this._DyDxz=s.ComputeHelper.CreateStorageTexture("DyDxz",this._engine,this._size,this._size,i.Constants.TEXTUREFORMAT_RG),this._DyxDyz=s.ComputeHelper.CreateStorageTexture("DyxDyz",this._engine,this._size,this._size,i.Constants.TEXTUREFORMAT_RG),this._DxxDzz=s.ComputeHelper.CreateStorageTexture("DxxDzz",this._engine,this._size,this._size,i.Constants.TEXTUREFORMAT_RG),this._timeDependentSpectrumParams=new i.UniformBuffer(this._engine),this._timeDependentSpectrumParams.addUniform("Time",1),this._timeDependentSpectrum.setTexture("H0",this._initialSpectrum.initialSpectrum,!1),this._timeDependentSpectrum.setTexture("WavesData",this._initialSpectrum.wavesData,!1),this._timeDependentSpectrum.setUniformBuffer("params",this._timeDependentSpectrumParams),this._timeDependentSpectrum.setStorageTexture("DxDz",this._DxDz),this._timeDependentSpectrum.setStorageTexture("DyDxz",this._DyDxz),this._timeDependentSpectrum.setStorageTexture("DyxDyz",this._DyxDyz),this._timeDependentSpectrum.setStorageTexture("DxxDzz",this._DxxDzz),a.setTexture(u+3,"DxDz",this._DxDz,2),a.setTexture(u+4,"DyDxz",this._DyDxz,2),a.setTexture(u+5,"DyxDyz",this._DyxDyz,2),a.setTexture(u+6,"DxxDzz",this._DxxDzz,2),this._texturesMerger=new i.ComputeShader("texturesMerger",this._engine,{computeSource:"struct Params {\r\n    Lambda : f32;\r\n    DeltaTime : f32;\r\n};\r\n\r\n@group(0) @binding(0) var<uniform> params : Params;\r\n\r\n@group(0) @binding(1) var Displacement : texture_storage_2d<rgba16float, write>;\r\n@group(0) @binding(2) var Derivatives : texture_storage_2d<rgba16float, write>;\r\n@group(0) @binding(3) var TurbulenceRead : texture_2d<f32>;\r\n@group(0) @binding(4) var TurbulenceWrite : texture_storage_2d<rgba16float, write>;\r\n\r\n@group(0) @binding(5) var Dx_Dz : texture_2d<f32>;\r\n@group(0) @binding(6) var Dy_Dxz : texture_2d<f32>;\r\n@group(0) @binding(7) var Dyx_Dyz : texture_2d<f32>;\r\n@group(0) @binding(8) var Dxx_Dzz : texture_2d<f32>;\r\n\r\n@stage(compute) @workgroup_size(8,8,1)\r\nfn fillResultTextures(@builtin(global_invocation_id) id : vec3<u32>)\r\n{\r\n    let iid = vec3<i32>(id);\r\n\r\n\tlet DxDz = textureLoad(Dx_Dz, iid.xy, 0);\r\n\tlet DyDxz = textureLoad(Dy_Dxz, iid.xy, 0);\r\n\tlet DyxDyz = textureLoad(Dyx_Dyz, iid.xy, 0);\r\n\tlet DxxDzz = textureLoad(Dxx_Dzz, iid.xy, 0);\r\n\t\r\n\ttextureStore(Displacement, iid.xy, vec4<f32>(params.Lambda * DxDz.x, DyDxz.x, params.Lambda * DxDz.y, 0.));\r\n\ttextureStore(Derivatives, iid.xy, vec4<f32>(DyxDyz.x, DyxDyz.y, DxxDzz.x * params.Lambda, DxxDzz.y * params.Lambda));\r\n\r\n\tlet jacobian = (1.0 + params.Lambda * DxxDzz.x) * (1.0 + params.Lambda * DxxDzz.y) - params.Lambda * params.Lambda * DyDxz.y * DyDxz.y;\r\n\r\n    var turbulence = textureLoad(TurbulenceRead, iid.xy, 0).r + params.DeltaTime * 0.5 / max(jacobian, 0.5);\r\n    turbulence = min(jacobian, turbulence);\r\n\r\n    textureStore(TurbulenceWrite, iid.xy, vec4<f32>(turbulence, turbulence, turbulence, 1.));\r\n}\r\n"},{bindingsMapping:{params:{group:0,binding:0},Displacement:{group:0,binding:1},Derivatives:{group:0,binding:2},TurbulenceRead:{group:0,binding:3},TurbulenceWrite:{group:0,binding:4},DxDz:{group:0,binding:5},DyDxz:{group:0,binding:6},DyxDyz:{group:0,binding:7},DxxDzz:{group:0,binding:8}},entryPoint:"fillResultTextures"}),this._displacement=s.ComputeHelper.CreateStorageTexture("displacement",this._engine,this._size,this._size,i.Constants.TEXTUREFORMAT_RGBA,i.Constants.TEXTURETYPE_HALF_FLOAT,i.Constants.TEXTURE_BILINEAR_SAMPLINGMODE),this._derivatives=s.ComputeHelper.CreateStorageTexture("derivatives",this._engine,this._size,this._size,i.Constants.TEXTUREFORMAT_RGBA,i.Constants.TEXTURETYPE_HALF_FLOAT,i.Constants.TEXTURE_TRILINEAR_SAMPLINGMODE,!0),this._turbulence=s.ComputeHelper.CreateStorageTexture("turbulence",this._engine,this._size,this._size,i.Constants.TEXTUREFORMAT_RGBA,i.Constants.TEXTURETYPE_HALF_FLOAT,i.Constants.TEXTURE_TRILINEAR_SAMPLINGMODE,!0),this._turbulence2=s.ComputeHelper.CreateStorageTexture("turbulence",this._engine,this._size,this._size,i.Constants.TEXTUREFORMAT_RGBA,i.Constants.TEXTURETYPE_HALF_FLOAT,i.Constants.TEXTURE_TRILINEAR_SAMPLINGMODE,!0),this._texturesMergerParams=new i.UniformBuffer(this._engine),this._texturesMergerParams.addUniform("Lambda",1),this._texturesMergerParams.addUniform("DeltaTime",1),this._texturesMerger.setUniformBuffer("params",this._texturesMergerParams),this._texturesMerger.setStorageTexture("Displacement",this._displacement),this._texturesMerger.setStorageTexture("Derivatives",this._derivatives),this._texturesMerger.setTexture("DxDz",this._DxDz,!1),this._texturesMerger.setTexture("DyDxz",this._DyDxz,!1),this._texturesMerger.setTexture("DyxDyz",this._DyxDyz,!1),this._texturesMerger.setTexture("DxxDzz",this._DxxDzz,!1),a.setTexture(u+7,"displacement",this._displacement,2),a.setTexture(u+8,"derivatives",this._derivatives,2),a.setTexture(u+9,"turbulence",this._turbulence,1)}get displacement(){return this._displacement}get derivatives(){return this._derivatives}get turbulence(){return this._pingPongTurbulence?this._turbulence2:this._turbulence}calculateInitials(e,t,r,i){this._lambda=e.lambda,this._initialSpectrum.generate(e,t,r,i)}calculateWavesAtTime(e){this._timeDependentSpectrumParams.updateFloat("Time",e),this._timeDependentSpectrumParams.update(),s.ComputeHelper.Dispatch(this._timeDependentSpectrum,this._size,this._size,1),this._fft.IFFT2D(this._DxDz,this._buffer),this._fft.IFFT2D(this._DyDxz,this._buffer),this._fft.IFFT2D(this._DyxDyz,this._buffer),this._fft.IFFT2D(this._DxxDzz,this._buffer);let t=this._engine.getDeltaTime()/1e3;t>.5&&(t=.5),this._texturesMergerParams.updateFloat("Lambda",this._lambda),this._texturesMergerParams.updateFloat("DeltaTime",t),this._texturesMergerParams.update(),this._pingPongTurbulence=!this._pingPongTurbulence,this._texturesMerger.setTexture("TurbulenceRead",this._pingPongTurbulence?this._turbulence:this._turbulence2,!1),this._texturesMerger.setStorageTexture("TurbulenceWrite",this._pingPongTurbulence?this._turbulence2:this._turbulence),s.ComputeHelper.Dispatch(this._texturesMerger,this._size,this._size,1),this._engine.generateMipmaps(this._derivatives.getInternalTexture()),this._engine.generateMipmaps(this._pingPongTurbulence?this._turbulence2.getInternalTexture():this._turbulence.getInternalTexture())}dispose(){this._initialSpectrum.dispose(),this._timeDependentSpectrumParams.dispose(),this._buffer.dispose(),this._DxDz.dispose(),this._DyDxz.dispose(),this._DyxDyz.dispose(),this._DxxDzz.dispose(),this._texturesMergerParams.dispose()}}}}]);
//# sourceMappingURL=193.3f73cd7efe6a67588bbe.js.map